<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>家庭記帳</title>
    
    <!-- PWA 全螢幕設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111827">

    <!-- 動態生成 Manifest -->
    <script>
        const manifestJSON = {
            "name": "家庭記帳",
            "short_name": "記帳",
            "display": "standalone",
            "start_url": ".",
            "background_color": "#111827",
            "theme_color": "#111827",
            "icons": [{
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z'/%3E%3C/svg%3E",
                "sizes": "512x512",
                "type": "image/svg+xml"
            }]
        };
        const blob = new Blob([JSON.stringify(manifestJSON)], { type: 'application/manifest+json' });
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(blob);
        document.head.appendChild(manifestLink);
    </script>

    <!-- 載入環境 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            background-color: #111827;
            margin: 0;
            overflow-x: hidden;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-cursor { animation: cursor-blink 1s step-end infinite; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 text-left">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const gasUrl = 'https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec';
        const APP_VERSION = "2026.02.24.102";

        const CHANGELOG = [
            { version: "2026.02.24.102", date: "2026/02/24", note: "修復設定頁面空白問題。優化程式碼結構，清理重複的 CSS 標籤。" },
            { version: "2026.02.24.101", date: "2026/02/24", note: "修復記錄者顯示。優化副標題邏輯：自己記帳隱藏資訊，他人代記才顯示。強制 24H 格式。" },
            { version: "2026.02.24.99", date: "2026/02/24", note: "介面精簡：移除類別旁的「自己」標籤。修正成員紀錄隔離。" }
        ];

        // --- 內建圖示元件 ---
        const SvgIcon = ({ name, size = 24, className = "" }) => {
            const icons = {
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/>,
                plus: <path d="M12 5v14m-7-7h14"/>,
                history: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4"/>,
                chart: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10Z"/>,
                settings: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                    </React.Fragment>
                ),
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5l-5-5m5 5H9"/>,
                refresh: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-4v4h4m-1 8a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m0 4v-4h-4"/>,
                bio: <React.Fragment><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
                key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.778-7.778zm0 0L15.5 7.5m0 0l3 3m-3-3l2.5-2.5"/>,
                user: <React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>,
                close: <path d="M18 6L6 18M6 6l12 12"/>,
                info: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></React.Fragment>,
                check: <path d="M20 6L9 17l-5-5"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={`shrink-0 aspect-square ${className}`}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        const AddTransactionForm = ({ categories, loginUser, onSubmit, isLoading }) => {
            const inputRef = useRef(null);
            const [isFocused, setIsFocused] = useState(false);
            const [formData, setFormData] = useState({ 
                amount: '', 
                category: categories[0] || '一般', 
                member: loginUser, 
                type: 'expense', 
                desc: '' 
            });

            const otherMember = loginUser === '爸爸' ? '媽媽' : '爸爸';

            const renderAmount = () => {
                const val = formData.amount;
                if (isFocused) {
                    if (val === '' || val === '0') return <span className="text-gray-300 animate-cursor">_</span>;
                    return val;
                } else {
                    if (val === '' || val === '0') return "0";
                    return val;
                }
            };

            return (
                <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border border-gray-100 animate-in text-center relative font-black">
                    <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-8 text-sm text-gray-500 font-black">
                        <button onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm font-black' : ''}`}>支出</button>
                        <button onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'income' ? 'bg-white text-green-500 shadow-sm font-black' : ''}`}>收入</button>
                    </div>

                    <div className="relative flex items-center justify-center mb-8 py-2 min-h-[80px] cursor-pointer" onClick={() => inputRef.current?.focus()}>
                        <span className="text-2xl font-black text-gray-300 mr-1 mt-2">$</span>
                        <div className={`text-6xl font-black text-center min-w-[1.5rem] tracking-tighter transition-colors ${formData.type === 'expense' ? 'text-red-500' : 'text-green-500'}`}>
                            {renderAmount()}
                        </div>
                        <input ref={inputRef} type="number" inputMode="decimal" className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-black" value={formData.amount} onFocus={() => setIsFocused(true)} onBlur={() => setIsFocused(false)} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
                    </div>

                    <div className="space-y-4 text-left font-black">
                        <div className="bg-gray-100 p-4 rounded-2xl text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">消費類別</label>
                            <select className="w-full bg-transparent border-none outline-none appearance-none font-black" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}>
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="bg-gray-100 p-4 rounded-2xl text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">備註說明</label>
                            <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300" placeholder="點擊輸入..." value={formData.desc} onChange={(e) => setFormData({...formData, desc: e.target.value})} />
                        </div>
                        <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100 text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-2 flex items-center gap-1 text-gray-500 font-black">紀錄對象</label>
                            <div className="flex gap-2">
                                <button type="button" onClick={() => setFormData({...formData, member: loginUser})} className={`flex-1 py-3 rounded-xl text-[11px] transition-all border-2 font-black ${formData.member === loginUser ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-gray-200 text-gray-400'}`}>
                                    自己 {formData.member === loginUser && '✓'}
                                </button>
                                <button type="button" onClick={() => setFormData({...formData, member: otherMember})} className={`flex-1 py-3 rounded-xl text-[11px] transition-all border-2 font-black ${formData.member === otherMember ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-gray-200 text-gray-400'}`}>
                                    給{otherMember}紀錄 {formData.member === otherMember && '✓'}
                                </button>
                            </div>
                        </div>
                    </div>
                    <button disabled={!formData.amount || formData.amount === '0' || isLoading} onClick={() => onSubmit(formData)} className="w-full mt-8 py-5 bg-gray-900 text-white rounded-3xl font-black text-lg active:scale-95 transition shadow-xl disabled:opacity-30">
                        {isLoading ? "同步中..." : "確認存檔"}
                    </button>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [currentUser, setCurrentUser] = useState(null); 
            const [gasVersion, setGasVersion] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
            const [biometricAvailable, setBiometricAvailable] = useState(false);
            
            const [familyConfig, setFamilyConfig] = useState(() => {
                const saved = localStorage.getItem('family_member_config_v15');
                return saved ? JSON.parse(saved) : [
                    { name: '爸爸', pin: '790115', color: 'bg-blue-600', bioEnabled: false },
                    { name: '媽媽', pin: '791005', color: 'bg-pink-600', bioEnabled: false }
                ];
            });

            const myTransactions = useMemo(() => {
                if (!currentUser) return [];
                return transactions.filter(t => t.member === currentUser.name);
            }, [transactions, currentUser]);

            const stats = useMemo(() => {
                const income = myTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const expense = myTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                return { income, expense, balance: income - expense };
            }, [myTransactions]);

            const [pinInput, setPinInput] = useState("");
            const [selectingUser, setSelectingUser] = useState(null);
            const [isChangingPin, setIsChangingPin] = useState(false);
            const [pinChangeStep, setPinChangeStep] = useState(1);
            const [tempPin, setTempPin] = useState("");
            const [showChangelog, setShowChangelog] = useState(false);

            useEffect(() => {
                localStorage.setItem('family_member_config_v15', JSON.stringify(familyConfig));
                if (window.PublicKeyCredential) {
                    PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(v => setBiometricAvailable(v));
                }
                if (currentUser) syncCloud();
            }, [currentUser, familyConfig]);

            const showStatus = (type, text) => {
                setStatusMsg({ type, text });
                setTimeout(() => setStatusMsg({ type: '', text: '' }), 3500);
            };

            const syncCloud = async () => {
                if (!navigator.onLine || isLoading) return;
                setIsLoading(true);
                try {
                    const res = await fetch(gasUrl);
                    const data = await res.json();
                    if (data.gasVersion) setGasVersion(data.gasVersion);
                    const formatted = (data.transactions || []).map((t, i) => ({
                        id: t.id || i,
                        amount: parseFloat(t['金額']) || 0,
                        category: t['類別'] || '一般',
                        date: t['日期時間'] || t['日期'] || '',
                        member: t['成員'] || '未知',
                        recorder: t['記錄者'] || '系統', 
                        desc: t['備註'] || '',
                        type: t['類型'] || 'expense'
                    }));
                    setTransactions(formatted);
                } catch (err) { showStatus('error', '雲端同步超時'); }
                finally { setIsLoading(false); }
            };

            const handleAdd = async (newTx) => {
                setIsLoading(true);
                const now = new Date();
                const nowStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                const completeTx = { ...newTx, date: nowStr, recorder: currentUser.name };
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify(completeTx), mode: 'no-cors' });
                    setTransactions(prev => [...prev, { ...completeTx, id: Date.now() }]);
                    showStatus('success', '紀錄儲存成功');
                    setTimeout(syncCloud, 1200);
                } catch (err) { showStatus('error', '同步失敗'); }
                finally { setIsLoading(false); setActiveTab('dashboard'); }
            };

            const handleUpdatePin = async (name, newPin) => {
                setIsLoading(true);
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'UPDATE_PIN', name, newPin }), mode: 'no-cors' });
                    setFamilyConfig(prev => prev.map(u => u.name === name ? { ...u, pin: newPin, bioEnabled: false } : u));
                    showStatus('success', '密碼已更新');
                    setCurrentUser(null);
                    setIsChangingPin(false);
                } catch (err) { showStatus('error', '更新失敗'); }
                finally { setIsLoading(false); }
            };

            const updateBioState = async (name, enabled) => {
                setIsLoading(true);
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'UPDATE_BIO', name, enabled }), mode: 'no-cors' });
                    setFamilyConfig(prev => prev.map(u => u.name === name ? { ...u, bioEnabled: enabled } : u));
                    showStatus('success', enabled ? '生物辨識開啟' : '生物辨識關閉');
                } catch (err) { showStatus('error', '同步失敗'); }
                finally { setIsLoading(false); }
            };

            const displayDateClean = (val) => {
                if (!val) return '';
                let str = String(val).replace(/上午|下午|AM|PM/gi, '').trim();
                if (str.includes(':')) {
                    const parts = str.split(' ');
                    if (parts.length > 1) {
                        return `${parts[0].replace(/-/g, '/')} ${parts[1].split(':').slice(0, 2).join(':')}`;
                    }
                }
                return str.replace(/-/g, '/');
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-8 animate-in relative w-full text-center font-black">
                        <div className="mb-12 text-white">
                            <div className="bg-blue-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-blue-500/30 text-white font-black"><SvgIcon name="wallet" size={36} /></div>
                            <h1 className="text-4xl font-black italic tracking-tighter">家庭記帳</h1>
                            <p className="text-gray-500 text-[10px] font-mono mt-4 opacity-50 uppercase tracking-[0.3em]">v{APP_VERSION}</p>
                        </div>
                        {!selectingUser ? (
                            <div className="grid grid-cols-1 gap-6 w-full max-w-xs text-white">
                                {familyConfig.map(user => (
                                    <button key={user.name} onClick={() => setSelectingUser(user)} className={`${user.color} py-6 rounded-[2.5rem] font-black text-2xl shadow-lg border-4 border-white/5 active:scale-95 transition-all`}>{user.name}</button>
                                ))}
                            </div>
                        ) : (
                            <div className="w-full max-w-xs animate-in text-white text-center">
                                <p className="font-black text-3xl mb-2 tracking-tight text-white">{selectingUser.name}</p>
                                <p className="text-gray-500 text-xs font-bold uppercase tracking-widest opacity-60 mb-8">驗證 6 位密碼</p>
                                <div className="flex justify-center gap-4 mb-10">
                                    {[...Array(6)].map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full border-2 border-blue-500 transition-all duration-200 ${pinInput.length > i ? 'bg-blue-500 scale-125 shadow-[0_0_12px_#3b82f6]' : 'bg-transparent'}`}></div>))}
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-8 text-white">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (
                                        <button key={k} onClick={() => {
                                            if (k === 'C') setPinInput(""); else if (k === '←') setPinInput(pinInput.slice(0, -1)); else {
                                                const n = pinInput + k; if (n.length <= 6) { setPinInput(n); if (n.length === 6) {
                                                    if (n === selectingUser.pin) { setCurrentUser(selectingUser); setSelectingUser(null); setPinInput(""); showStatus('success', '歡迎回來'); }
                                                    else { setPinInput(""); showStatus('error', '密碼不正確'); }
                                                } }
                                            }
                                        }} className="bg-white/10 h-16 rounded-3xl font-black text-2xl active:bg-blue-600 transition-all border border-white/5 text-white">{k}</button>
                                    ))}
                                </div>
                                {biometricAvailable && (
                                    <div className="mb-8 p-5 bg-white/5 rounded-3xl border border-blue-500/20 text-left">
                                        {selectingUser.bioEnabled ? (
                                            <button onClick={() => { showStatus('success', '驗證成功'); setTimeout(() => { setCurrentUser(selectingUser); setSelectingUser(null); }, 600); }} className="w-full py-4 bg-blue-600 text-white rounded-2xl flex items-center justify-center gap-3 font-black text-lg active:scale-95 transition shadow-xl"><SvgIcon name="bio" size={24} /> 生物辨識解鎖</button>
                                        ) : (
                                            <div>
                                                <div className="flex items-center gap-2 mb-1 text-blue-400 font-black uppercase tracking-widest text-[11px]"><SvgIcon name="info" size={14} /><span>解鎖提示</span></div>
                                                <p className="text-[11px] text-gray-400 font-bold leading-relaxed font-black">尚未開啟生物辨識功能。<br/>請登入後前往「設定」頁面開啟。</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <button onClick={() => {setSelectingUser(null); setPinInput("");}} className="text-gray-500 text-xs font-black uppercase tracking-widest underline underline-offset-4 active:text-blue-500 font-black">返回成員列表</button>
                            </div>
                        )}
                        {statusMsg.text && <div className="fixed bottom-12 left-0 right-0 flex justify-center z-[200] pointer-events-none px-4 text-center font-black"><div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}><span className="text-sm font-bold tracking-tight text-center">{statusMsg.text}</span></div></div>}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 pb-28 max-w-md mx-auto relative flex flex-col overflow-x-hidden w-full text-left font-black">
                    {/* Modals */}
                    {showChangelog && (
                        <div className="fixed inset-0 z-[300] bg-gray-900/90 backdrop-blur-md flex items-center justify-center p-8 animate-in text-gray-800 text-left">
                            <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 relative">
                                <button onClick={() => setShowChangelog(false)} className="absolute top-6 right-6 text-gray-400 active:scale-90"><SvgIcon name="close" size={24} /></button>
                                <h3 className="font-black text-xl mb-6 flex items-center gap-2 italic text-left text-gray-800"><SvgIcon name="info" size={20} className="text-blue-600" /> 更新紀錄</h3>
                                <div className="space-y-6 max-h-[60vh] overflow-y-auto scrollbar-hide text-[11px]">
                                    {CHANGELOG.map(log => (<div key={log.version} className="border-l-2 border-blue-100 pl-4 py-1 text-gray-800 font-bold">
                                        <div className="flex justify-between items-center mb-1 font-black"><span>v{log.version}</span><span className="font-bold text-gray-400 text-[10px]">{log.date}</span></div>
                                        <p className="text-gray-500 leading-relaxed font-black">{log.note}</p>
                                    </div>))}
                                </div>
                            </div>
                        </div>
                    )}

                    {isChangingPin && (
                        <div className="fixed inset-0 z-[300] bg-gray-900/95 backdrop-blur-xl flex flex-col items-center justify-center p-8 animate-in text-white text-center font-black">
                            <button onClick={() => {setIsChangingPin(false); setTempPin(""); setPinChangeStep(1);}} className="absolute top-10 right-10 text-gray-400 active:scale-90"><SvgIcon name="close" size={32}/></button>
                            <div className="mb-12 font-black"><div className="bg-blue-600/20 p-4 rounded-3xl mb-4 inline-block text-blue-500"><SvgIcon name="key" size={32}/></div><h2 className="text-2xl font-black text-white">身分驗證</h2></div>
                            <div className="flex justify-center gap-4 mb-12 text-white">{[...Array(6)].map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full border-2 border-blue-500 ${tempPin.length > i ? 'bg-blue-500 scale-125 shadow-[0_0_12px_#3b82f6]' : 'bg-transparent'}`}></div>))}</div>
                            <div className="grid grid-cols-3 gap-4 w-full max-w-xs text-white">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (<button key={k} onClick={() => {
                                    if (k === 'C') setTempPin(""); else if (k === '←') setTempPin(tempPin.slice(0, -1)); else {
                                        const next = tempPin + k; if (next.length <= 6) { setTempPin(next); if (next.length === 6) {
                                            if (pinChangeStep === 1) { if (next === currentUser.pin) { setPinChangeStep(2); setTempPin(""); showStatus('info', '輸入新密碼'); } else { setTempPin(""); showStatus('error', '密碼不符'); } } else { handleUpdatePin(currentUser.name, next); }
                                        } }
                                    }
                                }} className="bg-white/10 h-16 rounded-3xl font-black text-2xl active:bg-blue-600 transition-all border border-white/5 text-white">{k}</button>))}
                            </div>
                        </div>
                    )}

                    <header className="px-6 pt-12 pb-6 bg-white sticky top-0 z-40 flex justify-between items-center border-b border-gray-100 shrink-0 text-gray-800 font-black">
                        <div className="flex items-center gap-3 text-left font-black"><div className={`${currentUser.color} w-10 h-10 rounded-2xl flex items-center justify-center text-white font-black shadow-lg shadow-blue-500/30`}>{currentUser.name.charAt(0)}</div><h1 className="text-2xl font-black tracking-tighter italic">家庭記帳</h1></div>
                        <div className="flex gap-2">
                            <button onClick={syncCloud} className={`p-2.5 bg-gray-50 rounded-xl transition-all flex items-center justify-center active:scale-90 text-gray-600 font-black ${isLoading ? 'animate-spin text-blue-500' : ''}`}><SvgIcon name="refresh" size={20}/></button>
                            <button onClick={() => setCurrentUser(null)} className="p-2.5 bg-red-50 text-red-500 rounded-xl active:scale-90 transition-all flex items-center justify-center font-black"><SvgIcon name="logout" size={20}/></button>
                        </div>
                    </header>

                    <main className="p-6 flex-1 overflow-y-auto scrollbar-hide text-gray-800 font-black">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in font-black text-gray-800">
                                <div className="bg-gray-900 p-8 rounded-[3rem] shadow-2xl text-white relative overflow-hidden text-center text-gray-400">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-[60px] rounded-full"></div>
                                    <span className="text-[10px] font-black uppercase mb-3 block tracking-widest font-black">本月估算結餘</span>
                                    <div className="text-5xl font-black mb-8 tracking-tighter tabular-nums text-white">${stats.balance.toLocaleString()}</div>
                                    <div className="flex w-full gap-4 pt-6 border-t border-white/5 font-black text-sm text-gray-300">
                                        <div className="flex-1 text-center"><p className="text-[9px] uppercase mb-1 font-black">收入</p><p className="text-xl text-green-400 font-black">+${stats.income.toLocaleString()}</p></div>
                                        <div className="flex-1 border-l border-white/5 text-center font-black"><p className="text-[9px] uppercase mb-1 font-black">支出</p><p className="text-xl text-red-400 font-black">-${stats.expense.toLocaleString()}</p></div>
                                    </div>
                                </div>
                                <div className="space-y-4 text-left">
                                    <h3 className="font-black text-lg px-1 font-black">最近動態</h3>
                                    <div className="space-y-3 font-black">
                                        {myTransactions.slice(-5).reverse().map(tx => (
                                            <div key={tx.id} className="bg-white p-4 rounded-3xl border border-gray-100 flex items-center gap-4 shadow-sm active:bg-gray-50 transition-colors text-left font-black">
                                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center font-black text-[17px] shrink-0 leading-none ${tx.type === 'income' ? 'bg-green-600 text-white shadow-lg' : 'bg-red-600 text-white shadow-lg'}`}>{tx.type === 'income' ? '收入' : '支出'}</div>
                                                <div className="flex-1 min-w-0 font-black">
                                                    <div className="flex items-center gap-2 font-bold text-base truncate font-black text-gray-800 text-left font-black">{tx.category}</div>
                                                    <div className="text-[10px] text-gray-400 mt-1 font-medium text-left">
                                                        {tx.recorder !== tx.member ? `由 ${tx.recorder} 記錄 · ` : ''}{displayDateClean(tx.date)}
                                                    </div>
                                                </div>
                                                <div className={`font-black tabular-nums text-lg shrink-0 ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{tx.type === 'income' ? '+' : '-'}${Number(tx.amount).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'add' && <AddTransactionForm categories={['餐飲', '交通', '購物', '居家', '水電', '醫療', '薪資', '投資', '雜項']} loginUser={currentUser.name} onSubmit={handleAdd} isLoading={isLoading} />}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-in pb-20 text-left">
                                <h3 className="font-black text-lg ml-1">歷史帳目紀錄</h3>
                                <div className="space-y-2.5 text-gray-800">
                                    {myTransactions.slice().reverse().map(tx => (
                                        <div key={tx.id} className="bg-white p-5 rounded-[1.5rem] border border-gray-100 flex justify-between items-center shadow-sm font-black text-left">
                                            <div className="flex gap-4 items-center min-w-0 text-left">
                                                <div className={`w-14 h-14 rounded-xl flex items-center justify-center font-black text-[17px] shrink-0 leading-none ${tx.type === 'income' ? 'bg-green-600 text-white shadow-lg' : 'bg-red-600 text-white shadow-lg'}`}>{tx.type === 'income' ? '收入' : '支出'}</div>
                                                <div className="min-w-0 font-black text-left">
                                                    <div className="flex items-center gap-2 font-bold text-base truncate font-black text-gray-800 text-left font-black font-black">{tx.category}</div>
                                                    <div className="text-[10px] text-gray-400 block truncate font-medium mt-1 text-left">
                                                        {tx.recorder !== tx.member ? `由 ${tx.recorder} 記錄 · ` : ''}{displayDateClean(tx.date)}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className={`font-black tabular-nums text-lg shrink-0 ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{tx.type === 'income' ? '+' : '-'}${Number(tx.amount).toLocaleString()}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="space-y-4 animate-in text-left pb-20 text-gray-800 font-black">
                                <div className="bg-white p-6 rounded-[2rem] border shadow-sm border-gray-100 font-black">
                                    <h3 className="font-black text-xs mb-6 uppercase flex items-center gap-2 text-gray-800 tracking-widest px-1 font-black font-black font-black"><SvgIcon name="user" size={16} className="text-blue-500" /> 安全與帳戶管理</h3>
                                    <div className="space-y-3 text-left font-black text-gray-800">
                                        <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left font-black"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left leading-none font-black font-black">使用身份</p><p className="font-black text-gray-800 text-base leading-none mt-1 font-black">{currentUser.name}</p></div><button onClick={() => {setIsChangingPin(true); setPinChangeStep(1);}} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all">更換密碼</button></div>
                                        <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left font-black"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left leading-none">生物辨識 / 裝置解鎖</p><p className="font-black text-gray-800 text-sm leading-none mt-1 font-black">{currentUser.bioEnabled ? '已開啟' : '尚未開啟'}</p></div><button onClick={() => updateBioState(currentUser.name, !currentUser.bioEnabled)} className={`px-4 py-2 rounded-xl font-black text-xs active:scale-95 transition-all ${currentUser.bioEnabled ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-600 text-white shadow-lg shadow-green-600/20'}`}>{currentUser.bioEnabled ? '關閉' : '開啟'}</button></div>
                                        <div onClick={() => setShowChangelog(true)} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 cursor-pointer active:bg-gray-100 transition-colors font-black text-gray-800 leading-none"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left">App 版本</p><p className="font-mono font-bold leading-none mt-1 text-gray-800">v{APP_VERSION}</p></div><div className="bg-white p-2 rounded-lg border border-gray-200 text-gray-400 active:scale-90"><SvgIcon name="info" size={16} /></div></div>
                                        <div className="flex justify-between p-4 bg-gray-50 rounded-2xl text-[11px] font-bold text-gray-400 text-left"><span>雲端同步狀態</span><span className="text-green-600 font-black flex items-center gap-1"><SvgIcon name="check" size={10}/> 已同步</span></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/90 backdrop-blur-md rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl border border-white/20 safe-bottom">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'dashboard' ? 'text-blue-600 bg-blue-50 shadow-inner font-black' : 'text-gray-400'}`}><SvgIcon name="chart" /></button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'history' ? 'text-blue-600 bg-blue-50 font-black' : 'text-gray-400'}`}><SvgIcon name="history" /></button>
                        <button onClick={() => setActiveTab('add')} className={`w-16 h-16 flex items-center justify-center rounded-[1.5rem] shadow-xl active:scale-90 transition-all ${activeTab === 'add' ? 'bg-blue-700 text-white rotate-45 shadow-blue-200' : 'bg-gray-900 text-white'}`}><SvgIcon name="plus" size={32} /></button>
                        <div className="flex-1"></div>
                        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'settings' ? 'text-blue-600 bg-blue-50 shadow-inner font-black' : 'text-gray-400'}`}><SvgIcon name="settings" /></button>
                    </nav>

                    {/* 提示訊息 */}
                    {statusMsg.text && (
                        <div className="fixed bottom-28 left-0 right-0 flex justify-center z-[400] pointer-events-none px-4 text-center text-white">
                            <div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}><span className="text-sm font-bold tracking-tight text-center">{statusMsg.text}</span></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
