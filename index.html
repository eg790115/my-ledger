<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>家庭記帳</title>
    
    <!-- PWA 全螢幕設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111827">

    <!-- 動態生成 Manifest -->
    <script>
        const manifestJSON = {
            "name": "家庭記帳",
            "short_name": "記帳",
            "display": "standalone",
            "start_url": ".",
            "background_color": "#111827",
            "theme_color": "#111827",
            "icons": [{
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z'/%3E%3C/svg%3E",
                "sizes": "512x512",
                "type": "image/svg+xml"
            }]
        };
        const blob = new Blob([JSON.stringify(manifestJSON)], { type: 'application/manifest+json' });
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(blob);
        document.head.appendChild(manifestLink);
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            background-color: #111827;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .toast-enter { animation: toastIn 0.4s cubic-bezier(0.2, 1.2, 0.3, 1) forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .safe-bottom-nav { bottom: calc(2rem + env(safe-area-inset-bottom)); }
            .safe-pb-main { padding-bottom: calc(8rem + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const gasUrl = 'https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec';
        const APP_VERSION = "2026.02.24.39";

        const CHANGELOG = [
            { version: "2026.02.24.39", date: "2026/02/24", note: "【全系統健檢】修復版本不匹配幽靈提示，解決離線日期格式導致的破版，強化連點防護。" },
            { version: "2026.02.24.38", date: "2026/02/24", note: "修正圖示變形、優化提示視窗與密碼修改流程。" }
        ];

        const bufferToBase64url = (buffer) => {
            const bytes = new Uint8Array(buffer);
            let str = '';
            for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
            return window.btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        };
        const base64urlToBuffer = (base64url) => {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = (base64url + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray.buffer;
        };

        const SvgIcon = ({ name, size = 24, className = "" }) => {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {name === 'wallet' && <><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></>}
                    {name === 'plus' && <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>}
                    {name === 'history' && <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></>}
                    {name === 'chart' && <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>}
                    {name === 'settings' && <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>}
                    {name === 'logout' && <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>}
                    {name === 'refresh' && <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>}
                    {name === 'bio' && <><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></>}
                    {name === 'check' && <polyline points="20 6 9 17 4 12"/>}
                    {name === 'alert' && <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>}
                    {name === 'shield' && <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>}
                    {name === 'download' && <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>}
                    {name === 'x' && <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>}
                    {name === 'key' && <><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></>}
                </svg>
            );
        };

        const AddTransactionForm = ({ categories, member, onSubmit, isLoading }) => {
            const [formData, setFormData] = useState({ amount: '', category: categories[0] || '一般', type: 'expense', desc: '' });
            // 嚴格連點防護鎖
            const isSubmitting = useRef(false);

            const handleSubmit = async () => {
                if (isSubmitting.current || !formData.amount || isLoading) return;
                isSubmitting.current = true;
                await onSubmit(formData);
                isSubmitting.current = false;
                setFormData({ ...formData, amount: '', desc: '' }); // 成功後清空
            };

            return (
                <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border border-gray-100 animate-in text-center">
                    <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-8">
                        <button onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-3 rounded-xl font-black transition-all ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400'}`}>支出</button>
                        <button onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-3 rounded-xl font-black transition-all ${formData.type === 'income' ? 'bg-white text-green-500 shadow-sm' : 'text-gray-400'}`}>收入</button>
                    </div>
                    <div className="flex items-center justify-center mb-8">
                        <span className="text-2xl font-black text-gray-300 mr-1">$</span>
                        <input type="number" inputMode="decimal" autoFocus className={`w-48 text-6xl font-black text-center outline-none bg-transparent ${formData.type === 'expense' ? 'text-red-500' : 'text-green-500'}`} placeholder="0" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
                    </div>
                    <div className="space-y-4 text-left">
                        <div className="bg-gray-100 p-4 rounded-2xl">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">類別</label>
                            <select className="w-full bg-transparent font-bold border-none outline-none appearance-none" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}>
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="bg-gray-100 p-4 rounded-2xl">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">備註說明</label>
                            <input type="text" className="w-full bg-transparent font-bold border-none outline-none" placeholder="輸入內容..." value={formData.desc} onChange={(e) => setFormData({...formData, desc: e.target.value})} />
                        </div>
                    </div>
                    <button disabled={!formData.amount || isLoading} onClick={handleSubmit} className={`w-full mt-8 py-5 text-white rounded-3xl font-black text-lg transition shadow-xl ${(!formData.amount || isLoading) ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-900 active:scale-95'}`}>{isLoading ? "同步雲端中..." : "確認存檔"}</button>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [currentUser, setCurrentUser] = useState(null); 
            const [gasVersion, setGasVersion] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
            const [biometricAvailable, setBiometricAvailable] = useState(false);
            
            const [familyConfig, setFamilyConfig] = useState(() => {
                const saved = localStorage.getItem('family_member_config_v9');
                return saved ? JSON.parse(saved) : [
                    { name: '爸爸', pin: '790115', color: 'bg-blue-600' },
                    { name: '媽媽', pin: '791005', color: 'bg-pink-600' }
                ];
            });

            const [securityState, setSecurityState] = useState(() => {
                const saved = localStorage.getItem('family_security_state_v9');
                return saved ? JSON.parse(saved) : { failedAttempts: {}, needsPinValidation: {} };
            });

            const [offlineQueue, setOfflineQueue] = useState(() => {
                const saved = localStorage.getItem('family_offline_queue_v1');
                return saved ? JSON.parse(saved) : [];
            });

            const [bioCredentials, setBioCredentials] = useState(() => {
                const saved = localStorage.getItem('family_bio_creds_v1');
                return saved ? JSON.parse(saved) : {};
            });

            const [pinInput, setPinInput] = useState("");
            const [selectingUser, setSelectingUser] = useState(null);
            
            const [isChangingPin, setIsChangingPin] = useState(false);
            const [pinChangeStep, setPinChangeStep] = useState(1);
            const [tempPin, setTempPin] = useState("");

            useEffect(() => {
                localStorage.setItem('family_security_state_v9', JSON.stringify(securityState));
                localStorage.setItem('family_member_config_v9', JSON.stringify(familyConfig));
                localStorage.setItem('family_bio_creds_v1', JSON.stringify(bioCredentials));
                localStorage.setItem('family_offline_queue_v1', JSON.stringify(offlineQueue));
            }, [securityState, familyConfig, bioCredentials, offlineQueue]);

            useEffect(() => {
                if (window.PublicKeyCredential) {
                    PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(v => setBiometricAvailable(v));
                }
                syncCloud();
            }, []);

            const showStatus = (type, text) => {
                setStatusMsg({ type, text });
                setTimeout(() => setStatusMsg({ type: '', text: '' }), 3000);
            };

            const syncCloud = async () => {
                if (!navigator.onLine) return;
                setIsLoading(true);
                try {
                    const res = await fetch(gasUrl);
                    const data = await res.json();
                    if (data.gasVersion) setGasVersion(data.gasVersion);
                    if (data.members) setFamilyConfig(data.members);
                    const formatted = (data.transactions || []).map((t, i) => ({
                        id: t.id || i,
                        amount: parseFloat(t['金額']) || 0,
                        category: t['類別'] || '一般',
                        date: t['日期時間'] || t['日期'] || '',
                        member: t['成員'] || '未知',
                        desc: t['備註'] || '',
                        type: t['類型'] || 'expense'
                    }));
                    setTransactions(formatted);

                    if (offlineQueue.length > 0) {
                        for (let item of offlineQueue) {
                            try {
                                await fetch(gasUrl, { method: 'POST', body: JSON.stringify(item), mode: 'no-cors' });
                                setOfflineQueue(prev => prev.filter(q => q.id !== item.id));
                            } catch(e) { break; }
                        }
                    }
                } catch (err) { console.error(err); }
                setIsLoading(false);
            };

            const formatFullDateTime = (input) => {
                if (!input) return '';
                try {
                    // 支援 GAS 日期與離線相容
                    let d = new Date(input);
                    if (isNaN(d.getTime()) && input.includes('/')) d = new Date(input.replace(/\//g, '-'));
                    if (isNaN(d.getTime())) return String(input);
                    return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                } catch (e) { return String(input); }
            };

            // 修正：容錯保護日期切割邏輯，相容 ISO 與 YYYY/MM/DD
            const renderDateBlock = (dateStr) => {
                let month = '-', day = '-';
                if (dateStr) {
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        month = parts[1];
                        day = parts[2]?.split(' ')[0];
                    } else {
                        const d = new Date(dateStr);
                        if (!isNaN(d.getTime())) {
                            month = String(d.getMonth() + 1).padStart(2, '0');
                            day = String(d.getDate()).padStart(2, '0');
                        }
                    }
                }
                return (
                    <div className="flex flex-col items-center min-w-[40px] bg-gray-50 py-1.5 rounded-xl border border-gray-100">
                        <span className="text-[8px] text-gray-400 font-bold uppercase">{month}月</span>
                        <span className="text-lg font-black text-gray-900 leading-none">{day}</span>
                    </div>
                );
            };

            const allTransactions = useMemo(() => {
                return [...transactions, ...offlineQueue].sort((a, b) => new Date(a.date.replace(/\//g, '-')) - new Date(b.date.replace(/\//g, '-')));
            }, [transactions, offlineQueue]);

            const stats = useMemo(() => {
                const income = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const expense = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                return { income, expense, balance: income - expense };
            }, [allTransactions]);

            const handlePinSubmit = (val) => {
                const next = pinInput + val;
                if (next.length <= 6) {
                    setPinInput(next);
                    if (next.length === 6) {
                        setTimeout(() => {
                            if (next === selectingUser.pin) {
                                setSecurityState(s => ({
                                    ...s, 
                                    failedAttempts: { ...s.failedAttempts, [selectingUser.name]: 0 },
                                    needsPinValidation: { ...s.needsPinValidation, [selectingUser.name]: false }
                                }));
                                setCurrentUser(selectingUser);
                                setPinInput("");
                                setSelectingUser(null);
                            } else {
                                showStatus('error', '密碼不正確，請重新輸入');
                                setPinInput("");
                            }
                        }, 200);
                    }
                }
            };

            const handleBioAuth = async (targetUser = null) => {
                const user = targetUser || selectingUser;
                if (!user) return;
                const name = user.name;
                const fails = securityState.failedAttempts[name] || 0;
                
                if (securityState.needsPinValidation[name]) {
                    showStatus('info', '安全機制：密碼已變更，請手動輸入一次密碼');
                    return;
                }
                if (fails >= 5) {
                    showStatus('error', '錯誤次數過多已鎖定，請使用密碼登入');
                    return;
                }

                const credIdBase64 = bioCredentials[name];
                if (!credIdBase64) return;

                try {
                    const challenge = new Uint8Array(32);
                    window.crypto.getRandomValues(challenge);

                    const credential = await navigator.credentials.get({
                        publicKey: {
                            challenge: challenge,
                            rpId: window.location.hostname,
                            allowCredentials: [{
                                id: base64urlToBuffer(credIdBase64),
                                type: 'public-key'
                            }],
                            userVerification: "required",
                            timeout: 60000
                        }
                    });

                    if (credential) {
                        setSecurityState(s => ({ ...s, failedAttempts: { ...s.failedAttempts, [name]: 0 } }));
                        setCurrentUser(user);
                        setSelectingUser(null);
                        setPinInput("");
                        showStatus('success', '系統解鎖成功');
                    }
                } catch (err) {
                    const newFails = fails + 1;
                    setSecurityState(s => ({ ...s, failedAttempts: { ...s.failedAttempts, [name]: newFails } }));
                    if (newFails >= 5) {
                        showStatus('error', '錯誤次數過多，解鎖系統已關閉');
                    } else {
                        showStatus('error', `驗證失敗 (剩餘 ${5 - newFails} 次機會)`);
                    }
                }
            };

            const registerBiometrics = async () => {
                try {
                    const challenge = new Uint8Array(32);
                    window.crypto.getRandomValues(challenge);
                    const userId = new Uint8Array(16);
                    window.crypto.getRandomValues(userId);

                    const credential = await navigator.credentials.create({
                        publicKey: {
                            challenge: challenge,
                            rp: { name: "家庭記帳", id: window.location.hostname },
                            user: { id: userId, name: currentUser.name, displayName: currentUser.name },
                            pubKeyCredParams: [{ alg: -7, type: "public-key" }, { alg: -257, type: "public-key" }],
                            authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" },
                            timeout: 60000
                        }
                    });

                    if (credential) {
                        const credIdBase64 = bufferToBase64url(credential.rawId);
                        setBioCredentials(prev => ({ ...prev, [currentUser.name]: credIdBase64 }));
                        showStatus('success', '設備綁定成功！下次可直接解鎖');
                    }
                } catch (err) {
                    showStatus('error', '綁定失敗或被取消');
                }
            };

            const handleAdd = async (newTx) => {
                const now = new Date();
                // 健檢修復：產生與 Google Sheet 完全相容的日期格式，避免離線時破版
                const pad = (n) => String(n).padStart(2, '0');
                const safeDateStr = `${now.getFullYear()}/${pad(now.getMonth() + 1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
                const tx = { ...newTx, member: currentUser.name, id: Date.now(), date: safeDateStr }; 
                
                setIsLoading(true);
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify(tx), mode: 'no-cors' });
                    setTransactions(prev => [...prev, tx]);
                    showStatus('success', '紀錄成功');
                    setTimeout(syncCloud, 1000);
                } catch (err) { 
                    setOfflineQueue(prev => [...prev, tx]);
                    showStatus('info', '網路不穩定，已存入本機緩存');
                }
                setIsLoading(false);
                setActiveTab('dashboard');
            };

            const updatePinOnCloud = async (name, newPin) => {
                if (!navigator.onLine) return false;
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'UPDATE_PIN', name, newPin }), mode: 'no-cors' });
                    return true;
                } catch (e) { return false; }
            };

            const handleNewPinSubmit = async (val) => {
                const next = tempPin + val;
                if (next.length <= 6) {
                    setTempPin(next);
                    if (next.length === 6) {
                        setTimeout(async () => {
                            if (pinChangeStep === 1) {
                                if (next === currentUser.pin) {
                                    setPinChangeStep(2);
                                    setTempPin("");
                                    showStatus('info', '驗證通過！請輸入新密碼');
                                } else {
                                    showStatus('error', '原密碼輸入錯誤，請重試');
                                    setTempPin("");
                                }
                            } else {
                                setIsLoading(true);
                                const success = await updatePinOnCloud(currentUser.name, next);
                                if (success) {
                                    setFamilyConfig(familyConfig.map(u => u.name === currentUser.name ? { ...u, pin: next } : u));
                                    setSecurityState(s => ({ ...s, needsPinValidation: { ...s.needsPinValidation, [currentUser.name]: true } }));
                                    showStatus('success', '密碼更新成功！請重新登入');
                                    
                                    setTimeout(() => {
                                        setIsChangingPin(false);
                                        setCurrentUser(null); 
                                        setPinChangeStep(1);
                                        setTempPin("");
                                        setIsLoading(false);
                                    }, 1500);
                                } else {
                                    showStatus('error', '雲端連線失敗，請檢查網路');
                                    setIsLoading(false);
                                    setTempPin("");
                                }
                            }
                        }, 200);
                    }
                }
            };

            const ToastNotification = () => {
                if (!statusMsg.text) return null;
                const isError = statusMsg.type === 'error';
                const isSuccess = statusMsg.type === 'success';
                return (
                    <div className="fixed top-12 left-0 w-full z-[9999] flex justify-center pointer-events-none px-4 toast-enter">
                        <div className={`px-6 py-4 rounded-[1.5rem] shadow-2xl flex items-center gap-3 backdrop-blur-xl border ${isSuccess ? 'bg-green-600/95 text-white border-green-500' : (isError ? 'bg-red-600/95 text-white border-red-500 shadow-red-500/30' : 'bg-blue-600/95 text-white border-blue-500 shadow-blue-500/30')}`}>
                            <SvgIcon name={isSuccess ? 'check' : 'alert'} size={20} className="text-white" />
                            <span className="text-[15px] font-black tracking-widest">{statusMsg.text}</span>
                        </div>
                    </div>
                );
            };

            let appContent;

            if (!currentUser) {
                const fails = selectingUser ? (securityState.failedAttempts[selectingUser.name] || 0) : 0;
                const hideBio = !selectingUser || securityState.needsPinValidation[selectingUser.name] || fails >= 5;

                appContent = (
                    <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-8">
                        {gasVersion && gasVersion !== APP_VERSION && (
                            <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[100] w-[90%] max-w-xs bg-blue-600 p-4 rounded-2xl shadow-2xl flex items-center justify-between">
                                <div className="text-white flex items-center gap-2">
                                    <SvgIcon name="download" size={20} />
                                    <span className="text-xs font-bold">新版本 v{gasVersion}</span>
                                </div>
                                <button onClick={() => window.location.reload()} className="bg-white text-blue-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase">更新</button>
                            </div>
                        )}
                        <div className="mb-12 text-center animate-in">
                            <div className="bg-blue-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-2xl">
                                <SvgIcon name="wallet" size={40} className="text-white" />
                            </div>
                            <h1 className="text-white text-4xl font-black italic tracking-tighter mb-2">家庭記帳</h1>
                            <p className="text-gray-500 text-[10px] font-mono tracking-widest">v{APP_VERSION}</p>
                        </div>
                        
                        {!selectingUser ? (
                            <div className="grid grid-cols-1 gap-6 w-full max-w-xs animate-in">
                                {familyConfig.map(user => (
                                    <button 
                                        key={user.name} 
                                        onClick={() => {
                                            setSelectingUser(user);
                                            setPinInput("");
                                            const f = securityState.failedAttempts[user.name] || 0;
                                            const needsPin = securityState.needsPinValidation[user.name];
                                            const hasBio = bioCredentials[user.name];
                                            if (hasBio && !needsPin && f < 5) handleBioAuth(user);
                                        }} 
                                        className={`${user.color} text-white py-6 rounded-[2.5rem] font-black text-2xl shadow-lg border-4 border-white/5 active:scale-95 transition-all`}
                                    >
                                        {user.name}
                                    </button>
                                ))}
                            </div>
                        ) : (
                            <div className="w-full max-w-xs animate-in">
                                <div className="text-center mb-8">
                                    <p className="text-white font-black text-3xl mb-2">{selectingUser.name}</p>
                                    <p className="text-gray-500 text-xs font-bold tracking-widest">請輸入 6 位數安全密碼</p>
                                </div>
                                <div className="flex justify-center gap-3 mb-10">
                                    {[...Array(6)].map((_, i) => (
                                        <div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-blue-500 transition-all ${pinInput.length > i ? 'bg-blue-500 shadow-[0_0_15px_#3b82f6] scale-110' : 'bg-transparent'}`}></div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (
                                        <button key={k} onClick={() => k === 'C' ? setPinInput("") : k === '←' ? setPinInput(pinInput.slice(0, -1)) : handlePinSubmit(k)} className="bg-gray-800 text-white h-16 rounded-3xl font-black text-2xl active:bg-blue-600 border border-white/5 transition-colors">{k}</button>
                                    ))}
                                </div>
                                {!hideBio && (
                                    <button onClick={() => handleBioAuth(selectingUser)} className={`w-full py-5 rounded-[2rem] flex items-center justify-center gap-3 font-black text-lg active:scale-95 transition-all ${bioCredentials[selectingUser.name] ? 'bg-blue-600 text-white shadow-xl' : 'bg-gray-800 text-gray-400 border border-white/10'}`}>
                                        <SvgIcon name="bio" size={24} /> 
                                        {bioCredentials[selectingUser.name] ? '系統解鎖 (指紋/圖形/臉部)' : '點此綁定設備解鎖'}
                                    </button>
                                )}
                                <button onClick={() => {setSelectingUser(null); setPinInput("");}} className="w-full mt-8 text-gray-500 text-xs font-black uppercase tracking-widest underline">返回成員選擇</button>
                            </div>
                        )}
                    </div>
                );
            } else {
                appContent = (
                    <div className="min-h-screen bg-gray-50 text-gray-900 safe-pb-main max-w-md mx-auto relative overflow-hidden">
                        
                        {isChangingPin && (
                            <div className="fixed inset-0 z-[9990] bg-gray-900/95 backdrop-blur-xl flex flex-col items-center justify-center p-8 animate-in">
                                {!isLoading && <button onClick={() => {setIsChangingPin(false); setTempPin(""); setPinChangeStep(1);}} className="absolute top-8 right-8 text-gray-400 hover:text-white p-3 bg-white/10 rounded-full active:scale-90 transition-all"><SvgIcon name="x" size={24} /></button>}
                                
                                <div className="text-center mb-10 w-full">
                                    <div className="bg-blue-600/20 p-5 rounded-full mb-6 inline-flex shadow-[0_0_30px_rgba(37,99,235,0.3)]">
                                        {isLoading ? <SvgIcon name="refresh" size={40} className="text-blue-500 animate-spin" /> : <SvgIcon name="key" size={40} className="text-blue-500" />}
                                    </div>
                                    <h2 className="text-white text-3xl font-black mb-4 tracking-wider">
                                        {isLoading ? '資料同步中' : (pinChangeStep === 1 ? '原密碼驗證' : '設定新密碼')}
                                    </h2>
                                    <div className="bg-white/5 py-3 px-6 rounded-2xl inline-block border border-white/10">
                                        <p className={`text-sm font-bold tracking-widest ${pinChangeStep === 1 ? 'text-gray-300' : 'text-green-400'}`}>
                                            {isLoading ? '請勿關閉應用程式...' : (pinChangeStep === 1 ? '請輸入您【目前的】6 位數密碼' : '請輸入您【想要的新】6 位數密碼')}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="flex justify-center gap-4 mb-10">
                                    {[...Array(6)].map((_, i) => (
                                        <div key={i} className={`w-4 h-4 rounded-full border-2 border-blue-500 transition-all duration-200 ${tempPin.length > i ? 'bg-blue-500 shadow-[0_0_15px_#3b82f6] scale-125' : 'bg-transparent'}`}></div>
                                    ))}
                                </div>
                                
                                <div className={`grid grid-cols-3 gap-5 w-full max-w-xs transition-opacity ${isLoading ? 'opacity-30 pointer-events-none' : 'opacity-100'}`}>
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (
                                        <button key={k} onClick={() => k === 'C' ? setTempPin("") : k === '←' ? setTempPin(tempPin.slice(0, -1)) : handleNewPinSubmit(k)} className="bg-white/5 text-white h-20 rounded-[2rem] font-black text-[26px] active:bg-blue-600 active:scale-95 transition-all border border-white/5">{k}</button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <header className="px-6 pt-12 pb-6 bg-white sticky top-0 z-40 flex justify-between items-center border-b shadow-sm">
                            <div className="flex items-center gap-3">
                                <div className={`${currentUser.color} w-10 h-10 rounded-2xl flex items-center justify-center text-white font-black shadow-lg`}>{currentUser.name.charAt(0)}</div>
                                <div><h1 className="text-2xl font-black tracking-tighter italic leading-tight">家庭記帳</h1><span className="text-[9px] font-black text-blue-500 uppercase tracking-widest">{currentUser.name} 登入中</span></div>
                            </div>
                            <div className="flex gap-2">
                                {offlineQueue.length > 0 && <div className="flex items-center gap-1 px-2 py-1 bg-yellow-50 text-yellow-600 rounded-lg text-[10px] font-bold"><div className="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div>未同步</div>}
                                <button onClick={syncCloud} className={`p-2.5 bg-gray-50 rounded-xl ${isLoading ? 'animate-spin text-blue-500' : 'text-gray-600'}`}><SvgIcon name="refresh" size={20}/></button>
                                <button onClick={() => setCurrentUser(null)} className="p-2.5 bg-red-50 text-red-500 rounded-xl active:scale-90 transition"><SvgIcon name="logout" size={20}/></button>
                            </div>
                        </header>
                        
                        <main className="p-6">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in">
                                    <div className="bg-gray-900 p-8 rounded-[3rem] shadow-2xl text-white">
                                        <span className="text-[10px] font-black text-gray-500 uppercase mb-3 block">本月盈餘總結</span>
                                        <div className="text-5xl font-black mb-8 tracking-tighter tabular-nums">${stats.balance.toLocaleString()}</div>
                                        <div className="flex w-full gap-4 pt-6 border-t border-white/5 text-center">
                                            <div className="flex-1"><span className="text-[9px] font-black text-gray-500 uppercase block mb-1">收入</span><span className="text-xl font-black text-green-400">+${stats.income.toLocaleString()}</span></div>
                                            <div className="flex-1 border-l border-white/5"><span className="text-[9px] font-black text-gray-500 uppercase block mb-1">支出</span><span className="text-xl font-black text-red-400">-${stats.expense.toLocaleString()}</span></div>
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <h3 className="font-black text-lg text-gray-800">最近動態</h3>
                                        <div className="space-y-3">
                                            {allTransactions.slice(-5).reverse().map((tx, idx) => (
                                                <div key={tx.id || idx} className="bg-white p-4 rounded-3xl border border-gray-100 flex items-center gap-4 shadow-sm active:scale-95 transition">
                                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black ${tx.type === 'income' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>{tx.category?.charAt(0)}</div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 font-bold text-sm text-gray-800">{tx.category} <span className="px-1.5 py-0.5 bg-gray-100 text-[8px] font-black text-gray-400 rounded-md uppercase tracking-widest">{tx.member}</span></div>
                                                        <div className="text-[10px] text-gray-400 mt-0.5">{formatFullDateTime(tx.date)}</div>
                                                    </div>
                                                    <div className={`font-black tabular-nums text-lg ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>${Number(tx.amount).toLocaleString()}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'add' && <AddTransactionForm categories={['餐飲', '交通', '購物', '居家', '水電', '醫療', '薪資', '投資', '雜項']} member={currentUser.name} onSubmit={handleAdd} isLoading={isLoading} />}
                            {activeTab === 'history' && (
                                <div className="space-y-4 animate-in pb-20">
                                    <h3 className="font-black text-lg uppercase tracking-widest flex items-center gap-2 ml-1 text-gray-800">歷史紀錄清單</h3>
                                    <div className="space-y-2.5">
                                        {allTransactions.slice().reverse().map((tx, idx) => (
                                            <div key={tx.id || idx} className="bg-white p-5 rounded-[1.5rem] border border-gray-100 flex justify-between items-center shadow-sm">
                                                <div className="flex gap-4 items-center">
                                                    {renderDateBlock(tx.date)}
                                                    <div>
                                                        <div className="flex items-center gap-2 font-bold text-sm text-gray-800">{tx.category} <span className="text-[9px] text-blue-500 font-black uppercase">{tx.member}</span></div>
                                                        <span className="text-[10px] text-gray-400 block truncate max-w-[120px] italic">{tx.desc || '無備註'}</span>
                                                    </div>
                                                </div>
                                                <div className={`font-black tabular-nums text-lg ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>${Number(tx.amount).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'settings' && (
                                <div className="space-y-4 animate-in">
                                    <div className="bg-white p-6 rounded-3xl border shadow-sm border-gray-100">
                                        <h3 className="font-black text-xs mb-6 uppercase flex items-center gap-2 text-gray-800"><SvgIcon name="shield" size={16} className="text-blue-500" /> 安全與帳戶資訊</h3>
                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                                                <span className="font-black text-sm text-gray-800">{currentUser.name} (密碼)</span>
                                                <button onClick={() => {setIsChangingPin(true); setPinChangeStep(1);}} className="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">變更 PIN 碼</button>
                                            </div>
                                            {biometricAvailable && (
                                                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                                                    <span className="font-black text-sm text-gray-800">設備系統解鎖</span>
                                                    {bioCredentials[currentUser.name] ? (
                                                        <button onClick={() => {
                                                            if(window.confirm('確定要移除設備綁定嗎？下次需手動重新綁定。')) {
                                                                const newCreds = {...bioCredentials};
                                                                delete newCreds[currentUser.name];
                                                                setBioCredentials(newCreds);
                                                                showStatus('success', '已停用，恢復密碼登入');
                                                            }
                                                        }} className="text-[10px] font-black text-red-600 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100">移除綁定</button>
                                                    ) : (
                                                        <button onClick={registerBiometrics} className="text-[10px] font-black text-green-600 bg-green-50 px-3 py-1.5 rounded-lg border border-green-100">綁定設備</button>
                                                    )}
                                                </div>
                                            )}
                                            <div className="flex justify-between p-3 bg-gray-50 rounded-xl text-[10px] font-bold text-gray-500"><span>App 版本</span><span className="font-mono">v{APP_VERSION}</span></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                        
                        <nav className="fixed bottom-8 safe-bottom-nav left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/80 backdrop-blur-md rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl border border-white/20">
                            <button onClick={() => setActiveTab('dashboard')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'dashboard' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><SvgIcon name="chart" /></button>
                            <button onClick={() => setActiveTab('history')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'history' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><SvgIcon name="history" /></button>
                            <button onClick={() => setActiveTab('add')} className={`w-16 h-16 flex items-center justify-center rounded-[1.5rem] shadow-xl active:scale-90 ${activeTab === 'add' ? 'bg-blue-700 text-white rotate-45 shadow-blue-200' : 'bg-gray-900 text-white'}`}><SvgIcon name="plus" size={32} /></button>
                            <div className="flex-1"></div>
                            <button onClick={() => setActiveTab('settings')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'settings' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><SvgIcon name="settings" /></button>
                        </nav>
                    </div>
                );
            }

            return (
                <React.Fragment>
                    <ToastNotification />
                    {appContent}
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
