<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶åº­è¨˜å¸³</title>
    
    <!-- PWA å…¨è¢å¹•è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111827">

    <!-- å‹•æ…‹ç”Ÿæˆ Manifest -->
    <script>
        const manifestJSON = {
            "name": "å®¶åº­è¨˜å¸³",
            "short_name": "è¨˜å¸³",
            "display": "standalone",
            "start_url": ".",
            "background_color": "#111827",
            "theme_color": "#111827",
            "icons": [{
                "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z'/%3E%3C/svg%3E",
                "sizes": "512x512",
                "type": "image/svg+xml"
            }]
        };
        const blob = new Blob([JSON.stringify(manifestJSON)], { type: 'application/manifest+json' });
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = URL.createObjectURL(blob);
        document.head.appendChild(manifestLink);
    </script>

    <!-- è¼‰å…¥ç’°å¢ƒ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            background-color: #111827;
            margin: 0;
            overflow-x: hidden;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .animate-cursor { animation: cursor-blink 1s step-end infinite; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        #root { min-height: 100vh; display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 text-left font-black">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const gasUrl = 'https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec'; 
        
        const APP_VERSION = "2026.02.24.190";

        const CHANGELOG = [
            { version: "2026.02.24.190", date: "2026/02/24", note: "å®‰å…¨åŒæ­¥å‡ç´šï¼šä¿®å¾©ä¸¦å•Ÿç”¨ã€Œè·¨è£ç½®å¯†ç¢¼åŒæ­¥ã€ï¼Œç¢ºä¿å¾é›²ç«¯æ­£ç¢ºè®€å–æœ€æ–° PIN ç¢¼èˆ‡ç”Ÿç‰©è¾¨è­˜ç‹€æ…‹ã€‚" },
            { version: "2026.02.24.185", date: "2026/02/24", note: "ä»‹é¢å„ªåŒ–ï¼šç·¨è¼¯åœ–ç¤ºç§»è‡³é‡‘é¡å³å´ä¸”åƒ…ä¿ç•™åœ–æ¡ˆã€‚ä¿®æ”¹è³‡æ–™å¾Œè‡ªå‹•é™„åŠ  (å·²ç·¨è¼¯) æˆ³è¨˜ã€‚" },
            { version: "2026.02.24.180", date: "2026/02/24", note: "é‡å¤§æ›´æ–°ï¼šæ”¯æ´æ­·å²ç´€éŒ„ã€Œç·¨è¼¯ã€èˆ‡ã€Œåˆªé™¤ã€åŠŸèƒ½ï¼Œä¸¦æ•´åˆé›¢ç·šå°åˆ—æ©Ÿåˆ¶ã€‚" },
            { version: "2026.02.24.175", date: "2026/02/24", note: "åŠŸèƒ½æ–°å¢ï¼šè¨˜å¸³é é¢åŠ å…¥ã€Œæ—¥æœŸèˆ‡æ™‚é–“ã€é¸æ“‡å™¨ã€‚" }
        ];

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ ---
        const SvgIcon = ({ name, size = 24, className = "" }) => {
            const icons = {
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/>,
                plus: <path d="M12 5v14m-7-7h14"/>,
                history: <React.Fragment><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 12h6"/><path d="M9 16h6"/><path d="M9 8h6"/></React.Fragment>,
                chart: <React.Fragment><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></React.Fragment>,
                settings: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                    </React.Fragment>
                ),
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5l-5-5m5 5H9"/>,
                refresh: <React.Fragment><path d="M17.5 19a5.5 5.5 0 0 0 0-11h-1.3b11a7 7 0 1 0-11.9 4.3"/><path d="m11 15 2 2 4-4"/></React.Fragment>,
                bio: <React.Fragment><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
                key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.778-7.778zm0 0L15.5 7.5m0 0l3 3m-3-3l2.5-2.5"/>,
                user: <React.Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>,
                close: <path d="M18 6L6 18M6 6l12 12"/>,
                info: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></React.Fragment>,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
                check: <path d="M20 6L9 17l-5-5"/>,
                edit: <React.Fragment><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></React.Fragment>,
                trash: <React.Fragment><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={`shrink-0 aspect-square ${className}`}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        const AddTransactionForm = ({ categories, loginUser, onSubmit, isLoading }) => {
            const inputRef = useRef(null);
            const [isFocused, setIsFocused] = useState(false);
            const [formData, setFormData] = useState({ 
                amount: '', category: categories[0] || 'ä¸€èˆ¬', member: loginUser, 
                type: 'expense', desc: '', date: '' 
            });

            const otherMember = loginUser === 'çˆ¸çˆ¸' ? 'åª½åª½' : 'çˆ¸çˆ¸';

            const renderAmount = () => {
                const val = formData.amount;
                if (isFocused) return (val === '' || val === '0') ? <span className="text-gray-300 animate-cursor">_</span> : val;
                return (val === '' || val === '0') ? "0" : val;
            };

            return (
                <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border border-gray-100 animate-in text-center relative font-black">
                    <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-8 text-sm text-gray-500">
                        <button onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm font-black' : ''}`}>æ”¯å‡º</button>
                        <button onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'income' ? 'bg-white text-green-500 shadow-sm font-black' : ''}`}>æ”¶å…¥</button>
                    </div>

                    <div className="relative flex items-center justify-center mb-8 py-2 min-h-[80px] cursor-pointer font-black text-gray-800" onClick={() => inputRef.current?.focus()}>
                        <span className="text-2xl font-black text-gray-300 mr-1 mt-2">$</span>
                        <div className={`text-6xl font-black text-center min-w-[1.5rem] tracking-tighter transition-colors ${formData.type === 'expense' ? 'text-red-500' : 'text-green-500'}`}>{renderAmount()}</div>
                        <input ref={inputRef} type="number" inputMode="decimal" className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-black" value={formData.amount} onFocus={() => setIsFocused(true)} onBlur={() => setIsFocused(false)} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
                    </div>

                    <div className="space-y-4 text-left">
                        <div className="bg-gray-100 p-4 rounded-2xl text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1 font-black">æ—¥æœŸèˆ‡æ™‚é–“ (æœªé¸å‰‡ç‚ºç¾åœ¨)</label>
                            <input type="datetime-local" className="w-full bg-transparent font-black border-none outline-none text-gray-800" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} />
                        </div>
                        <div className="bg-gray-100 p-4 rounded-2xl text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1 font-black">é¡åˆ¥</label>
                            <select className="w-full bg-transparent border-none outline-none appearance-none font-black" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}>
                                {categories.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="bg-gray-100 p-4 rounded-2xl text-gray-800">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1 font-black">å‚™è¨»èªªæ˜</label>
                            <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 font-black" placeholder="è¼¸å…¥å…§å®¹..." value={formData.desc} onChange={(e) => setFormData({...formData, desc: e.target.value})} />
                        </div>
                        <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-2 text-gray-500 font-black">ç´€éŒ„å°è±¡</label>
                            <div className="flex gap-2">
                                <button type="button" onClick={() => setFormData({...formData, member: loginUser})} className={`flex-1 py-3 rounded-xl text-[11px] transition-all border-2 font-black ${formData.member === loginUser ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-gray-200 text-gray-400'}`}>è‡ªå·± {formData.member === loginUser && 'âœ“'}</button>
                                <button type="button" onClick={() => setFormData({...formData, member: otherMember})} className={`flex-1 py-3 rounded-xl text-[11px] transition-all border-2 font-black ${formData.member === otherMember ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-gray-200 text-gray-400'}`}>çµ¦{otherMember}ç´€éŒ„ {formData.member === otherMember && 'âœ“'}</button>
                            </div>
                        </div>
                    </div>
                    <button disabled={!formData.amount || formData.amount === '0' || isLoading} onClick={() => onSubmit(formData)} className="w-full mt-8 py-5 bg-gray-900 text-white rounded-3xl font-black text-lg active:scale-95 transition shadow-xl disabled:opacity-30">{isLoading ? "åŒæ­¥ä¸­..." : "ç¢ºèªå­˜æª”"}</button>
                </div>
            );
        };

        // --- ç·¨è¼¯å°ˆç”¨å½ˆçª—çµ„ä»¶ ---
        const EditTransactionModal = ({ tx, categories, loginUser, onSave, onDelete, onCancel, isLoading }) => {
            const [formData, setFormData] = useState({ ...tx });
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);

            useEffect(() => {
                let formattedDate = '';
                if (tx.date) {
                    formattedDate = tx.date.replace(' (å·²ç·¨è¼¯)', '').replace('(å·²ç·¨è¼¯)', '').replace(/\//g, '-').replace(' ', 'T');
                    if (formattedDate.length > 16) formattedDate = formattedDate.slice(0, 16);
                }
                setFormData({ ...tx, date: formattedDate });
            }, [tx]);

            const otherMember = loginUser === 'çˆ¸çˆ¸' ? 'åª½åª½' : 'çˆ¸çˆ¸';

            return (
                <div className="fixed inset-0 z-[500] bg-gray-900/90 backdrop-blur-sm overflow-y-auto flex flex-col items-center justify-center p-6 animate-in font-black">
                    <div className="w-full max-w-sm relative">
                        <button onClick={onCancel} className="absolute -top-12 right-0 text-white p-2 active:scale-90 opacity-80 hover:opacity-100 transition"><SvgIcon name="close" size={32}/></button>
                        
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                            <h2 className="text-xl font-black text-center mb-6 text-gray-800 pt-2">ç·¨è¼¯å¸³ç›®</h2>
                            
                            <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-6 text-sm text-gray-500">
                                <button onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm font-black' : ''}`}>æ”¯å‡º</button>
                                <button onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === 'income' ? 'bg-white text-green-500 shadow-sm font-black' : ''}`}>æ”¶å…¥</button>
                            </div>

                            <div className="relative flex items-center justify-center mb-6 py-2 border-b border-gray-100 pb-6 text-gray-800">
                                <span className="text-2xl font-black text-gray-300 mr-1 mt-1">$</span>
                                <input type="number" inputMode="decimal" className={`w-32 text-5xl font-black text-center outline-none bg-transparent ${formData.type === 'expense' ? 'text-red-500' : 'text-green-500'}`} value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
                            </div>

                            <div className="space-y-4 text-left">
                                <div className="bg-gray-100 p-3.5 rounded-2xl">
                                    <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">æ™‚é–“</label>
                                    <input type="datetime-local" className="w-full bg-transparent font-black border-none outline-none text-gray-800 text-sm" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} />
                                </div>
                                <div className="flex gap-3">
                                    <div className="bg-gray-100 p-3.5 rounded-2xl flex-1">
                                        <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">é¡åˆ¥</label>
                                        <select className="w-full bg-transparent border-none outline-none appearance-none font-black text-sm" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}>
                                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div className="bg-gray-100 p-3.5 rounded-2xl flex-1">
                                        <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">å°è±¡</label>
                                        <select className="w-full bg-transparent border-none outline-none appearance-none font-black text-sm" value={formData.member} onChange={(e) => setFormData({...formData, member: e.target.value})}>
                                            <option value={loginUser}>è‡ªå·±</option>
                                            <option value={otherMember}>{otherMember}</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="bg-gray-100 p-3.5 rounded-2xl">
                                    <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">å‚™è¨»</label>
                                    <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm" placeholder="é¸å¡«" value={formData.desc} onChange={(e) => setFormData({...formData, desc: e.target.value})} />
                                </div>
                            </div>
                            
                            <div className="flex gap-3 mt-8">
                                {!showConfirmDelete ? (
                                    <>
                                        <button disabled={isLoading} onClick={() => setShowConfirmDelete(true)} className="flex-1 py-4 bg-red-50 text-red-600 rounded-2xl font-black active:scale-95 transition-all flex items-center justify-center gap-1 disabled:opacity-30">
                                            <SvgIcon name="trash" size={18}/> åˆªé™¤
                                        </button>
                                        <button disabled={!formData.amount || formData.amount === '0' || isLoading} onClick={() => onSave(formData)} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black active:scale-95 transition-all shadow-lg shadow-blue-500/30 disabled:opacity-30">
                                            {isLoading ? "åŒæ­¥ä¸­..." : "å„²å­˜è®Šæ›´"}
                                        </button>
                                    </>
                                ) : (
                                    <div className="w-full animate-in bg-red-50 p-4 rounded-2xl text-center border border-red-100">
                                        <p className="text-red-600 font-black text-xs mb-3">ç¢ºå®šæ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setShowConfirmDelete(false)} className="flex-1 py-3 bg-white text-gray-600 rounded-xl font-black active:scale-95 border border-gray-200">ä¿ç•™</button>
                                            <button disabled={isLoading} onClick={() => onDelete(tx.id)} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-black active:scale-95 shadow-md shadow-red-500/20 disabled:opacity-30">ç¢ºèªåˆªé™¤</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [currentUser, setCurrentUser] = useState(null); 
            const [gasVersion, setGasVersion] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
            const [biometricAvailable, setBiometricAvailable] = useState(false);
            
            // æœ€å¾ŒåŒæ­¥æ™‚é–“ç‹€æ…‹ (å¾æœ¬åœ°è®€å–å¿«å–)
            const [lastSyncText, setLastSyncText] = useState(() => localStorage.getItem('last_sync_time_v15') || '----/--/-- --:--');

            // é›¢ç·šç·©å­˜éšŠåˆ—
            const [syncQueue, setSyncQueue] = useState(() => {
                const saved = localStorage.getItem('pending_sync_v15');
                return saved ? JSON.parse(saved) : [];
            });

            const [familyConfig, setFamilyConfig] = useState(() => {
                const saved = localStorage.getItem('family_member_config_v15');
                return saved ? JSON.parse(saved) : [
                    { name: 'çˆ¸çˆ¸', pin: '790115', color: 'bg-blue-600', bioEnabled: false },
                    { name: 'åª½åª½', pin: '791005', color: 'bg-pink-600', bioEnabled: false }
                ];
            });

            const myTransactions = useMemo(() => {
                if (!currentUser) return [];
                return transactions.filter(t => t.member === currentUser.name);
            }, [transactions, currentUser]);

            const recentDisplayTransactions = useMemo(() => {
                if (!currentUser) return [];
                return transactions.filter(t => t.member === currentUser.name || t.recorder === currentUser.name);
            }, [transactions, currentUser]);

            const stats = useMemo(() => {
                const income = myTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const expense = myTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                return { income, expense, balance: income - expense };
            }, [myTransactions]);

            const [pinInput, setPinInput] = useState("");
            const [selectingUser, setSelectingUser] = useState(null);
            
            // æ›´æ›å¯†ç¢¼ç›¸é—œç‹€æ…‹
            const [isChangingPin, setIsChangingPin] = useState(false);
            const [pinChangeStep, setPinChangeStep] = useState(1);
            const [tempPin, setTempPin] = useState("");
            const [newPinCache, setNewPinCache] = useState("");
            const [showChangelog, setShowChangelog] = useState(false);
            const [historyFilter, setHistoryFilter] = useState('all'); 
            
            // ç·¨è¼¯ç‹€æ…‹
            const [editingTx, setEditingTx] = useState(null);

            useEffect(() => {
                localStorage.setItem('pending_sync_v15', JSON.stringify(syncQueue));
                localStorage.setItem('family_member_config_v15', JSON.stringify(familyConfig));
                if (window.PublicKeyCredential) {
                    PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(v => setBiometricAvailable(v));
                }
                if (currentUser) syncCloud();
            }, [currentUser, familyConfig, syncQueue]);

            const showStatus = (type, text) => {
                setStatusMsg({ type, text });
                setTimeout(() => setStatusMsg({ type: '', text: '' }), 3500);
            };

            const syncCloud = async () => {
                if (isLoading) return;
                setIsLoading(true);
                try {
                    const res = await fetch(gasUrl);
                    const data = await res.json();
                    
                    const now = new Date();
                    const timeStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                    setLastSyncText(timeStr);
                    localStorage.setItem('last_sync_time_v15', timeStr);

                    if (data.gasVersion) setGasVersion(data.gasVersion);

                    // ğŸ”´ æ ¸å¿ƒä¿®å¾©ï¼šå¾å¾Œç«¯åŒæ­¥æœ€æ–°çš„æˆå“¡å¯†ç¢¼èˆ‡ç”Ÿç‰©è¾¨è­˜è¨­å®š
                    if (data.members && data.members.length > 0) {
                        setFamilyConfig(data.members);
                    }

                    const formatted = (data.transactions || []).map((t, i) => ({
                        id: t.id || i, // GAS å·²ç¶“ç¢ºä¿æœ‰ id
                        amount: parseFloat(t['é‡‘é¡']) || 0,
                        category: t['é¡åˆ¥'] || 'ä¸€èˆ¬',
                        date: t['æ—¥æœŸæ™‚é–“'] || t['æ—¥æœŸ'] || '',
                        member: t['æˆå“¡'] || 'æœªçŸ¥',
                        recorder: t['è¨˜éŒ„è€…'] || 'ç³»çµ±', 
                        desc: t['å‚™è¨»'] || '',
                        type: t['é¡å‹'] || 'expense'
                    }));
                    setTransactions(formatted);

                    if (syncQueue.length > 0 && navigator.onLine) await processOfflineQueue();
                } catch (err) { 
                    showStatus('error', 'é›¢ç·šä¸­ï¼Œè³‡æ–™å·²ä¿å­˜åœ¨æ‰‹æ©Ÿ'); 
                } finally { 
                    setIsLoading(false); 
                }
            };

            const processOfflineQueue = async () => {
                const queue = [...syncQueue];
                for (const tx of queue) {
                    try {
                        await fetch(gasUrl, { method: 'POST', body: JSON.stringify(tx), mode: 'no-cors' });
                        setSyncQueue(prev => prev.filter(q => q.id !== tx.id));
                    } catch (e) { break; }
                }
                showStatus('success', 'åŒæ­¥å®Œæˆ');
            };

            const handleAdd = async (newTx) => {
                setIsLoading(true);
                let finalDateStr;
                if (newTx.date) {
                    finalDateStr = newTx.date.replace('T', ' ').replace(/-/g, '/');
                } else {
                    const now = new Date();
                    finalDateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                }

                const completeTx = { ...newTx, date: finalDateStr, recorder: currentUser.name, id: Date.now() };
                setTransactions(prev => [...prev, completeTx]);
                
                try {
                    if (navigator.onLine) {
                        await fetch(gasUrl, { method: 'POST', body: JSON.stringify(completeTx), mode: 'no-cors' });
                        showStatus('success', 'ç´€éŒ„å„²å­˜æˆåŠŸ');
                        setTimeout(syncCloud, 1200);
                    } else {
                        setSyncQueue(prev => [...prev, completeTx]);
                        showStatus('info', 'å·²åŠ å…¥é›¢ç·šéšŠåˆ—');
                    }
                } catch (err) { 
                    setSyncQueue(prev => [...prev, completeTx]);
                    showStatus('info', 'è¨Šè™Ÿè¼ƒå¼±ï¼Œå·²ç·©å­˜');
                } finally { 
                    setIsLoading(false); 
                    setActiveTab('dashboard'); 
                }
            };

            // è™•ç†ç·¨è¼¯ç´€éŒ„
            const handleUpdateTx = async (updatedTx) => {
                setIsLoading(true);
                let finalDateStr = updatedTx.date;
                if (finalDateStr && finalDateStr.includes('T')) {
                    finalDateStr = finalDateStr.replace('T', ' ').replace(/-/g, '/');
                }
                
                // åŠ ä¸Š (å·²ç·¨è¼¯) çš„æˆ³è¨˜
                if (!finalDateStr.includes('(å·²ç·¨è¼¯)')) {
                    finalDateStr += ' (å·²ç·¨è¼¯)';
                }
                
                const txPayload = { ...updatedTx, date: finalDateStr, action: 'UPDATE_TX' };
                
                // æœ¬åœ°æ¨‚è§€æ›´æ–°
                setTransactions(prev => prev.map(t => t.id === updatedTx.id ? { ...txPayload, recorder: t.recorder } : t));
                setEditingTx(null);
                
                try {
                    if (navigator.onLine) {
                        await fetch(gasUrl, { method: 'POST', body: JSON.stringify(txPayload), mode: 'no-cors' });
                        showStatus('success', 'ç´€éŒ„å·²æ›´æ–°');
                        setTimeout(syncCloud, 1200);
                    } else {
                        setSyncQueue(prev => [...prev, txPayload]);
                        showStatus('info', 'å·²å­˜å…¥é›¢ç·šç·©å­˜');
                    }
                } catch (err) {
                    setSyncQueue(prev => [...prev, txPayload]);
                    showStatus('info', 'ç„¡ç¶²è·¯ï¼Œè®Šæ›´å·²ç·©å­˜');
                } finally {
                    setIsLoading(false);
                }
            };

            // è™•ç†åˆªé™¤ç´€éŒ„
            const handleDeleteTx = async (id) => {
                setIsLoading(true);
                const txPayload = { id, action: 'DELETE_TX' };
                
                // æœ¬åœ°æ¨‚è§€åˆªé™¤
                setTransactions(prev => prev.filter(t => t.id !== id));
                setEditingTx(null);
                
                try {
                    if (navigator.onLine) {
                        await fetch(gasUrl, { method: 'POST', body: JSON.stringify(txPayload), mode: 'no-cors' });
                        showStatus('success', 'ç´€éŒ„å·²åˆªé™¤');
                        setTimeout(syncCloud, 1200);
                    } else {
                        setSyncQueue(prev => [...prev, txPayload]);
                        showStatus('info', 'é›¢ç·šå¾…åˆªé™¤ä¸­');
                    }
                } catch (e) {
                    setSyncQueue(prev => [...prev, txPayload]);
                    showStatus('info', 'ç„¡ç¶²è·¯ï¼ŒæŒ‡ä»¤å·²ç·©å­˜');
                } finally {
                    setIsLoading(false);
                }
            };

            const handlePinChangeSubmit = (val) => {
                const next = tempPin + val;
                if (next.length <= 6) {
                    setTempPin(next);
                    if (next.length === 6) {
                        if (pinChangeStep === 1) {
                            if (next === currentUser.pin) { setPinChangeStep(2); setTempPin(""); } 
                            else { setTempPin(""); showStatus('error', 'ç›®å‰å¯†ç¢¼ä¸æ­£ç¢º'); }
                        } else if (pinChangeStep === 2) {
                            setNewPinCache(next); setPinChangeStep(3); setTempPin("");
                        } else if (pinChangeStep === 3) {
                            if (next === newPinCache) { handleUpdatePin(currentUser.name, next); } 
                            else { setTempPin(""); setPinChangeStep(2); showStatus('error', 'å…©æ¬¡è¼¸å…¥ä¸ç›¸ç¬¦'); }
                        }
                    }
                }
            };

            const handleUpdatePin = async (name, newPin) => {
                setIsLoading(true);
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'UPDATE_PIN', name, newPin }), mode: 'no-cors' });
                    setFamilyConfig(prev => prev.map(u => u.name === name ? { ...u, pin: newPin, bioEnabled: false } : u));
                    showStatus('success', 'å¯†ç¢¼æ›´æ–°æˆåŠŸ');
                    setCurrentUser(null);
                    setIsChangingPin(false);
                } catch (err) { showStatus('error', 'æ›´æ–°å¤±æ•—'); }
                finally { setIsLoading(false); }
            };

            const handleToggleBio = async () => {
                const willEnable = !currentUser.bioEnabled;
                if (willEnable) {
                    if (!window.PublicKeyCredential) { showStatus('error', 'ä¸æ”¯æ´ç”Ÿç‰©è¾¨è­˜'); return; }
                    try {
                        const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
                        const userID = new Uint8Array(16); window.crypto.getRandomValues(userID);
                        const cred = await navigator.credentials.create({
                            publicKey: { challenge, rp: { name: "å®¶åº­è¨˜å¸³" }, user: { id: userID, name: currentUser.name, displayName: currentUser.name }, pubKeyCredParams: [{ type: "public-key", alg: -7 }, { type: "public-key", alg: -257 }], authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" }, timeout: 60000 }
                        });
                        const base64Id = btoa(String.fromCharCode.apply(null, Array.from(new Uint8Array(cred.rawId))));
                        localStorage.setItem(`bio_cred_${currentUser.name}`, base64Id);
                        await updateBioState(currentUser.name, true);
                    } catch (err) { showStatus('error', 'é©—è­‰å¤±æ•—æˆ–å·²å–æ¶ˆ'); }
                } else {
                    localStorage.removeItem(`bio_cred_${currentUser.name}`);
                    await updateBioState(currentUser.name, false);
                }
            };

            const handleBioLogin = async () => {
                try {
                    const base64Id = localStorage.getItem(`bio_cred_${selectingUser.name}`);
                    if (!base64Id) { showStatus('info', 'è«‹å…ˆä½¿ç”¨å¯†ç¢¼ç™»å…¥ä¸¦é‡æ–°ç¶å®š'); return; }
                    const idStr = atob(base64Id); const idArray = new Uint8Array(idStr.length);
                    for (let i = 0; i < idStr.length; i++) idArray[i] = idStr.charCodeAt(i);
                    const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
                    await navigator.credentials.get({ publicKey: { challenge, allowCredentials: [{ type: "public-key", id: idArray }], userVerification: "required" } });
                    showStatus('success', 'è§£é–æˆåŠŸ'); setTimeout(() => { setCurrentUser(selectingUser); setSelectingUser(null); }, 600);
                } catch (err) { showStatus('error', 'æŒ‡ç´‹/è‡‰éƒ¨é©—è­‰å¤±æ•—'); }
            };

            // å„ªåŒ–å¾Œçš„ Date é¡¯ç¤ºï¼Œæœƒå®Œæ•´ä¿ç•™ (å·²ç·¨è¼¯) æ¨™è¨˜
            const displayDateClean = (val) => {
                if (!val) return '';
                let str = String(val).replace(/ä¸Šåˆ|ä¸‹åˆ|AM|PM/gi, '').trim();
                const isEdited = str.includes('(å·²ç·¨è¼¯)');
                str = str.replace(' (å·²ç·¨è¼¯)', '').replace('(å·²ç·¨è¼¯)', '');
                
                if (str.includes(':')) {
                    const parts = str.split(' ');
                    if (parts.length > 1) {
                        const cleaned = `${parts[0].replace(/-/g, '/')} ${parts[1].split(':').slice(0, 2).join(':')}`;
                        return isEdited ? cleaned + ' (å·²ç·¨è¼¯)' : cleaned;
                    } else if (str.includes('T')) {
                        const partsISO = str.split('T');
                        const cleaned = `${partsISO[0].replace(/-/g, '/')} ${partsISO[1].split(':').slice(0, 2).join(':')}`;
                        return isEdited ? cleaned + ' (å·²ç·¨è¼¯)' : cleaned;
                    }
                }
                const cleaned = str.replace(/-/g, '/');
                return isEdited ? cleaned + ' (å·²ç·¨è¼¯)' : cleaned;
            };

            const updateBioState = async (name, enabled) => {
                setIsLoading(true);
                try {
                    await fetch(gasUrl, { method: 'POST', body: JSON.stringify({ action: 'UPDATE_BIO', name, enabled }), mode: 'no-cors' });
                    setFamilyConfig(prev => prev.map(u => u.name === name ? { ...u, bioEnabled: enabled } : u));
                    showStatus('success', enabled ? 'ç”Ÿç‰©è¾¨è­˜å·²é–‹å•Ÿ' : 'å·²é—œé–‰');
                } catch (err) { showStatus('error', 'è¨­å®šå¤±æ•—'); }
                finally { setIsLoading(false); }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-8 animate-in relative w-full text-center font-black">
                        <div className="mb-12 text-white">
                            <div className="bg-blue-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-blue-500/30 text-white font-black"><SvgIcon name="wallet" size={36} /></div>
                            <h1 className="text-4xl font-black italic tracking-tighter">å®¶åº­è¨˜å¸³</h1>
                            <p className="text-gray-500 text-[10px] font-mono mt-4 opacity-50 uppercase tracking-[0.3em]">v{APP_VERSION}</p>
                        </div>
                        {!selectingUser ? (
                            <div className="grid grid-cols-1 gap-6 w-full max-w-xs text-white">
                                {familyConfig.map(user => (
                                    <button key={user.name} onClick={() => setSelectingUser(user)} className={`${user.color} py-6 rounded-[2.5rem] font-black text-2xl shadow-lg border-4 border-white/5 active:scale-95 transition-all text-white`}>{user.name}</button>
                                ))}
                            </div>
                        ) : (
                            <div className="w-full max-w-xs animate-in text-white text-center font-black">
                                <p className="font-black text-3xl mb-2 tracking-tight text-white">{selectingUser.name}</p>
                                <p className="text-gray-500 text-xs font-bold uppercase tracking-widest opacity-60 mb-8 font-black">é©—è­‰ 6 ä½å¯†ç¢¼</p>
                                <div className="flex justify-center gap-4 mb-10">
                                    {[...Array(6)].map((_, i) => (<div key={i} className={`w-3 h-3 rounded-full border-2 border-blue-500 transition-all duration-200 ${pinInput.length > i ? 'bg-blue-500 scale-125 shadow-[0_0_12px_#3b82f6]' : 'bg-transparent'}`}></div>))}
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-8 text-white">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'â†'].map(k => (
                                        <button key={k} onClick={() => {
                                            if (k === 'C') setPinInput(""); else if (k === 'â†') setPinInput(pinInput.slice(0, -1)); else {
                                                const n = pinInput + k; if (n.length <= 6) { setPinInput(n); if (n.length === 6) {
                                                    if (n === selectingUser.pin) { setCurrentUser(selectingUser); setSelectingUser(null); setPinInput(""); showStatus('success', 'æ­¡è¿å›ä¾†'); }
                                                    else { setPinInput(""); showStatus('error', 'å¯†ç¢¼ä¸æ­£ç¢º'); }
                                                } }
                                            }
                                        }} className="bg-white/10 h-16 rounded-3xl font-black text-2xl active:bg-blue-600 transition-all border border-white/5 text-white font-black">{k}</button>
                                    ))}
                                </div>
                                {biometricAvailable && (
                                    <div className="mb-8 p-5 bg-white/5 rounded-3xl border border-blue-500/20 text-left font-black">
                                        {selectingUser.bioEnabled ? (
                                            <button onClick={handleBioLogin} className="w-full py-4 bg-blue-600 text-white rounded-2xl flex items-center justify-center gap-3 font-black text-lg active:scale-95 transition shadow-xl font-black"><SvgIcon name="bio" size={24} /> ç”Ÿç‰©è¾¨è­˜è§£é–</button>
                                        ) : (
                                            <div>
                                                <div className="flex items-center gap-2 mb-1 text-blue-400 font-black uppercase tracking-widest text-[11px] font-black"><SvgIcon name="info" size={14} /><span>è§£é–æç¤º</span></div>
                                                <p className="text-[11px] text-gray-400 font-bold leading-relaxed font-black">å°šæœªé–‹å•Ÿç”Ÿç‰©è¾¨è­˜åŠŸèƒ½ã€‚<br/>è«‹ç™»å…¥å¾Œå‰å¾€ã€Œè¨­å®šã€é é¢é–‹å•Ÿã€‚</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                                <button onClick={() => {setSelectingUser(null); setPinInput("");}} className="text-gray-500 text-xs font-black uppercase tracking-widest underline underline-offset-4 active:text-blue-500 font-black">è¿”å›æˆå“¡åˆ—è¡¨</button>
                            </div>
                        )}
                        {statusMsg.text && <div className="fixed bottom-12 left-0 right-0 flex justify-center z-[200] pointer-events-none px-4 text-center font-black"><div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}><span className="text-sm font-bold tracking-tight text-center">{statusMsg.text}</span></div></div>}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 pb-28 max-w-md mx-auto relative flex flex-col overflow-x-hidden w-full text-left font-black">
                    {/* ç·¨è¼¯ç´€éŒ„ Modal */}
                    {editingTx && (
                        <EditTransactionModal 
                            tx={editingTx} 
                            categories={['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å±…å®¶', 'æ°´é›»', 'é†«ç™‚', 'è–ªè³‡', 'æŠ•è³‡', 'é›œé …']} 
                            loginUser={currentUser.name} 
                            onSave={handleUpdateTx} 
                            onDelete={handleDeleteTx}
                            onCancel={() => setEditingTx(null)}
                            isLoading={isLoading} 
                        />
                    )}

                    {/* Modals */}
                    {showChangelog && (
                        <div className="fixed inset-0 z-[300] bg-gray-900/90 backdrop-blur-md flex items-center justify-center p-8 animate-in text-gray-800 text-left font-black">
                            <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 relative font-black">
                                <button onClick={() => setShowChangelog(false)} className="absolute top-6 right-6 text-gray-400 active:scale-90 font-black"><SvgIcon name="close" size={24} /></button>
                                <h3 className="font-black text-xl mb-6 flex items-center gap-2 italic text-left text-gray-800 font-black"><SvgIcon name="info" size={20} className="text-blue-600 font-black" /> æ›´æ–°ç´€éŒ„</h3>
                                <div className="space-y-6 max-h-[60vh] overflow-y-auto scrollbar-hide text-[11px] font-black">
                                    {CHANGELOG.map(log => (<div key={log.version} className="border-l-2 border-blue-100 pl-4 py-1 text-gray-800 font-bold font-black">
                                        <div className="flex justify-between items-center mb-1 font-black"><span>v{log.version}</span><span className="font-bold text-gray-400 text-[10px] font-black">{log.date}</span></div>
                                        <p className="text-gray-500 leading-relaxed font-black">{log.note}</p>
                                    </div>))}
                                </div>
                            </div>
                        </div>
                    )}

                    {isChangingPin && (
                        <div className="fixed inset-0 z-[300] bg-gray-900/95 backdrop-blur-xl flex flex-col items-center justify-center p-8 animate-in text-white text-center font-black">
                            <button onClick={() => {setIsChangingPin(false); setTempPin(""); setPinChangeStep(1);}} className="absolute top-10 right-10 text-gray-400 active:scale-90 font-black"><SvgIcon name="close" size={32}/></button>
                            <div className="mb-10 font-black">
                                <div className="bg-blue-600/20 p-4 rounded-3xl mb-4 inline-block text-blue-500 font-black"><SvgIcon name="key" size={32}/></div>
                                <h2 className="text-2xl font-black text-white mb-2 font-black">
                                    {pinChangeStep === 1 ? 'è«‹è¼¸å…¥ç›®å‰å¯†ç¢¼' : pinChangeStep === 2 ? 'è«‹è¨­å®šæ–°å¯†ç¢¼' : 'è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼'}
                                </h2>
                                <p className="text-gray-400 text-xs font-bold font-black">
                                    {pinChangeStep === 1 ? 'ç‚ºäº†å®‰å…¨ï¼Œè«‹å…ˆé©—è­‰åŸæœ‰ 6 ä½æ•¸å¯†ç¢¼' : 'è«‹ç¢ºä¿é€™æ˜¯æ‚¨å®¹æ˜“è¨˜ä½çš„ 6 ä½æ•¸å­—'}
                                </p>
                            </div>
                            <div className="flex justify-center gap-4 mb-12 text-white font-black">
                                {[...Array(6)].map((_, i) => (<div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-blue-500 transition-all ${tempPin.length > i ? 'bg-blue-500 scale-125 shadow-[0_0_12px_#3b82f6]' : 'bg-transparent'}`}></div>))}
                            </div>
                            <div className="grid grid-cols-3 gap-4 w-full max-w-xs text-white font-black">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'â†'].map(k => (
                                    <button key={k} onClick={() => {
                                        if (k === 'C') setTempPin(""); else if (k === 'â†') setTempPin(tempPin.slice(0, -1)); 
                                        else handlePinChangeSubmit(k);
                                    }} className="bg-white/10 h-16 rounded-3xl font-black text-2xl active:bg-blue-600 transition-all border border-white/5 text-white font-black">{k}</button>
                                ))}
                            </div>
                        </div>
                    )}

                    <header className="px-6 pt-12 pb-6 bg-white sticky top-0 z-40 flex justify-between items-center border-b border-gray-100 shrink-0 text-gray-800 font-black">
                        <div className="flex items-center gap-3 text-left font-black"><div className={`${currentUser.color} w-10 h-10 rounded-2xl flex items-center justify-center text-white font-black shadow-lg shadow-blue-500/30 font-black`}>{currentUser.name.charAt(0)}</div><h1 className="text-2xl font-black tracking-tighter italic font-black">å®¶åº­è¨˜å¸³</h1></div>
                        <div className="flex items-center gap-3 font-black">
                            {/* æœ€å¾ŒåŒæ­¥æ™‚é–“ YYYY/MM/DD HH:mm */}
                            <div className="text-right leading-none font-black">
                                <p className="text-[7px] text-gray-300 uppercase font-black tracking-tighter mb-0.5 font-black">Last Sync</p>
                                <p className="text-[11px] text-blue-500 font-mono font-black">{lastSyncText}</p>
                            </div>
                            <div className="relative font-black">
                                <button onClick={syncCloud} className={`p-2.5 bg-gray-50 rounded-xl transition-all flex items-center justify-center active:scale-90 text-gray-600 font-black ${isLoading ? 'animate-spin text-blue-500' : ''}`}><SvgIcon name="refresh" size={20}/></button>
                                {syncQueue.length > 0 && (
                                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 border-2 border-white text-[8px] text-white flex items-center justify-center rounded-full shadow-md animate-bounce font-black">
                                        {syncQueue.length}
                                    </div>
                                )}
                            </div>
                            {/* ç™»å‡ºæŒ‰éˆ• */}
                            <button onClick={() => setCurrentUser(null)} className="p-2.5 bg-red-50 text-red-500 rounded-xl active:scale-90 transition-all flex items-center justify-center font-black"><SvgIcon name="logout" size={20}/></button>
                        </div>
                    </header>

                    <main className="p-6 flex-1 overflow-y-auto scrollbar-hide text-gray-800 font-black">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in font-black text-gray-800">
                                <div className="bg-gray-900 p-8 rounded-[3rem] shadow-2xl text-white relative overflow-hidden text-center text-gray-400 font-black">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-[60px] rounded-full font-black"></div>
                                    <span className="text-[10px] font-black uppercase mb-3 block tracking-widest font-black">æœ¬æœˆä¼°ç®—çµé¤˜</span>
                                    <div className="text-5xl font-black mb-8 tracking-tighter tabular-nums text-white font-black">${stats.balance.toLocaleString()}</div>
                                    <div className="flex w-full gap-4 pt-6 border-t border-white/5 font-black text-sm text-gray-300 font-black">
                                        <div className="flex-1 text-center font-black"><p className="text-[9px] uppercase mb-1 font-black">æ”¶å…¥</p><p className="text-xl text-green-400 font-black">+${stats.income.toLocaleString()}</p></div>
                                        <div className="flex-1 border-l border-white/5 text-center font-black"><p className="text-[9px] uppercase mb-1 font-black">æ”¯å‡º</p><p className="text-xl text-red-400 font-black">-${stats.expense.toLocaleString()}</p></div>
                                    </div>
                                </div>
                                <div className="space-y-4 text-left font-black">
                                    <h3 className="font-black text-lg px-1 font-black">æœ€è¿‘å‹•æ…‹</h3>
                                    <div className="space-y-3 font-black">
                                        {recentDisplayTransactions.slice(-5).reverse().map(tx => {
                                            const isForOthers = tx.recorder === currentUser.name && tx.member !== currentUser.name;
                                            const isReceivedFromOthers = tx.member === currentUser.name && tx.recorder !== currentUser.name;
                                            const badgeMember = isForOthers ? tx.member : null;

                                            return (
                                                <div key={tx.id} className="bg-white p-4 rounded-3xl border border-gray-100 flex items-center gap-4 shadow-sm active:bg-gray-50 transition-colors text-left font-black">
                                                    <div className="relative font-black">
                                                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center font-black text-[17px] shrink-0 leading-none ${tx.type === 'income' ? 'bg-green-600 text-white shadow-lg font-black' : 'bg-red-600 text-white shadow-lg font-black'}`}>{tx.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</div>
                                                        {badgeMember && (
                                                            <div className={`absolute -top-1 -right-1 w-6 h-6 rounded-full border-2 border-white shadow-md flex items-center justify-center text-[10px] text-white font-black ${badgeMember === 'åª½åª½' ? 'bg-pink-500' : 'bg-blue-500'} font-black`}>
                                                                {badgeMember.charAt(0)}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex-1 min-w-0 font-black">
                                                        <div className="flex items-center gap-2 font-bold text-base truncate font-black text-gray-800 text-left font-black">{tx.category}</div>
                                                        <div className="text-[10px] text-gray-400 mt-1 font-medium text-left font-black">
                                                            {isReceivedFromOthers ? `ç”±${tx.recorder}è¨˜ Â· ` : (isForOthers ? `å¹«${tx.member}è¨˜ Â· ` : '')}{displayDateClean(tx.date)}
                                                        </div>
                                                    </div>
                                                    <div className={`font-black tabular-nums text-lg shrink-0 ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'} font-black`}>${Number(tx.amount).toLocaleString()}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'add' && <AddTransactionForm categories={['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å±…å®¶', 'æ°´é›»', 'é†«ç™‚', 'è–ªè³‡', 'æŠ•è³‡', 'é›œé …']} loginUser={currentUser.name} onSubmit={handleAdd} isLoading={isLoading} />}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-in pb-20 text-left font-black">
                                <div className="flex justify-between items-center ml-1 pr-1 font-black">
                                    <h3 className="font-black text-lg font-black">æ­·å²å¸³ç›®ç´€éŒ„</h3>
                                    <div className="flex bg-gray-200 p-1 rounded-xl gap-1 font-black">
                                        <button onClick={() => setHistoryFilter('all')} className={`px-3 py-1.5 text-[11px] font-black rounded-lg transition-all ${historyFilter === 'all' ? 'bg-white shadow-sm text-gray-900 font-black' : 'text-gray-500 font-black'}`}>å…¨éƒ¨</button>
                                        <button onClick={() => setHistoryFilter('income')} className={`px-3 py-1.5 text-[11px] font-black rounded-lg transition-all ${historyFilter === 'income' ? 'bg-white shadow-sm text-green-600 font-black' : 'text-gray-500 font-black'}`}>æ”¶å…¥</button>
                                        <button onClick={() => setHistoryFilter('expense')} className={`px-3 py-1.5 text-[11px] font-black rounded-lg transition-all ${historyFilter === 'expense' ? 'bg-white shadow-sm text-red-600 font-black' : 'text-gray-500 font-black'}`}>æ”¯å‡º</button>
                                    </div>
                                </div>
                                <div className="space-y-2.5 text-gray-800 font-black text-left font-black">
                                    {myTransactions.slice().reverse().filter(tx => historyFilter === 'all' || tx.type === historyFilter).map(tx => {
                                        const isReceivedFromOthers = tx.member === currentUser.name && tx.recorder !== currentUser.name;
                                        return (
                                            <div key={tx.id} className="bg-white p-4 rounded-[1.5rem] border border-gray-100 flex justify-between items-center shadow-sm font-black text-left font-black">
                                                <div className="flex gap-4 items-center min-w-0 text-left font-black">
                                                    <div className={`w-14 h-14 rounded-xl flex items-center justify-center font-black text-[17px] shrink-0 leading-none ${tx.type === 'income' ? 'bg-green-600 text-white shadow-lg font-black' : 'bg-red-600 text-white shadow-lg font-black'}`}>{tx.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</div>
                                                    <div className="min-w-0 font-black text-left text-gray-800 font-black">
                                                        <div className="flex items-center gap-2 font-bold text-base truncate font-black text-gray-800 text-left font-black">{tx.category}</div>
                                                        <div className="text-[10px] text-gray-400 block truncate font-medium mt-1 text-left font-black">
                                                            {isReceivedFromOthers ? `ç”±${tx.recorder}è¨˜ Â· ` : ''}{displayDateClean(tx.date)}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* å³å´ï¼šé‡‘é¡èˆ‡ç·¨è¼¯æŒ‰éˆ•å¹³è¡Œæ’åˆ— */}
                                                <div className="flex items-center shrink-0 gap-2 font-black">
                                                    <span className={`font-black tabular-nums text-lg ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'} font-black`}>${Number(tx.amount).toLocaleString()}</span>
                                                    <button onClick={() => setEditingTx(tx)} className="text-gray-400 bg-gray-50 p-2 rounded-xl active:scale-95 transition-all flex items-center justify-center font-black border border-gray-100 hover:text-blue-500 hover:bg-blue-50">
                                                        <SvgIcon name="edit" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        {activeTab === 'settings' && (
                            <div className="space-y-4 animate-in text-left pb-20 text-gray-800 font-black font-black">
                                <div className="bg-white p-6 rounded-[2rem] border shadow-sm border-gray-100 font-black font-black">
                                    <h3 className="font-black text-xs mb-6 uppercase flex items-center gap-2 text-gray-800 tracking-widest px-1 font-black font-black"><SvgIcon name="user" size={16} className="text-blue-500 font-black font-black" /> å®‰å…¨èˆ‡å¸³æˆ¶ç®¡ç†</h3>
                                    <div className="space-y-3 text-left font-black text-gray-800 font-black font-black">
                                        <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left font-black font-black"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left leading-none font-black font-black">ä½¿ç”¨èº«ä»½</p><p className="font-black text-gray-800 text-base leading-none mt-1 font-black font-black">{currentUser.name}</p></div><button onClick={() => {setIsChangingPin(true); setPinChangeStep(1);}} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all font-black font-black">æ›´æ›å¯†ç¢¼</button></div>
                                        <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 text-left font-black font-black"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left leading-none font-black font-black">ç”Ÿç‰©è¾¨è­˜ / è£ç½®è§£é–</p><p className="font-black text-gray-800 text-sm leading-none mt-1 font-black font-black">{currentUser.bioEnabled ? 'å·²é–‹å•Ÿ' : 'å°šæœªé–‹å•Ÿ'}</p></div><button onClick={handleToggleBio} className={`px-4 py-2 rounded-xl font-black text-xs active:scale-95 transition-all ${currentUser.bioEnabled ? 'bg-red-50 text-red-600 border border-red-100 font-black font-black' : 'bg-green-600 text-white shadow-lg font-black font-black'}`}>{currentUser.bioEnabled ? 'é—œé–‰' : 'é–‹å•Ÿ'}</button></div>
                                        <div onClick={() => setShowChangelog(true)} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 cursor-pointer active:bg-gray-100 transition-colors font-black text-gray-800 leading-none font-black font-black"><div><p className="text-gray-400 text-[10px] font-black uppercase mb-1 text-left font-black font-black">App ç‰ˆæœ¬</p><p className="font-mono font-bold leading-none mt-1 text-gray-800 font-black font-black">v{APP_VERSION}</p></div><div className="bg-white p-2 rounded-lg border border-gray-200 text-gray-400 active:scale-90 font-black font-black"><SvgIcon name="info" size={16} /></div></div>
                                        <div className="flex justify-between p-4 bg-gray-50 rounded-2xl text-[11px] font-bold text-gray-400 text-left font-black font-black"><span>é›²ç«¯ç‹€æ…‹</span><span className="text-green-600 font-black flex items-center gap-1 font-black font-black"><SvgIcon name="check" size={10}/> å·²åŒæ­¥</span></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/90 backdrop-blur-md rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl border border-white/20 safe-bottom font-black font-black font-black">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'dashboard' ? 'text-blue-600 bg-blue-50 shadow-inner font-black font-black' : 'text-gray-400 font-black font-black'}`}><SvgIcon name="chart" /></button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'history' ? 'text-blue-600 bg-blue-50 shadow-inner font-black font-black' : 'text-gray-400 font-black font-black'}`}><SvgIcon name="history" /></button>
                        <button onClick={() => setActiveTab('add')} className={`w-16 h-16 flex items-center justify-center rounded-[1.5rem] shadow-xl active:scale-90 transition-all font-black font-black ${activeTab === 'add' ? 'bg-blue-700 text-white rotate-45 shadow-blue-200 font-black' : 'bg-gray-900 text-white font-black font-black'}`}><SvgIcon name="plus" size={32} /></button>
                        <div className="flex-1 font-black font-black font-black"></div>
                        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all font-black font-black ${activeTab === 'settings' ? 'text-blue-600 bg-blue-50 shadow-inner font-black font-black' : 'text-gray-400 font-black font-black'}`}><SvgIcon name="settings" /></button>
                    </nav>

                    {/* ç½®ä¸­æç¤ºæ¡† */}
                    {statusMsg.text && (
                        <div className="fixed bottom-28 left-0 right-0 flex justify-center z-[400] pointer-events-none px-4 text-center font-black font-black font-black">
                            <div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === 'success' ? 'bg-green-600 text-white font-black font-black' : (statusMsg.type === 'error' ? 'bg-red-600 text-white font-black font-black' : 'bg-blue-600 text-white font-black font-black')}`}><span className="text-sm font-bold tracking-tight text-center font-black font-black font-black">{statusMsg.text}</span></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
