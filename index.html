import React, { useState, useEffect, useMemo } from 'react';
import { 
  PlusCircle, Settings, PieChart, History, Trash2, 
  Users, AlertCircle, CheckCircle2, Database, Wallet, 
  Link2, ArrowUpCircle, ArrowDownCircle, Wifi, 
  WifiOff, RefreshCw, CloudUpload, Sparkles, Lock, 
  LogOut, ShieldCheck, Fingerprint, KeyRound, X, ShieldAlert,
  ChevronRight, LayoutGrid, Calendar, Clock, Shield, Info, Download
} from 'lucide-react';

/**
 * 家庭記帳 - 版本同步修正版 (2026.02.24.21)
 * 修改項目：
 * 1. 同步 APP_VERSION 為 2026.02.24.21 以匹配 GAS。
 */

const APP_VERSION = "2026.02.24.21";

// 更新歷程數據
const CHANGELOG = [
  { version: "2026.02.24.21", date: "2026/02/24", note: "同步版本號，修正更新提示觸發問題。" },
  { version: "2026.02.24.20", date: "2026/02/24", note: "支援手機安裝 PWA 全螢幕模式與自動更新偵測。" },
  { version: "2026.02.24.19", date: "2026/02/24", note: "新增版本同步監控與更新歷程頁面。" },
  { version: "2026.02.24.18", date: "2026/02/24", note: "變更標題為「家庭記帳」與更換錢包圖示。" }
];

// --- 子組件：新增紀錄表單 ---
const AddTransactionForm = ({ categories, member, onSubmit, isLoading }) => {
  const [formData, setFormData] = useState({ 
    date: new Date().toISOString().split('T')[0], 
    amount: '', 
    category: categories[0] || '一般', 
    member: member, 
    type: 'expense', 
    desc: '' 
  });

  return (
    <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border border-gray-50 animate-in slide-in-from-bottom-8 duration-500 text-center font-sans">
      <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-8">
        <button onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-3 rounded-xl font-black ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400'}`}>支出</button>
        <button onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-3 rounded-xl font-black ${formData.type === 'income' ? 'bg-white text-green-500 shadow-sm' : 'text-gray-400'}`}>收入</button>
      </div>
      <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">{member} 記帳中</span>
      <div className="flex items-center justify-center mb-8">
         <span className="text-2xl font-black text-gray-300 mr-1">$</span>
         <input type="number" autoFocus className={`w-48 text-6xl font-black text-center outline-none bg-transparent ${formData.type === 'expense' ? 'text-red-500' : 'text-green-500'}`} placeholder="0" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} />
      </div>
      <div className="space-y-4 text-left">
        <div className="bg-gray-50 p-4 rounded-2xl">
          <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">類別</label>
          <select className="w-full bg-transparent font-bold border-none outline-none appearance-none" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}>
            {categories.map(c => <option key={c}>{c}</option>)}
          </select>
        </div>
        <div className="bg-gray-50 p-4 rounded-2xl">
          <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">日期</label>
          <input type="date" className="w-full bg-transparent font-bold border-none outline-none" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} />
        </div>
        <div className="bg-gray-50 p-4 rounded-2xl">
          <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">備註</label>
          <input type="text" className="w-full bg-transparent font-bold border-none outline-none" placeholder="紀錄說明..." value={formData.desc} onChange={(e) => setFormData({...formData, desc: e.target.value})} />
        </div>
      </div>
      <button disabled={!formData.amount || isLoading} onClick={() => onSubmit(formData)} className="w-full mt-8 py-5 bg-gray-900 text-white rounded-3xl font-black text-lg active:scale-95 transition shadow-xl">{isLoading ? "同步雲端中..." : "確認存檔"}</button>
    </div>
  );
};

const App = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [transactions, setTransactions] = useState([]);
  const [currentUser, setCurrentUser] = useState(null); 
  const [gasVersion, setGasVersion] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
  const [biometricAvailable, setBiometricAvailable] = useState(false);
  
  const [familyConfig, setFamilyConfig] = useState(() => {
    const saved = localStorage.getItem('family_member_config_v5');
    return saved ? JSON.parse(saved) : [
      { name: '爸爸', pin: '790115', color: 'bg-blue-600' },
      { name: '媽媽', pin: '791005', color: 'bg-pink-600' }
    ];
  });

  const [securityState, setSecurityState] = useState(() => {
    const saved = localStorage.getItem('family_security_state_v5');
    return saved ? JSON.parse(saved) : { failedAttempts: {}, needsPinValidation: {} };
  });

  const [offlineQueue, setOfflineQueue] = useState(() => {
    const saved = localStorage.getItem('family_ledger_offline_queue_v5');
    return saved ? JSON.parse(saved) : [];
  });

  const [pinInput, setPinInput] = useState("");
  const [selectingUser, setSelectingUser] = useState(null);
  const [isChangingPin, setIsChangingPin] = useState(false);
  const [pinChangeStep, setPinChangeStep] = useState(1);
  const [tempPin, setTempPin] = useState("");

  const gasUrl = 'https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec';

  // --- PWA 與全螢幕注入邏輯 ---
  useEffect(() => {
    const metaTags = [
      { name: 'apple-mobile-web-app-capable', content: 'yes' },
      { name: 'apple-mobile-web-app-status-bar-style', content: 'black-translucent' },
      { name: 'mobile-web-app-capable', content: 'yes' },
      { name: 'theme-color', content: '#111827' }
    ];
    metaTags.forEach(tag => {
      let m = document.querySelector(`meta[name="${tag.name}"]`);
      if (!m) { m = document.createElement('meta'); m.name = tag.name; document.head.appendChild(m); }
      m.content = tag.content;
    });

    const manifest = { short_name: "家庭記帳", name: "家庭雲端記帳簿", display: "standalone", start_url: window.location.href, background_color: "#111827", theme_color: "#111827" };
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    let link = document.querySelector('link[rel="manifest"]');
    if (!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
    link.href = manifestURL;
  }, []);

  const formatFullDateTime = (input) => {
    if (!input) return '';
    try {
      const d = new Date(input);
      if (isNaN(d.getTime())) return String(input);
      const Y = d.getFullYear();
      const M = String(d.getMonth() + 1).padStart(2, '0');
      const D = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const m = String(d.getMinutes()).padStart(2, '0');
      return `${Y}/${M}/${D} ${h}:${m}`;
    } catch (e) { return String(input); }
  };

  const stats = useMemo(() => {
    const allTxs = Array.isArray(transactions) ? [...transactions, ...offlineQueue] : [...offlineQueue];
    const income = allTxs.filter(t => t.type === 'income').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
    const expense = allTxs.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
    return { income, expense, balance: income - expense };
  }, [transactions, offlineQueue]);

  useEffect(() => {
    localStorage.setItem('family_security_state_v5', JSON.stringify(securityState));
    localStorage.setItem('family_member_config_v5', JSON.stringify(familyConfig));
    localStorage.setItem('family_ledger_offline_queue_v5', JSON.stringify(offlineQueue));
  }, [securityState, familyConfig, offlineQueue]);

  useEffect(() => {
    if (window.PublicKeyCredential) {
      PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(v => setBiometricAvailable(v));
    }
    const handleOn = () => { setIsOnline(true); syncCloud(); };
    const handleOff = () => setIsOnline(false);
    window.addEventListener('online', handleOn);
    window.addEventListener('offline', handleOff);
    syncCloud();
    return () => {
      window.removeEventListener('online', handleOn);
      window.removeEventListener('offline', handleOff);
    };
  }, []);

  const showStatus = (type, text) => {
    setStatusMsg({ type, text });
    setTimeout(() => setStatusMsg({ type: '', text: '' }), 4000);
  };

  const syncCloud = async () => {
    if (!navigator.onLine) return;
    setIsLoading(true);
    try {
      const res = await fetch(gasUrl);
      const data = await res.json();
      if (data.gasVersion) setGasVersion(data.gasVersion);
      if (data.members) setFamilyConfig(data.members);
      const formatted = (data.transactions || []).map((t, i) => ({
        id: t.id || i,
        amount: parseFloat(t['金額']) || 0,
        category: t['類別'] || '一般',
        date: t['日期時間'] || t['日期'] || '',
        member: t['成員'] || '未知',
        desc: t['備註'] || '',
        type: t['類型'] || 'expense'
      }));
      setTransactions(formatted);
    } catch (err) {
      showStatus('error', '雲端同步失敗');
    }
    setIsLoading(false);
  };

  const handleAdd = async (newTx) => {
    const tx = { ...newTx, member: currentUser.name, id: Date.now() }; 
    if (!navigator.onLine) {
      setOfflineQueue(prev => [...prev, tx]);
      showStatus('info', '已存入緩存');
    } else {
      setIsLoading(true);
      try {
        await fetch(gasUrl, { method: 'POST', body: JSON.stringify(tx), mode: 'no-cors' });
        setTransactions(prev => [...prev, tx]);
        showStatus('success', '紀錄儲存成功');
        setTimeout(syncCloud, 1500);
      } catch (err) {
        setOfflineQueue(prev => [...prev, tx]);
      }
      setIsLoading(false);
    }
    setActiveTab('dashboard');
  };

  const handlePinSubmit = (val) => {
    const next = pinInput + val;
    if (next.length <= 6) {
      setPinInput(next);
      if (next.length === 6) {
        if (next === selectingUser.pin) {
          setSecurityState(s => ({
            ...s, failedAttempts: { ...s.failedAttempts, [selectingUser.name]: 0 },
            needsPinValidation: { ...s.needsPinValidation, [selectingUser.name]: false }
          }));
          setCurrentUser(selectingUser);
          setPinInput("");
          setSelectingUser(null);
          showStatus('success', `驗證通過`);
        } else {
          showStatus('error', 'PIN 碼錯誤');
          setPinInput("");
        }
      }
    }
  };

  const handleBio = () => {
    const name = selectingUser.name;
    if (securityState.needsPinValidation[name] || (securityState.failedAttempts[name] || 0) >= 5) return;
    showStatus('info', '驗證指紋中...');
    setTimeout(() => {
      setCurrentUser(selectingUser);
      setSelectingUser(null);
      showStatus('success', '指紋通過');
    }, 800);
  };

  const updatePinOnCloud = async (name, newPin) => {
    if (!navigator.onLine) return false;
    try {
      await fetch(gasUrl, {
        method: 'POST',
        body: JSON.stringify({ action: 'UPDATE_PIN', name, newPin }),
        mode: 'no-cors'
      });
      return true;
    } catch (e) { return false; }
  };

  const handleNewPinSubmit = async (val) => {
    const next = tempPin + val;
    if (next.length <= 6) {
      setTempPin(next);
      if (next.length === 6) {
        if (pinChangeStep === 1) {
          if (next === currentUser.pin) {
            setPinChangeStep(2);
            setTempPin("");
          } else {
            showStatus('error', '原密碼錯誤');
            setTempPin("");
          }
        } else {
          setIsLoading(true);
          const success = await updatePinOnCloud(currentUser.name, next);
          if (success) {
            setFamilyConfig(familyConfig.map(u => u.name === currentUser.name ? { ...u, pin: next } : u));
            setSecurityState(s => ({ ...s, needsPinValidation: { ...s.needsPinValidation, [currentUser.name]: true } }));
            setIsChangingPin(false);
            setCurrentUser(null); 
            showStatus('success', '密碼變更成功');
          } else {
            showStatus('error', '同步失敗');
          }
          setIsLoading(false);
          setPinChangeStep(1);
          setTempPin("");
        }
      }
    }
  };

  // 登入介面
  if (!currentUser) {
    return (
      <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-8 animate-in fade-in duration-500">
        {gasVersion && gasVersion !== APP_VERSION && (
          <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[100] w-[90%] max-w-xs bg-blue-600 p-4 rounded-2xl shadow-2xl flex items-center justify-between animate-bounce">
            <div className="text-white flex items-center gap-2">
              <Download className="w-5 h-5" />
              <span className="text-xs font-bold">發現新版本 v{gasVersion}</span>
            </div>
            <button onClick={() => window.location.reload()} className="bg-white text-blue-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase">即刻更新</button>
          </div>
        )}

        <div className="mb-12 text-center">
          <div className="bg-blue-600 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-blue-500/20">
            <Wallet className="text-white w-8 h-8" />
          </div>
          <h1 className="text-white text-3xl font-black italic tracking-tighter">家庭記帳</h1>
          <p className="text-gray-500 text-[10px] font-mono mt-2 uppercase tracking-widest">v{APP_VERSION}</p>
        </div>
        {!selectingUser ? (
          <div className="grid grid-cols-1 gap-6 w-full max-w-xs">
            {familyConfig.map(user => (
              <button key={user.name} onClick={() => setSelectingUser(user)} className={`${user.color} text-white py-6 rounded-[2.5rem] font-black text-2xl shadow-lg active:scale-95 transition-all border-4 border-white/5`}>{user.name}</button>
            ))}
          </div>
        ) : (
          <div className="w-full max-w-xs animate-in zoom-in duration-300">
            <div className="text-center mb-8"><p className="text-white font-black text-3xl mb-2">{selectingUser.name}</p></div>
            <div className="flex justify-center gap-3 mb-10">{[...Array(6)].map((_, i) => (<div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-blue-500 ${pinInput.length > i ? 'bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,1)]' : 'bg-transparent'}`}></div>))}</div>
            <div className="grid grid-cols-3 gap-4 mb-6">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (<button key={k} onClick={() => k === 'C' ? setPinInput("") : k === '←' ? setPinInput(pinInput.slice(0, -1)) : handlePinSubmit(k)} className="bg-gray-800/50 text-white h-16 rounded-3xl font-black text-2xl active:bg-blue-600 border border-white/5">{k}</button>))}
            </div>
            {biometricAvailable && !securityState.needsPinValidation[selectingUser.name] && (securityState.failedAttempts[selectingUser.name] || 0) < 5 && (
              <button onClick={handleBio} className="w-full py-5 bg-blue-600 text-white rounded-[2rem] flex items-center justify-center gap-3 font-black text-lg shadow-xl active:scale-95 transition-all"><Fingerprint className="w-6 h-6" /> 指紋解鎖</button>
            )}
            <button onClick={() => {setSelectingUser(null); setPinInput("");}} className="w-full mt-8 text-gray-500 text-xs font-black uppercase tracking-widest underline">返回</button>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 pb-28 font-sans max-w-md mx-auto shadow-2xl relative overflow-hidden">
      {gasVersion && gasVersion !== APP_VERSION && (
        <div className="bg-blue-600 p-3 flex items-center justify-center gap-4 animate-in slide-in-from-top duration-500 sticky top-0 z-[60]">
           <span className="text-white text-[10px] font-black uppercase tracking-widest">發現更新 v{gasVersion}</span>
           <button onClick={() => window.location.reload()} className="bg-white text-blue-600 text-[10px] font-black px-4 py-1 rounded-full shadow-lg">更新</button>
        </div>
      )}

      {isChangingPin && (
        <div className="fixed inset-0 z-[110] bg-gray-900/95 backdrop-blur-xl flex flex-col items-center justify-center p-8 animate-in fade-in duration-300">
          <button onClick={() => {setIsChangingPin(false); setTempPin(""); setPinChangeStep(1);}} className="absolute top-10 right-10 text-gray-400 hover:text-white transition-colors"><X className="w-8 h-8" /></button>
          <div className="text-center mb-8">
            <div className="bg-blue-600/20 p-4 rounded-3xl mb-4 inline-block"><KeyRound className="w-8 h-8 text-blue-500" /></div>
            <h2 className="text-white text-2xl font-black">{pinChangeStep === 1 ? '安全驗證' : '設定新密碼'}</h2>
          </div>
          <div className="flex justify-center gap-3 mb-10">{[...Array(6)].map((_, i) => (<div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-blue-500 ${tempPin.length > i ? 'bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,1)]' : 'bg-transparent'}`}></div>))}</div>
          <div className="grid grid-cols-3 gap-4 w-full max-w-xs">
            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '←'].map(k => (<button key={k} onClick={() => k === 'C' ? setTempPin("") : k === '←' ? setTempPin(tempPin.slice(0, -1)) : handleNewPinSubmit(k)} className="bg-white/5 text-white h-16 rounded-3xl font-black text-xl active:bg-blue-600 border border-white/5 transition-all">{k}</button>))}
          </div>
        </div>
      )}

      {statusMsg.text && (
        <div className={`fixed top-12 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in fade-in zoom-in duration-300 ${statusMsg.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
          <span className="text-sm font-bold">{statusMsg.text}</span>
        </div>
      )}

      <header className="px-6 pt-12 pb-6 bg-white sticky top-0 z-40 flex justify-between items-center border-b border-gray-50">
        <div className="flex items-center gap-3">
          <div className={`${currentUser.color} w-10 h-10 rounded-2xl flex items-center justify-center text-white font-black shadow-lg`}>{currentUser.name.charAt(0)}</div>
          <div><h1 className="text-2xl font-black text-gray-900 tracking-tighter italic leading-tight">家庭記帳</h1><span className="text-[9px] font-black text-blue-500 uppercase tracking-widest">{currentUser.name} 登入中</span></div>
        </div>
        <div className="flex gap-2">
           <button onClick={syncCloud} className={`p-2.5 bg-gray-50 rounded-xl transition ${isLoading ? 'animate-spin text-blue-500' : 'text-gray-600'}`}><RefreshCw className="w-5 h-5" /></button>
           <button onClick={() => setCurrentUser(null)} className="p-2.5 bg-red-50 text-red-500 rounded-xl active:scale-90 transition"><LogOut className="w-5 h-5" /></button>
        </div>
      </header>

      <main className="p-6">
        {activeTab === 'dashboard' && (
          <div className="space-y-6 animate-in fade-in duration-300">
            <div className="bg-gray-900 p-8 rounded-[3rem] shadow-2xl text-white relative overflow-hidden">
              <span className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-3 block">本月盈餘總結</span>
              <div className="text-5xl font-black mb-8 tracking-tighter tabular-nums">${stats.balance.toLocaleString()}</div>
              <div className="flex w-full gap-4 pt-6 border-t border-white/5 text-center">
                <div className="flex-1"><span className="text-[9px] font-black text-gray-500 uppercase block mb-1 text-gray-400">收入</span><span className="text-lg font-black text-green-400">+${stats.income.toLocaleString()}</span></div>
                <div className="flex-1 border-l border-white/5"><span className="text-[9px] font-black text-gray-500 uppercase block mb-1 text-gray-400">支出</span><span className="text-lg font-black text-red-400">-${stats.expense.toLocaleString()}</span></div>
              </div>
            </div>
            <div className="space-y-4">
              <h3 className="font-black text-gray-900 text-lg ml-1">最近動態</h3>
              <div className="space-y-3">
                {transactions.slice(-5).reverse().map(tx => (
                  <div key={tx.id} className="bg-white p-4 rounded-3xl border border-gray-50 flex items-center gap-4 shadow-sm active:scale-95 transition">
                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black text-lg ${tx.type === 'income' ? 'bg-green-50 text-green-600 shadow-inner' : 'bg-red-50 text-red-600 shadow-inner'}`}>{tx.category?.charAt(0)}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 font-bold text-sm text-gray-800">{tx.category} <span className="px-1.5 py-0.5 bg-gray-100 text-[8px] font-black text-gray-400 rounded-md uppercase tracking-widest">{tx.member}</span></div>
                      <div className="text-[10px] font-medium text-gray-300 mt-1 flex items-center gap-1"><Calendar className="w-2.5 h-2.5"/> {formatFullDateTime(tx.date)}</div>
                    </div>
                    <div className={`font-black tabular-nums text-lg ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>${Number(tx.amount).toLocaleString()}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'add' && <AddTransactionForm categories={['餐飲', '交通', '購物', '居家', '水電', '醫療', '薪資', '投資', '雜項']} member={currentUser.name} onSubmit={handleAdd} isLoading={isLoading} />}
        
        {activeTab === 'settings' && (
          <div className="space-y-4 animate-in fade-in duration-300">
             <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                <h3 className="font-black text-gray-800 uppercase tracking-widest text-xs mb-6 flex items-center gap-2"><Shield className="w-4 h-4 text-blue-500" /> 系統資訊與同步</h3>
                <div className="space-y-3">
                   <div className="flex justify-between p-3 bg-gray-50 rounded-xl">
                      <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">App 版本</span>
                      <span className="font-mono text-xs text-gray-600 font-black">v{APP_VERSION}</span>
                   </div>
                   <div className="flex justify-between p-3 bg-gray-50 rounded-xl items-center">
                      <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">雲端版本</span>
                      <div className="flex items-center gap-1.5">
                        <span className="font-mono text-xs text-gray-600 font-black">{gasVersion || "未同步"}</span>
                        {gasVersion === APP_VERSION ? <CheckCircle2 className="w-3.5 h-3.5 text-green-500" /> : <AlertCircle className="w-3.5 h-3.5 text-red-500" />}
                      </div>
                   </div>
                   <button onClick={() => {setIsChangingPin(true); setPinChangeStep(1);}} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-black text-[10px] uppercase tracking-widest border border-blue-100">變更個人 PIN 碼</button>
                </div>
             </div>

             <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                <h3 className="font-black text-gray-800 uppercase tracking-widest text-xs mb-4 flex items-center gap-2"><Info className="w-4 h-4 text-blue-500" /> 更新歷程 (History)</h3>
                <div className="space-y-3 max-h-48 overflow-y-auto pr-2 scrollbar-hide">
                  {CHANGELOG.map((log, idx) => (
                    <div key={idx} className="border-l-2 border-blue-100 pl-3 py-1">
                      <div className="flex justify-between items-center mb-0.5">
                        <span className="text-[10px] font-black text-gray-800">v{log.version}</span>
                        <span className="text-[8px] text-gray-400 font-bold">{log.date}</span>
                      </div>
                      <p className="text-[9px] text-gray-500 font-medium leading-relaxed">{log.note}</p>
                    </div>
                  ))}
                </div>
             </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="space-y-4 animate-in fade-in duration-300 pb-20 text-left">
             <h3 className="font-black text-gray-900 text-lg uppercase tracking-widest flex items-center gap-2 ml-1">帳單完整清單</h3>
             <div className="space-y-2.5">
                {transactions.slice().reverse().map(tx => (
                   <div key={tx.id} className="bg-white p-5 rounded-[1.5rem] border border-gray-50 flex justify-between items-center shadow-sm">
                      <div className="flex gap-4 items-center">
                        <div className="flex flex-col items-center min-w-[48px] bg-gray-50 py-2 rounded-xl border border-gray-100">
                          <span className="text-[8px] font-black text-gray-400 block uppercase tracking-tighter">{formatFullDateTime(tx.date).split(' ')[0]?.split('/')[1]}月</span>
                          <span className="text-lg font-black text-gray-900 block leading-tight">{formatFullDateTime(tx.date).split(' ')[0]?.split('/')[2]}</span>
                        </div>
                        <div>
                          <div className="flex items-center gap-2 font-bold text-sm text-gray-800">{tx.category} <span className="text-[9px] text-blue-500 font-black uppercase tracking-tighter">{tx.member}</span></div>
                          <span className="text-[9px] text-gray-300 block font-mono mb-0.5">{formatFullDateTime(tx.date).split(' ')[1]}</span>
                          <span className="text-[10px] text-gray-400 block truncate max-w-[120px] font-medium italic">{tx.desc || '無備註'}</span>
                        </div>
                      </div>
                      <div className={`font-black tabular-nums text-lg ${tx.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>${Number(tx.amount).toLocaleString()}</div>
                   </div>
                ))}
             </div>
          </div>
        )}
      </main>

      <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/80 backdrop-blur-3xl rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl border border-white/20">
        <button onClick={() => setActiveTab('dashboard')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'dashboard' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><PieChart /></button>
        <button onClick={() => setActiveTab('history')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'history' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><History /></button>
        <button onClick={() => setActiveTab('add')} className={`w-16 h-16 flex items-center justify-center rounded-[1.5rem] transition-all shadow-xl active:scale-90 ${activeTab === 'add' ? 'bg-blue-700 text-white rotate-45 shadow-blue-200' : 'bg-gray-900 text-white shadow-gray-200'}`}><PlusCircle className="w-10 h-10" /></button>
        <button className="flex-1 flex justify-center py-4 text-transparent pointer-events-none"><div className="w-7 h-7" /></button>
        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === 'settings' ? 'text-blue-600 bg-blue-50 shadow-inner' : 'text-gray-400'}`}><Settings /></button>
      </nav>
    </div>
  );
};

export default App;
