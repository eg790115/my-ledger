<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>家庭記帳</title>

  <!-- PWA / Theme -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111827">

  <!-- 動態 Manifest -->
  <script>
    const manifestJSON = {
      "name": "家庭記帳",
      "short_name": "記帳",
      "display": "standalone",
      "start_url": ".",
      "background_color": "#111827",
      "theme_color": "#111827",
      "icons": [{
        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z'/%3E%3C/svg%3E",
        "sizes": "512x512",
        "type": "image/svg+xml"
      }]
    };
    const blob = new Blob([JSON.stringify(manifestJSON)], { type: 'application/manifest+json' });
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = URL.createObjectURL(blob);
    document.head.appendChild(manifestLink);
  </script>

  <!-- ✅ 必要 CDN：React / ReactDOM / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
      -webkit-tap-highlight-color: transparent;
      background-color: #111827;
      margin: 0;
      overflow-x: hidden;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .animate-in { animation: fadeIn 0.25s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    #root { min-height: 100vh; display: flex; flex-direction: column; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- ✅ React 一定要有 root -->
  <div id="root"></div>

  <script type="text/babel">
    console.log("BABEL BOOT OK");

    const { useEffect, useMemo, useState } = React;

    // ✅ 你的 GAS /exec
    const gasUrl = "https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec";

    // ✅ 這串要跟 GAS 的 APP_SECRET 一模一樣
    const APP_SECRET = "0970220807";

    const LS = {
      pending: "pending_sync_v16",
      txCache: "local_tx_cache_v16",
      lastSync: "last_sync_time_v16",
      sessionToken: "session_token_v16",
      sessionExp: "session_exp_v16",
      lastUser: "last_login_user_v16",
    };

    const nowStr = () => {
      const d = new Date();
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    const safeParse = (s, fallback) => {
      try { return JSON.parse(s); } catch { return fallback; }
    };

    async function postGAS(payload) {
      const res = await fetch(gasUrl, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });
      return await res.json();
    }

    function App() {
      const [online, setOnline] = useState(navigator.onLine);
      const [pending, setPending] = useState(() => safeParse(localStorage.getItem(LS.pending), []));
      const [txCache, setTxCache] = useState(() => safeParse(localStorage.getItem(LS.txCache), []));
      const [lastSync, setLastSync] = useState(localStorage.getItem(LS.lastSync) || "----/--/-- --:--");

      const [user, setUser] = useState(localStorage.getItem(LS.lastUser) || null);
      const [pin, setPin] = useState("");
      const [sessionToken, setSessionToken] = useState(localStorage.getItem(LS.sessionToken) || "");
      const [sessionExp, setSessionExp] = useState(Number(localStorage.getItem(LS.sessionExp) || 0));

      const [status, setStatus] = useState("");

      useEffect(() => {
        const onOn = () => setOnline(true);
        const onOff = () => setOnline(false);
        window.addEventListener("online", onOn);
        window.addEventListener("offline", onOff);
        return () => {
          window.removeEventListener("online", onOn);
          window.removeEventListener("offline", onOff);
        };
      }, []);

      useEffect(() => localStorage.setItem(LS.pending, JSON.stringify(pending)), [pending]);
      useEffect(() => localStorage.setItem(LS.txCache, JSON.stringify(txCache)), [txCache]);

      const sessionValid = useMemo(() => sessionToken && sessionExp && Date.now() < sessionExp, [sessionToken, sessionExp]);

      const addOffline = () => {
        const item = {
          id: Date.now(),
          action: "ADD_TX",
          member: user || "爸爸",
          type: "expense",
          amount: 100,
          category: "餐飲",
          desc: "離線測試",
          date: nowStr(),
          recorder: user || "離線",
        };
        setPending(p => [...p, item]);
        setStatus("已暫存 1 筆（待同步）");
      };

      const login = async () => {
        if (!online) { setStatus("離線：無法雲端登入，但可先新增暫存"); return; }
        if (!user || !pin) { setStatus("請選成員並輸入 PIN"); return; }
        setStatus("登入中...");
        try {
          const data = await postGAS({ secret: APP_SECRET, action: "AUTH_LOGIN", name: user, pin });
          if (data.result !== "success") throw new Error(data.message || "登入失敗");
          setSessionToken(data.sessionToken);
          setSessionExp(Number(data.sessionExp));
          localStorage.setItem(LS.sessionToken, data.sessionToken);
          localStorage.setItem(LS.sessionExp, String(data.sessionExp));
          localStorage.setItem(LS.lastUser, user);
          setStatus("登入成功（已取得 session）");
          setPin("");
        } catch (e) {
          setStatus("登入失敗：" + (e.message || e));
        }
      };

      const fetchCloud = async () => {
        if (!online) { setStatus("離線：無法抓雲端"); return; }
        if (!sessionValid) { setStatus("請先登入（或 session 過期）"); return; }
        setStatus("抓取雲端資料中...");
        try {
          const data = await postGAS({ secret: APP_SECRET, action: "GET_TX", sessionToken });
          if (data.result !== "success") throw new Error(data.message || "GET_TX 失敗");
          const formatted = (data.transactions || []).map((t, i) => ({
            id: t.id || i,
            amount: parseFloat(t["金額"]) || 0,
            category: t["類別"] || "一般",
            date: t["日期時間"] || "",
            member: t["成員"] || "",
            desc: t["備註"] || "",
            type: t["類型"] || "expense",
          }));
          setTxCache(formatted);
          const ts = nowStr();
          setLastSync(ts);
          localStorage.setItem(LS.lastSync, ts);
          setStatus("雲端抓取成功");
        } catch (e) {
          setStatus("抓取失敗：" + (e.message || e));
        }
      };

      return (
        <div className="min-h-screen bg-gray-900 text-white p-6 flex flex-col gap-4">
          <div className="bg-white/10 rounded-3xl p-5 border border-white/10 animate-in">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-2xl font-black italic">家庭記帳</div>
                <div className="text-xs text-white/60 mt-1">狀態：{online ? "線上" : "離線"} · 待同步 {pending.length} · 最後同步 {lastSync}</div>
              </div>
              <div className={`px-3 py-1 rounded-xl text-xs font-black ${sessionValid ? "bg-green-500/20 text-green-200" : "bg-yellow-500/20 text-yellow-200"}`}>
                {sessionValid ? "已登入" : "未登入"}
              </div>
            </div>
          </div>

          <div className="bg-white rounded-3xl p-5 text-gray-900 animate-in">
            <div className="text-sm font-black text-gray-700 mb-3">成員登入（線上才可驗證）</div>
            <div className="flex gap-2 mb-3">
              {["爸爸","媽媽"].map(n => (
                <button key={n} onClick={() => setUser(n)} className={`flex-1 py-3 rounded-2xl font-black ${user===n ? "bg-blue-600 text-white" : "bg-gray-100 text-gray-500"}`}>
                  {n}
                </button>
              ))}
            </div>
            <input value={pin} onChange={(e)=>setPin(e.target.value)} maxLength={6} inputMode="numeric"
              placeholder="輸入 6 位 PIN"
              className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-3" />
            <div className="flex gap-2">
              <button onClick={login} className="flex-1 py-3 rounded-2xl bg-gray-900 text-white font-black">登入</button>
              <button onClick={fetchCloud} className="flex-1 py-3 rounded-2xl bg-blue-600 text-white font-black">抓雲端</button>
            </div>
          </div>

          <div className="bg-white rounded-3xl p-5 text-gray-900 animate-in">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-black text-gray-700">離線暫存（可先新增）</div>
              <button onClick={addOffline} className="px-4 py-2 rounded-2xl bg-gray-900 text-white font-black text-sm">+ 新增測試暫存</button>
            </div>
            {pending.length === 0 ? (
              <div className="text-sm text-gray-500">目前沒有暫存</div>
            ) : (
              <div className="space-y-2">
                {pending.slice().reverse().slice(0,5).map(x => (
                  <div key={x.id} className="bg-gray-100 rounded-2xl p-3 text-sm">
                    <div className="font-black">{x.member} · {x.category} · ${x.amount}</div>
                    <div className="text-gray-500 text-xs mt-1">{x.date} · {x.desc}</div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {status && (
            <div className="fixed bottom-10 left-0 right-0 flex justify-center px-4">
              <div className="bg-black/70 text-white px-5 py-3 rounded-2xl text-sm font-black border border-white/10">
                {status}
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
