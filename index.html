<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>家庭記帳</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#111827" />

  <script>
    const manifestJSON = {
      "name": "家庭記帳",
      "short_name": "記帳",
      "display": "standalone",
      "start_url": ".",
      "background_color": "#111827",
      "theme_color": "#111827",
      "icons": [{
        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z'/%3E%3C/svg%3E",
        "sizes": "512x512",
        "type": "image/svg+xml"
      }]
    };
    const blob = new Blob([JSON.stringify(manifestJSON)], { type: 'application/manifest+json' });
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = URL.createObjectURL(blob);
    document.head.appendChild(manifestLink);
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      background-color: #111827;
      margin: 0;
      overflow-x: hidden;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .animate-in { animation: fadeIn 0.2s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes cursor-blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .animate-cursor { animation: cursor-blink 1s step-end infinite; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    #root { min-height: 100vh; display:flex; flex-direction:column; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 text-left font-black">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    const gasUrl = "https://script.google.com/macros/s/AKfycbxJNnUlFXK8NZ9vaIUvRkq8Njy17P3IlETr_AbkCQhycZ2XUbAnaXvd_7QCT5BQR5zCLA/exec";
    
    // 版本升級至 V21：完美解決同步後白屏問題 (資料格式安全轉換)
    const APP_VERSION = "2026.02.28.PRO.V21";
    const GAS_TARGET_VERSION = "2026.02.28.PRO.V7";

    const LS = {
      pending: "pending_sync_v25",
      txCache: "local_tx_cache_v25",
      historyCache: "local_history_cache_v25",
      lastSync: "last_sync_time_v25",
      members: "family_member_config_v25",
      deviceToken: "device_token_v1",
      deviceExp: "device_exp_v1",
      pinHashPrefix: "pin_hash_v25_",
      bioCredPrefix: "bio_cred_",
      bioFailPrefix: "bio_fail_v1_", 
      bioLockPrefix: "bio_lock_v1_",
      greetingsCache: "greetings_cache_v1" 
    };

    const CATEGORY_MAP = {
      expense: {
        "食": ["早餐", "午餐", "晚餐", "生鮮食材", "零食/飲料", "外食聚餐", "其他"],
        "衣": ["爸爸服飾", "媽媽服飾", "小孩服飾", "鞋包/配件", "保養/美妝", "其他"],
        "居家": ["房貸", "管理費", "水費", "電費", "瓦斯費", "網路/電信", "家具/家電", "日用品", "房屋稅/地價稅", "其他"],
        "行": ["大眾運輸", "計程車/共享", "加油", "停車費", "保養維修", "牌照/燃料稅", "eTag/過路費", "其他"],
        "教育": ["學校學費", "安親/才藝班", "教材/文具", "童書/玩具", "零用錢", "其他"],
        "娛樂": ["國內旅遊", "國外旅遊", "串流訂閱", "運動健身", "聚會活動", "電影/展覽", "其他"],
        "醫療": ["保健食品", "診所門診", "牙醫/眼科", "醫美", "住院", "其他"],
        "理財": ["股票/ETF", "定期定額", "基金", "儲蓄險", "外匯", "加密貨幣", "其他"],
        "其他": ["保險費", "孝親費", "紅白包", "捐款/贈與", "雜項"]
      },
      income: {
        "收入": ["爸爸薪資", "媽媽薪資", "獎金", "投資收益", "利息", "其他收入"]
      }
    };

    // 極致安全的字串提取函數，防止 Cannot read properties of undefined 報錯
    const getParentCat = (catStr) => {
      if (!catStr || typeof catStr !== 'string') return "其他";
      if (catStr.includes('/')) return catStr.split('/')[0];
      const legacyMap = {"餐飲":"食", "交通":"行", "購物":"衣", "住":"居家", "水電":"居家", "育":"教育", "樂":"娛樂", "薪資":"收入", "投資":"理財", "雜項":"其他"};
      return legacyMap[catStr] || "其他";
    };
    
    const getChildCat = (catStr) => {
      if (!catStr || typeof catStr !== 'string') return "其他";
      return catStr.includes('/') ? catStr.substring(catStr.indexOf('/') + 1) : catStr;
    };

    const BEN_OPTIONS = ["爸爸", "媽媽", "兒子", "其他"];
    
    const formatBen = (benStr, memberName) => {
      if (!benStr) return memberName || "";
      const arr = benStr.split(",").filter(Boolean);
      if (arr.length === 0) return memberName || "";
      if (arr.length === 3 && arr.includes("爸爸") && arr.includes("媽媽") && arr.includes("兒子")) return "全家共同";
      if (arr.length === 1 && arr[0] === memberName) return memberName; 
      return arr.join("、");
    };

    const safeParse = (raw, fallback) => {
      if (raw === null || raw === "null" || raw === "undefined" || raw === "") return fallback;
      try { const parsed = JSON.parse(raw); return parsed !== null ? parsed : fallback; } catch { return fallback; } 
    };
    const safeArrayLS = (key) => { const raw = localStorage.getItem(key); const v = safeParse(raw, []); return Array.isArray(v) ? v : []; };
    const safeStringLS = (key, fallback="") => { const v = localStorage.getItem(key); return (v === null || v === "null" || v === "undefined") ? fallback : v; };
    const safeNumberLS = (key, fallback=0) => { const v = Number(localStorage.getItem(key)); return Number.isFinite(v) ? v : fallback; };

    // 核心資料翻譯機：將 GAS 的中文 Header 快照轉為 Frontend 的英文變數，消滅白屏
    const normalizeSnapshot = (snapStr) => {
      if (!snapStr) return {};
      let obj = {};
      try { obj = JSON.parse(snapStr); } catch(e) { return {}; }
      
      if (obj['類別']) {
        return {
          date: obj['日期時間'] || obj['日期'] || "",
          category: obj['類別'] || "其他",
          amount: parseFloat(obj['金額']) || 0,
          member: obj['成員'] || "未知",
          desc: obj['備註'] || "",
          type: obj['類型'] || "expense",
          recorder: obj['記錄者'] || "系統",
          id: obj['ID'] || "",
          groupId: obj['GroupID'] || "",
          parentDesc: obj['ParentDesc'] || "",
          beneficiary: obj['Beneficiary'] || ""
        };
      }
      return obj; // 如果已經是英文結構就直接回傳
    };

    const parseDateForSort = (val) => {
      if (!val) return 0;
      let str = String(val).replace(/上午|下午|AM|PM/gi, "").trim().replace(/ \(已編輯\)/g, "").replace(/\(已編輯\)/g, "").replace(/-/g, "/").replace("T", " ");
      return new Date(str).getTime() || 0;
    };

    const displayDateClean = (val) => {
      if (!val) return "";
      let str = String(val).replace(/上午|下午|AM|PM/gi, "").trim().replace(/ \(已編輯\)/g, "").replace(/\(已編輯\)/g, "").replace(/-/g, "/").replace("T", " ");
      const parts = str.split(" ");
      return parts.length > 1 ? `${parts[0]} ${parts[1].split(":").slice(0,2).join(":")}` : str;
    };

    const nowStr = () => {
      const d = new Date();
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    async function postGAS(payload) {
      const res = await fetch(gasUrl, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
      return await res.json();
    }

    const getDeviceToken = () => safeStringLS(LS.deviceToken, "");
    const getDeviceExp = () => safeNumberLS(LS.deviceExp, 0);
    const deviceValid = () => !!(getDeviceToken() && getDeviceExp() && Date.now() < getDeviceExp());
    const setDeviceToken = (t, exp) => { localStorage.setItem(LS.deviceToken, t); localStorage.setItem(LS.deviceExp, String(exp)); };
    const clearDeviceToken = () => { localStorage.removeItem(LS.deviceToken); localStorage.removeItem(LS.deviceExp); };

    async function sha256Base64(str) {
      const enc = new TextEncoder(); const data = enc.encode(str);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const bytes = new Uint8Array(digest); let bin = "";
      for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    }

    const getBioKey = (name) => `${LS.bioCredPrefix}${name}`;
    const isDeviceBioBound = (name) => !!localStorage.getItem(getBioKey(name));
    const getBioFailKey = (name) => `${LS.bioFailPrefix}${name}`;
    const getBioLockKey = (name) => `${LS.bioLockPrefix}${name}`;
    const getBioFailCount = (name) => safeNumberLS(getBioFailKey(name), 0);
    const setBioFailCount = (name, v) => localStorage.setItem(getBioFailKey(name), String(v));
    const getBioLockedUntil = (name) => safeNumberLS(getBioLockKey(name), 0);
    const setBioLockedUntil = (name, ts) => localStorage.setItem(getBioLockKey(name), String(ts));
    const clearBioFail = (name) => { setBioFailCount(name, 0); setBioLockedUntil(name, 0); };

    const idbInit = () => new Promise((res, rej) => {
      const req = indexedDB.open("FamilyAppDB", 3);
      req.onupgradeneeded = e => e.target.result.createObjectStore("store");
      req.onsuccess = () => res(req.result);
      req.onerror = () => rej(req.error);
    });
    const idbSet = async (k, v) => { const db = await idbInit(); return new Promise(res => { const tx = db.transaction("store", "readwrite"); tx.objectStore("store").put(v, k); tx.oncomplete = res; }); };
    const idbGet = async (k) => { const db = await idbInit(); return new Promise(res => { const tx = db.transaction("store", "readonly"); const req = tx.objectStore("store").get(k); req.onsuccess = () => res(req.result); req.onerror = () => res(null); }); };

    const SvgIcon = ({ name, size = 24, className = "" }) => {
      const icons = {
        home: <React.Fragment><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></React.Fragment>,
        pieChart: <React.Fragment><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></React.Fragment>,
        wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z"/>,
        plus: <path d="M12 5v14m-7-7h14"/>,
        history: <React.Fragment><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 12h6"/><path d="M9 16h6"/><path d="M9 8h6"/></React.Fragment>,
        chart: <React.Fragment><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></React.Fragment>,
        search: <React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></React.Fragment>,
        settings: (<React.Fragment><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></React.Fragment>),
        logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5l-5-5m5 5H9"/>,
        refresh: <React.Fragment><path d="M17.5 19a5.5 5.5 0 0 0 0-11h-1.3b11a7 7 0 1 0-11.9 4.3"/><path d="m11 15 2 2 4-4"/></React.Fragment>,
        bio: <React.Fragment><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></React.Fragment>,
        close: <path d="M18 6L6 18M6 6l12 12"/>,
        info: <React.Fragment><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></React.Fragment>,
        check: <path d="M20 6L9 17l-5-5"/>,
        edit: <React.Fragment><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></React.Fragment>,
        trash: <React.Fragment><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></React.Fragment>,
        layers: <React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>,
        filter: <React.Fragment><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></React.Fragment>,
        cloud: <React.Fragment><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></React.Fragment>,
        clock: <React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={`shrink-0 aspect-square ${className}`}>
          {icons[name] || <circle cx="12" cy="12" r="10" />}
        </svg>
      );
    };

    const ViewEditHistoryModal = ({ tx, onClose }) => {
      const history = tx.editHistory || [];
      return (
        <div className="fixed inset-0 z-[700] bg-gray-900/90 backdrop-blur-sm flex flex-col items-center justify-center p-6 animate-in font-black text-left" onClick={(e) => { if(e.target === e.currentTarget) onClose(); }}>
          <div className="w-full max-w-sm bg-white rounded-[2.5rem] p-6 relative max-h-[80vh] overflow-y-auto shadow-2xl scrollbar-hide">
            <button onClick={onClose} className="absolute top-6 right-6 text-gray-400 active:scale-90"><SvgIcon name="close" size={24} /></button>
            <h2 className="text-xl font-black text-gray-800 mb-6 flex items-center gap-2"><SvgIcon name="clock" size={20} className="text-blue-600"/> 編輯紀錄</h2>
            
            <div className="space-y-4 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-gray-200 before:to-transparent">
              <div className="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                <div className="flex items-center justify-center w-10 h-10 rounded-full border-4 border-white bg-blue-100 text-blue-600 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 relative z-10">
                  <span className="text-[10px]">目前</span>
                </div>
                <div className="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-4 rounded-2xl border border-blue-200 shadow-sm bg-blue-50/50">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-[9px] font-black text-blue-600 bg-blue-100 px-2 py-0.5 rounded-md">最新狀態</span>
                  </div>
                  <div className="font-bold text-sm text-gray-800">{getParentCat(tx.category)} - {getChildCat(tx.category)}</div>
                  <div className="text-[10px] text-gray-500 my-1">對象: {formatBen(tx.beneficiary, tx.member)}</div>
                  <div className="font-black text-lg text-blue-600">${Number(tx.amount).toLocaleString()}</div>
                  {tx.desc && <div className="text-[10px] text-gray-500 mt-1">{tx.desc}</div>}
                </div>
              </div>

              {history.map((h, i) => {
                const snap = normalizeSnapshot(h.snapshot);
                return (
                  <div key={i} className="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group">
                    <div className="flex items-center justify-center w-10 h-10 rounded-full border-4 border-white bg-gray-100 text-gray-400 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 relative z-10">
                      <span className="text-[10px]">V{history.length - i}</span>
                    </div>
                    <div className="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-4 rounded-2xl border border-gray-100 shadow-sm bg-white">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-[9px] font-black text-gray-500 bg-gray-100 px-2 py-0.5 rounded-md">{displayDateClean(h.timestamp)}</span>
                      </div>
                      <div className="font-bold text-sm text-gray-600 opacity-70">{getParentCat(snap.category)} - {getChildCat(snap.category)}</div>
                      <div className="text-[10px] text-gray-400 my-1">對象: {formatBen(snap.beneficiary, snap.member)}</div>
                      <div className="font-black text-lg text-gray-500">${Number(snap.amount || 0).toLocaleString()}</div>
                      {snap.desc && <div className="text-[10px] text-gray-400 mt-1">{snap.desc}</div>}
                      <div className="text-[9px] text-gray-400 mt-2 border-t border-gray-100 pt-2 text-right">由 {h.editor} {h.action === 'DELETE' ? '刪除' : '修改'}</div>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        </div>
      )
    };

    const CategorySelectPair = ({ type, parentCat, childCat, onChange }) => {
      const pCats = Object.keys(CATEGORY_MAP[type] || CATEGORY_MAP.expense);
      const safeParentCat = pCats.includes(parentCat) ? parentCat : pCats[0];
      const cCats = CATEGORY_MAP[type][safeParentCat] || CATEGORY_MAP[type][pCats[0]];

      return (
        <div className="flex gap-2">
          <div className="bg-gray-100 p-2 px-3 rounded-xl flex-1 border border-transparent focus-within:border-blue-200 transition-colors">
            <label className="text-[8px] font-black text-blue-500 uppercase block mb-0.5 tracking-widest">主類別</label>
            <select className="w-full bg-transparent border-none outline-none appearance-none font-black text-sm text-gray-800"
              value={safeParentCat} onChange={(e) => onChange(e.target.value, CATEGORY_MAP[type][e.target.value][0])}>
              {pCats.map(p => <option key={p} value={p}>{p}</option>)}
            </select>
          </div>
          <div className="bg-gray-100 p-2 px-3 rounded-xl flex-1 border border-transparent focus-within:border-blue-200 transition-colors">
            <label className="text-[8px] font-black text-blue-500 uppercase block mb-0.5 tracking-widest">子項目</label>
            <select className="w-full bg-transparent border-none outline-none appearance-none font-black text-sm text-gray-800"
              value={childCat} onChange={(e) => onChange(safeParentCat, e.target.value)}>
              {cCats.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
        </div>
      );
    };

    const AddTransactionForm = ({ loginUser, onSubmit, isLoading }) => {
      const inputRef = useRef(null);
      const [isFocused, setIsFocused] = useState(false);
      const [isSplit, setIsSplit] = useState(false);
      
      const [formData, setFormData] = useState({
        amount: "", parentCat: "食", childCat: "晚餐", member: loginUser, beneficiary: [loginUser],
        type: "expense", desc: "", parentTitle: "", parentDesc: "", date: ""
      });

      const [subItems, setSubItems] = useState([
        { id: Date.now(), parentCat: "食", childCat: "晚餐", amount: "", desc: "", beneficiary: [loginUser] }
      ]);

      const otherMember = loginUser === "爸爸" ? "媽媽" : "爸爸";
      const dynamicBenOptions = [loginUser, ...BEN_OPTIONS.filter(b => b !== loginUser)];

      useEffect(() => { 
        setFormData(prev => ({ ...prev, member: loginUser || prev.member, beneficiary: [loginUser || prev.member] })); 
        setSubItems(prev => prev.map(s => ({...s, beneficiary: [loginUser || prev.member]})));
      }, [loginUser]);

      const handleTypeChange = (newType) => {
        const defaultP = newType === "expense" ? "食" : "收入";
        const defaultC = CATEGORY_MAP[newType][defaultP][0];
        setFormData(prev => ({ ...prev, type: newType, parentCat: defaultP, childCat: defaultC }));
        setSubItems(prev => prev.map(s => ({ ...s, parentCat: defaultP, childCat: defaultC })));
      };

      const toggleBeneficiary = (b) => {
        if (formData.beneficiary.includes(b)) {
           if (formData.beneficiary.length > 1) setFormData({...formData, beneficiary: formData.beneficiary.filter(x => x !== b)});
        } else setFormData({...formData, beneficiary: [...formData.beneficiary, b]});
      };

      const toggleSubBeneficiary = (id, b) => {
        setSubItems(subItems.map(s => {
          if (s.id !== id) return s;
          const newBen = s.beneficiary.includes(b) 
              ? (s.beneficiary.length > 1 ? s.beneficiary.filter(x => x !== b) : s.beneficiary)
              : [...s.beneficiary, b];
          return { ...s, beneficiary: newBen };
        }));
      };

      const totalSplitAmount = useMemo(() => subItems.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0), [subItems]);

      const renderAmount = () => {
        if (isSplit) return totalSplitAmount === 0 ? "0" : totalSplitAmount.toString();
        const val = formData.amount;
        if (isFocused) return (val === "" || val === "0") ? <span className="text-gray-300 animate-cursor">_</span> : val;
        return (val === "" || val === "0") ? "0" : val;
      };

      const handleAddSubItem = () => {
        const defaultP = formData.type === "expense" ? "食" : "收入";
        const defaultC = CATEGORY_MAP[formData.type][defaultP][0];
        setSubItems([...subItems, { id: Date.now(), parentCat: defaultP, childCat: defaultC, amount: "", desc: "", beneficiary: [formData.member] }]);
      };

      const handleRemoveSubItem = (id) => { if (subItems.length > 1) setSubItems(subItems.filter(s => s.id !== id)); };
      const updateSubItem = (id, updates) => { setSubItems(prev => prev.map(s => s.id === id ? { ...s, ...updates } : s)); };

      const submitForm = () => {
        if (isSplit) {
          const validSubs = subItems.filter(s => Number(s.amount) > 0);
          if (validSubs.length === 0) return;
          const combinedParentDesc = `${formData.parentTitle.trim() || "多筆紀錄"}|||${formData.parentDesc.trim()}`;
          const multipleTxs = validSubs.map(s => ({
            amount: s.amount, category: `${s.parentCat}/${s.childCat}`,
            member: formData.member, beneficiary: s.beneficiary.join(","),
            type: formData.type, desc: s.desc, date: formData.date, parentDesc: combinedParentDesc
          }));
          onSubmit(multipleTxs);
        } else {
          onSubmit([{ ...formData, category: `${formData.parentCat}/${formData.childCat}`, beneficiary: formData.beneficiary.join(",") }]);
        }
      };

      const isSubmitDisabled = (isSplit ? totalSplitAmount === 0 : (!formData.amount || formData.amount === "0"));

      return (
        <div className="bg-white p-6 rounded-[2.5rem] shadow-xl border border-gray-100 animate-in text-center relative font-black pb-8">
          <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-6 text-sm text-gray-500">
            <button onClick={() => handleTypeChange("expense")} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === "expense" ? "bg-white text-red-500 shadow-sm font-black" : ""}`}>支出</button>
            <button onClick={() => handleTypeChange("income")} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === "income" ? "bg-white text-green-500 shadow-sm font-black" : ""}`}>收入</button>
          </div>

          <div className="relative flex flex-col items-center justify-center mb-6 py-2 min-h-[80px] text-gray-800">
            {isSplit && <span className="text-[10px] text-gray-400 uppercase tracking-widest font-black mb-1">自動加總金額</span>}
            <div className="flex items-center justify-center cursor-pointer" onClick={() => !isSplit && inputRef.current?.focus()}>
              <span className="text-2xl font-black text-gray-300 mr-1 mt-2">$</span>
              <div className={`text-6xl font-black text-center min-w-[1.5rem] tracking-tighter transition-colors ${formData.type === "expense" ? "text-red-500" : "text-green-500"}`}>
                {renderAmount()}
              </div>
              {!isSplit && (
                <input ref={inputRef} type="number" inputMode="decimal" className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer font-black"
                  value={formData.amount} onFocus={() => setIsFocused(true)} onBlur={() => setIsFocused(false)} onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                />
              )}
            </div>
          </div>

          <div className="space-y-4 text-left">
            <div className="bg-gray-100 p-3 rounded-2xl flex items-center justify-between">
              <span className="text-xs font-black text-gray-600 pl-2">拆分多筆明細 (如單張發票)</span>
              <button onClick={() => setIsSplit(!isSplit)} className={`w-12 h-6 rounded-full p-1 transition-colors duration-200 ease-in-out ${isSplit ? 'bg-blue-500' : 'bg-gray-300'}`}>
                <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-200 ease-in-out ${isSplit ? 'translate-x-6' : 'translate-x-0'}`}></div>
              </button>
            </div>

            <div className="bg-gray-100 py-1.5 px-3 rounded-xl flex items-center justify-between border border-transparent focus-within:border-blue-200 transition-colors">
              <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">時間</label>
              <input type="datetime-local" className="bg-transparent font-black border-none outline-none text-gray-800 text-xs max-w-[160px] w-full text-right"
                value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} />
            </div>

            {!isSplit && (
              <>
                <div className="bg-gray-50 py-2 px-3 rounded-xl border border-gray-100 flex flex-wrap items-center justify-between gap-2">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mr-2 shrink-0">對象</label>
                  <div className="flex gap-1.5 flex-1 justify-end flex-wrap">
                    {dynamicBenOptions.map(b => (
                      <button type="button" key={b} onClick={() => toggleBeneficiary(b)}
                        className={`px-3 py-1 rounded-lg text-[10px] font-black transition-all border ${formData.beneficiary.includes(b) ? "bg-blue-600 border-blue-600 text-white shadow-sm" : "bg-white border-gray-200 text-gray-400 hover:bg-gray-50"}`}>
                        {b === loginUser ? "自己" : b}
                      </button>
                    ))}
                  </div>
                </div>
                <CategorySelectPair type={formData.type} parentCat={formData.parentCat} childCat={formData.childCat} onChange={(p, c) => setFormData({ ...formData, parentCat: p, childCat: c })} />
                <div className="bg-gray-100 py-2.5 px-4 rounded-xl border border-transparent focus-within:border-blue-200 transition-colors flex items-center gap-3">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest shrink-0">備註</label>
                  <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm"
                    placeholder="輸入說明..." value={formData.desc} onChange={(e) => setFormData({ ...formData, desc: e.target.value })} />
                </div>
              </>
            )}

            {isSplit && (
              <>
                <div className="flex flex-col sm:flex-row gap-2">
                  <div className="bg-gray-100 py-2 px-3 rounded-xl flex-1 focus-within:border-blue-200 border border-transparent transition-colors">
                    <label className="text-[8px] font-black text-gray-400 uppercase block mb-0.5 tracking-widest">母項目標題</label>
                    <input type="text" className="w-full bg-transparent font-black border-none outline-none text-gray-800 placeholder:text-gray-300 text-xs"
                      placeholder="如：全聯發票" value={formData.parentTitle} onChange={(e) => setFormData({ ...formData, parentTitle: e.target.value })} />
                  </div>
                  <div className="bg-gray-100 py-2 px-3 rounded-xl flex-1 focus-within:border-blue-200 border border-transparent transition-colors">
                    <label className="text-[8px] font-black text-gray-400 uppercase block mb-0.5 tracking-widest">母項目備註</label>
                    <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-xs"
                      placeholder="選填..." value={formData.parentDesc} onChange={(e) => setFormData({ ...formData, parentDesc: e.target.value })} />
                  </div>
                </div>

                <div className="space-y-3 pt-2 border-t border-gray-100">
                  <label className="text-[10px] font-black text-blue-500 uppercase block tracking-widest px-2">子項目明細與花費對象</label>
                  {subItems.map((sub, index) => {
                    const pCats = Object.keys(CATEGORY_MAP[formData.type] || CATEGORY_MAP.expense);
                    const safeParentCat = pCats.includes(sub.parentCat) ? sub.parentCat : pCats[0];
                    const cCats = CATEGORY_MAP[formData.type][safeParentCat] || CATEGORY_MAP[formData.type][pCats[0]];
                    return (
                      <div key={sub.id} className="bg-white border-2 border-gray-100 p-3 rounded-2xl relative shadow-sm">
                        {subItems.length > 1 && (
                          <button onClick={() => handleRemoveSubItem(sub.id)} className="absolute -top-2 -right-2 bg-red-100 text-red-600 w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-sm font-bold">✕</button>
                        )}
                        <div className="flex gap-2 mb-2">
                          <select className="flex-1 bg-gray-50 border-none outline-none appearance-none font-black text-xs px-3 py-2 rounded-xl text-gray-700"
                            value={safeParentCat} onChange={(e) => { const newP = e.target.value; updateSubItem(sub.id, {parentCat: newP, childCat: CATEGORY_MAP[formData.type][newP][0]}); }}>
                            {pCats.map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                          <select className="flex-1 bg-gray-50 border-none outline-none appearance-none font-black text-xs px-3 py-2 rounded-xl text-gray-700"
                            value={sub.childCat} onChange={(e) => updateSubItem(sub.id, {childCat: e.target.value})}>
                            {cCats.map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                        </div>
                        <div className="flex gap-2 mb-2 items-center">
                          <input type="text" className="flex-1 bg-gray-50 font-bold border-none outline-none text-gray-800 placeholder:text-gray-400 text-xs px-3 py-2 rounded-xl min-w-0"
                            placeholder="子項備註(選填)" value={sub.desc} onChange={(e) => updateSubItem(sub.id, {desc: e.target.value})} />
                          <div className="w-24 shrink-0 relative">
                            <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 font-black text-xs">$</span>
                            <input type="number" inputMode="decimal" className="w-full bg-blue-50/50 font-black border-none outline-none text-blue-800 placeholder:text-blue-300 text-sm pl-5 pr-2 py-2 rounded-xl text-right"
                              placeholder="0" value={sub.amount} onChange={(e) => updateSubItem(sub.id, {amount: e.target.value})} />
                          </div>
                        </div>
                        <div className="flex items-center justify-between pt-1 gap-2 flex-wrap">
                          <span className="text-[9px] font-bold text-gray-400 uppercase shrink-0">對象</span>
                          <div className="flex gap-1.5 flex-1 justify-end flex-wrap">
                            {dynamicBenOptions.map(b => (
                              <button type="button" key={b} onClick={() => toggleSubBeneficiary(sub.id, b)}
                                className={`px-2.5 py-1 rounded-md text-[9px] font-black transition-all border ${sub.beneficiary.includes(b) ? "bg-blue-600 border-blue-600 text-white" : "bg-white border-gray-200 text-gray-400"}`}>
                                {b === loginUser ? "自己" : b}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    )
                  })}
                  <button onClick={handleAddSubItem} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-black text-xs active:scale-95 transition flex justify-center items-center gap-1 border border-blue-100">
                    <SvgIcon name="plus" size={16} /> 新增子項目
                  </button>
                </div>
              </>
            )}

            <div className="bg-gray-50 py-2.5 px-4 rounded-2xl border border-gray-100 flex items-center justify-between">
              <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">記錄帳本</label>
              <div className="flex gap-2">
                <button type="button" onClick={() => setFormData({ ...formData, member: loginUser })} className={`px-4 py-1.5 rounded-lg text-[10px] transition-all border-2 font-black ${formData.member === loginUser ? "bg-gray-800 border-gray-800 text-white" : "bg-white border-gray-200 text-gray-400"}`}>自己</button>
                <button type="button" onClick={() => setFormData({ ...formData, member: otherMember })} className={`px-4 py-1.5 rounded-lg text-[10px] transition-all border-2 font-black ${formData.member === otherMember ? "bg-gray-800 border-gray-800 text-white" : "bg-white border-gray-200 text-gray-400"}`}>幫{otherMember}記</button>
              </div>
            </div>
          </div>

          <button disabled={isSubmitDisabled || isLoading} onClick={submitForm}
            className="w-full mt-8 py-5 bg-blue-600 text-white rounded-3xl font-black text-lg active:scale-95 transition shadow-xl shadow-blue-500/30 disabled:opacity-40 disabled:shadow-none flex justify-center items-center gap-2"
          >
            {isLoading ? <SvgIcon name="refresh" size={20} className="animate-spin" /> : null}
            {isLoading ? "處理中..." : (isSplit ? `確認存檔 (${subItems.length}筆)` : "確認存檔")}
          </button>
        </div>
      );
    };

    const EditTransactionModal = ({ tx, loginUser, onSave, onDelete, onCancel, isLoading }) => {
      const [formData, setFormData] = useState({ 
        ...tx, parentCat: getParentCat(tx.category), childCat: getChildCat(tx.category),
        beneficiary: tx.beneficiary ? tx.beneficiary.split(",").filter(Boolean) : [tx.member]
      });
      const [showConfirmDelete, setShowConfirmDelete] = useState(false);

      useEffect(() => {
        let formattedDate = "";
        if (tx.date) {
          formattedDate = String(tx.date).replace(" (已編輯)", "").replace("(已編輯)", "").replace(/\//g, "-").replace(" ", "T");
          if (formattedDate.length > 16) formattedDate = formattedDate.slice(0, 16);
        }
        setFormData(prev => ({ ...prev, date: formattedDate }));
      }, [tx]);

      const otherMember = loginUser === "爸爸" ? "媽媽" : "爸爸";
      const dynamicBenOptions = [loginUser, ...BEN_OPTIONS.filter(b => b !== loginUser)];

      const toggleBeneficiary = (b) => {
        if (formData.beneficiary.includes(b)) {
           if (formData.beneficiary.length > 1) setFormData({...formData, beneficiary: formData.beneficiary.filter(x => x !== b)});
        } else setFormData({...formData, beneficiary: [...formData.beneficiary, b]});
      };

      const handleSave = () => onSave({ ...formData, category: `${formData.parentCat}/${formData.childCat}`, beneficiary: formData.beneficiary.join(",") });

      return (
        <div className="fixed inset-0 z-[500] bg-gray-900/90 backdrop-blur-sm overflow-y-auto flex flex-col items-center justify-center p-6 animate-in font-black" onClick={(e) => { if(e.target === e.currentTarget) onCancel(); }}>
          <div className="w-full max-w-sm relative">
            <button onClick={onCancel} className="absolute -top-12 right-0 text-white p-2 active:scale-90 opacity-80 hover:opacity-100 transition"><SvgIcon name="close" size={32} /></button>
            <div className="bg-white p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden pb-8">
              <div className="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
              <h2 className="text-xl font-black text-center mb-6 text-gray-800 pt-2">編輯明細</h2>

              <div className="flex bg-gray-100 p-1.5 rounded-2xl mb-6 text-sm text-gray-500">
                <button onClick={() => { const p = "食"; const c = CATEGORY_MAP["expense"][p][0]; setFormData({ ...formData, type: "expense", parentCat: p, childCat: c }) }} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === "expense" ? "bg-white text-red-500 shadow-sm font-black" : ""}`}>支出</button>
                <button onClick={() => { const p = "收入"; const c = CATEGORY_MAP["income"][p][0]; setFormData({ ...formData, type: "income", parentCat: p, childCat: c }) }} className={`flex-1 py-3 rounded-xl transition-all ${formData.type === "income" ? "bg-white text-green-500 shadow-sm font-black" : ""}`}>收入</button>
              </div>

              <div className="relative flex items-center justify-center mb-6 py-2 border-b border-gray-100 pb-6 text-gray-800">
                <span className="text-2xl font-black text-gray-300 mr-1 mt-1">$</span>
                <input type="number" inputMode="decimal" className={`w-32 text-5xl font-black text-center outline-none bg-transparent ${formData.type === "expense" ? "text-red-500" : "text-green-500"}`}
                  value={formData.amount} onChange={(e) => setFormData({ ...formData, amount: e.target.value })} />
              </div>

              <div className="space-y-4 text-left">
                <div className="bg-gray-100 py-1.5 px-3 rounded-xl flex items-center justify-between border border-transparent focus-within:border-blue-200 transition-colors">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">時間</label>
                  <input type="datetime-local" className="bg-transparent font-black border-none outline-none text-gray-800 text-xs max-w-[160px] w-full text-right"
                    value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} />
                </div>

                <div className="bg-gray-50 py-2 px-3 rounded-xl border border-gray-100 flex flex-wrap items-center justify-between gap-2">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mr-2 shrink-0">對象</label>
                  <div className="flex gap-1.5 flex-1 justify-end flex-wrap">
                    {dynamicBenOptions.map(b => (
                      <button type="button" key={b} onClick={() => toggleBeneficiary(b)}
                        className={`px-3 py-1 rounded-lg text-[10px] font-black transition-all border ${formData.beneficiary.includes(b) ? "bg-blue-600 border-blue-600 text-white shadow-sm" : "bg-white border-gray-200 text-gray-400 hover:bg-gray-50"}`}>
                        {b === loginUser ? "自己" : b}
                      </button>
                    ))}
                  </div>
                </div>

                <CategorySelectPair type={formData.type} parentCat={formData.parentCat} childCat={formData.childCat} onChange={(p, c) => setFormData({ ...formData, parentCat: p, childCat: c })} />

                <div className="bg-gray-100 py-2 px-3 rounded-xl border border-transparent focus-within:border-blue-200 transition-colors flex items-center gap-3">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest shrink-0">帳本</label>
                  <select className="w-full bg-transparent border-none outline-none appearance-none font-black text-sm text-right"
                    value={formData.member} onChange={(e) => setFormData({ ...formData, member: e.target.value })}>
                    <option value={loginUser}>自己</option><option value={otherMember}>{otherMember}</option>
                  </select>
                </div>

                <div className="bg-gray-100 py-2 px-3 rounded-xl border border-transparent focus-within:border-blue-200 transition-colors flex items-center gap-3">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest shrink-0">備註</label>
                  <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm text-right"
                    placeholder="選填" value={formData.desc} onChange={(e) => setFormData({ ...formData, desc: e.target.value })} />
                </div>
              </div>

              <div className="flex gap-3 mt-8">
                {!showConfirmDelete ? (
                  <>
                    <button disabled={isLoading} onClick={() => setShowConfirmDelete(true)} className="flex-1 py-4 bg-red-50 text-red-600 rounded-2xl font-black active:scale-95 transition-all flex items-center justify-center gap-1 disabled:opacity-30">
                      <SvgIcon name="trash" size={18} /> 刪除
                    </button>
                    <button disabled={!formData.amount || formData.amount === "0" || isLoading} onClick={handleSave} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black active:scale-95 transition-all shadow-lg shadow-blue-500/30 disabled:opacity-30 flex justify-center items-center gap-2">
                      {isLoading ? <SvgIcon name="refresh" size={16} className="animate-spin" /> : null} {isLoading ? "處理中..." : "儲存變更"}
                    </button>
                  </>
                ) : (
                  <div className="w-full animate-in bg-red-50 p-4 rounded-2xl text-center border border-red-100">
                    <p className="text-red-600 font-black text-xs mb-3">確定永久刪除此紀錄？</p>
                    <div className="flex gap-2">
                      <button onClick={() => setShowConfirmDelete(false)} className="flex-1 py-3 bg-white text-gray-600 rounded-xl font-black active:scale-95 border border-gray-200">保留</button>
                      <button disabled={isLoading} onClick={() => onDelete(tx.id)} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-black active:scale-95 shadow-md shadow-red-500/20 disabled:opacity-30">確認刪除</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const EditGroupParentModal = ({ group, onSave, onCancel, isLoading }) => {
      const [formData, setFormData] = useState({ parentTitle: group.parentTitle, parentDesc: group.parentDesc, date: group.date });

      useEffect(() => {
        let formattedDate = "";
        if (group.date) {
          formattedDate = String(group.date).replace(" (已編輯)", "").replace("(已編輯)", "").replace(/\//g, "-").replace(" ", "T");
          if (formattedDate.length > 16) formattedDate = formattedDate.slice(0, 16);
        }
        setFormData(prev => ({ ...prev, date: formattedDate }));
      }, [group]);

      const handleSave = () => {
        const combinedParentDesc = `${formData.parentTitle.trim() || "拆分紀錄"}|||${formData.parentDesc.trim()}`;
        onSave({ groupId: group.groupId, parentDesc: combinedParentDesc, date: formData.date });
      };

      return (
        <div className="fixed inset-0 z-[500] bg-gray-900/90 backdrop-blur-sm overflow-y-auto flex flex-col items-center justify-center p-6 animate-in font-black" onClick={(e) => { if(e.target === e.currentTarget) onCancel(); }}>
          <div className="w-full max-w-sm relative">
            <button onClick={onCancel} className="absolute -top-12 right-0 text-white p-2 active:scale-90 opacity-80 hover:opacity-100 transition">
              <SvgIcon name="close" size={32} />
            </button>
            <div className="bg-white p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden pb-8">
              <div className="absolute top-0 left-0 w-full h-2 bg-gray-800"></div>
              <h2 className="text-xl font-black text-center mb-2 text-gray-800 pt-2">編輯母項目</h2>
              <p className="text-[10px] text-gray-400 text-center mb-6">修改後將同步更新旗下所有明細的時間與標題</p>

              <div className="space-y-4 text-left">
                <div className="bg-gray-100 py-2.5 px-4 rounded-xl flex items-center justify-between border border-transparent focus-within:border-gray-300 transition-colors">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">時間</label>
                  <input type="datetime-local" className="bg-transparent font-black border-none outline-none text-gray-800 text-sm w-[180px] text-right"
                    value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} />
                </div>
                <div className="bg-gray-100 py-3 px-4 rounded-xl flex flex-col gap-1 border border-transparent focus-within:border-gray-300 transition-colors">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">母項目標題</label>
                  <input type="text" className="w-full bg-transparent font-black border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm"
                    placeholder="如：全聯發票" value={formData.parentTitle} onChange={(e) => setFormData({ ...formData, parentTitle: e.target.value })} />
                </div>
                <div className="bg-gray-100 py-3 px-4 rounded-xl flex flex-col gap-1 border border-transparent focus-within:border-gray-300 transition-colors">
                  <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">母項目備註</label>
                  <input type="text" className="w-full bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm"
                    placeholder="選填" value={formData.parentDesc} onChange={(e) => setFormData({ ...formData, parentDesc: e.target.value })} />
                </div>
              </div>

              <div className="mt-8">
                <button disabled={isLoading} onClick={handleSave} className="w-full py-4 bg-gray-800 text-white rounded-2xl font-black active:scale-95 transition-all shadow-lg disabled:opacity-30 flex justify-center items-center gap-2">
                  {isLoading ? <SvgIcon name="refresh" size={16} className="animate-spin" /> : null} {isLoading ? "處理中..." : "批次更新所有子項目"}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const AdvancedFilterModal = ({ isOpen, onClose, filterState, setFilterState, transactions }) => {
      const [tempFilter, setTempFilter] = useState({ ...filterState });
      const [newCondType, setNewCondType] = useState('include'); 
      const [newCondLevel, setNewCondLevel] = useState('parent'); 
      const [newCondVal, setNewCondVal] = useState('');

      useEffect(() => { setTempFilter({ ...filterState }); }, [isOpen, filterState]);

      const availableTxs = useMemo(() => {
         const cutoff = new Date();
         let useDate = true;
         if (tempFilter.dateType === "7d") cutoff.setDate(cutoff.getDate() - 7);
         else if (tempFilter.dateType === "1m") cutoff.setMonth(cutoff.getMonth() - 1);
         else if (tempFilter.dateType === "3m") cutoff.setMonth(cutoff.getMonth() - 3);
         else if (tempFilter.dateType === "6m") cutoff.setMonth(cutoff.getMonth() - 6);
         else if (tempFilter.dateType === "1y") cutoff.setFullYear(cutoff.getFullYear() - 1);
         else useDate = false;

         let startTs = tempFilter.customStart ? new Date(`${tempFilter.customStart}T00:00:00`).getTime() : 0;
         let endTs = tempFilter.customEnd ? new Date(`${tempFilter.customEnd}T23:59:59`).getTime() : Infinity;

         return transactions.filter(t => {
            const txTime = parseDateForSort(t.date);
            if (tempFilter.dateType === "custom") {
               if (txTime < startTs || txTime > endTs) return false;
            } else if (useDate && txTime < cutoff.getTime()) {
               return false;
            }
            if (!tempFilter.types.includes(t.type)) return false;
            return true;
         });
      }, [transactions, tempFilter.dateType, tempFilter.customStart, tempFilter.customEnd, tempFilter.types]);

      const { dynamicParents, dynamicChildren, dynamicBens } = useMemo(() => {
         const pMap = {}; const cMap = {}; const bMap = {};
         availableTxs.forEach(t => {
            const p = getParentCat(t.category);
            const c = getChildCat(t.category);
            const b = formatBen(t.beneficiary, t.member) || "未知";
            pMap[p] = (pMap[p] || 0) + 1;
            cMap[c] = (cMap[c] || 0) + 1;
            bMap[b] = (bMap[b] || 0) + 1;
         });
         return {
            dynamicParents: Object.entries(pMap).sort((a,b)=>b[1]-a[1]).map(e => ({name: e[0], count: e[1]})),
            dynamicChildren: Object.entries(cMap).sort((a,b)=>b[1]-a[1]).map(e => ({name: e[0], count: e[1]})),
            dynamicBens: Object.entries(bMap).sort((a,b)=>b[1]-a[1]).map(e => ({name: e[0], count: e[1]}))
         };
      }, [availableTxs]);

      useEffect(() => {
        const options = newCondLevel === 'parent' ? dynamicParents : newCondLevel === 'child' ? dynamicChildren : dynamicBens;
        if (!options.some(o => o.name === newCondVal) && options.length > 0) {
           setNewCondVal(options[0].name);
        } else if (options.length === 0) {
           setNewCondVal('');
        }
      }, [newCondLevel, dynamicParents, dynamicChildren, dynamicBens]);

      if (!isOpen) return null;

      const handleAddCondition = () => {
        if (!newCondVal) return;
        if (tempFilter.catConditions.some(c => c.mode === newCondType && c.level === newCondLevel && c.val === newCondVal)) return;
        setTempFilter({ ...tempFilter, catConditions: [...tempFilter.catConditions, { mode: newCondType, level: newCondLevel, val: newCondVal, id: Date.now() }] });
      };

      const handleRemoveCondition = (id) => {
        setTempFilter({ ...tempFilter, catConditions: tempFilter.catConditions.filter(c => c.id !== id) });
      };

      const handleApply = () => { setFilterState(tempFilter); onClose(); };
      const handleReset = () => { 
        setTempFilter({ dateType: 'all', customStart: '', customEnd: '', types: ['expense', 'income'], catConditions: [], minAmount: '', maxAmount: '' }); 
      };

      return (
        <div className="fixed inset-0 z-[600] bg-gray-900/90 backdrop-blur-sm flex flex-col items-center justify-end sm:justify-center animate-in font-black">
          <div className="w-full max-w-md bg-white rounded-t-[2.5rem] sm:rounded-[2.5rem] p-6 relative max-h-[85vh] overflow-y-auto scrollbar-hide pb-10 shadow-2xl">
            <div className="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 sm:hidden"></div>
            <button onClick={onClose} className="absolute top-6 right-6 text-gray-400 active:scale-90"><SvgIcon name="close" size={24} /></button>
            <h2 className="text-xl font-black text-gray-800 mb-6 flex items-center gap-2"><SvgIcon name="filter" size={20} className="text-blue-600"/> 進階過濾</h2>

            <div className="space-y-6">
              <div>
                <h3 className="text-xs text-gray-400 uppercase tracking-widest mb-3">日期區間 (必選)</h3>
                <div className="flex flex-wrap gap-2 mb-3">
                  {['all', '7d', '1m', '3m', 'custom'].map(type => {
                    const labels = { all: "全部", "7d": "近7天", "1m": "近1個月", "3m": "近3個月", custom: "自訂區間" };
                    return (
                      <button key={type} onClick={() => setTempFilter({...tempFilter, dateType: type})} 
                        className={`px-4 py-2 rounded-xl text-xs transition-colors border ${tempFilter.dateType === type ? "bg-blue-600 text-white border-blue-600 shadow-sm" : "bg-white text-gray-600 border-gray-200"}`}>
                        {labels[type]}
                      </button>
                    )
                  })}
                </div>
                {tempFilter.dateType === 'custom' && (
                  <div className="flex gap-2 items-center bg-gray-50 p-3 rounded-xl border border-gray-100 animate-in">
                    <input type="date" value={tempFilter.customStart} onChange={e => setTempFilter({...tempFilter, customStart: e.target.value})} className="flex-1 bg-transparent font-black text-xs text-gray-700 outline-none" />
                    <span className="text-gray-400 font-bold">~</span>
                    <input type="date" value={tempFilter.customEnd} onChange={e => setTempFilter({...tempFilter, customEnd: e.target.value})} className="flex-1 bg-transparent font-black text-xs text-gray-700 outline-none" />
                  </div>
                )}
              </div>

              <div>
                <h3 className="text-xs text-gray-400 uppercase tracking-widest mb-3">收支類型</h3>
                <div className="flex gap-2">
                  {['expense', 'income'].map(type => {
                    const isSelected = tempFilter.types.includes(type);
                    return (
                      <button key={type} onClick={() => {
                        let newTypes = [...tempFilter.types];
                        if (isSelected) newTypes = newTypes.filter(t => t !== type);
                        else newTypes.push(type);
                        if (newTypes.length === 0) newTypes = ['expense'];
                        setTempFilter({...tempFilter, types: newTypes});
                      }} className={`flex-1 py-3 rounded-xl text-sm transition-colors border-2 ${isSelected ? "bg-gray-800 text-white border-gray-800" : "bg-white text-gray-400 border-gray-200"}`}>
                        {type === 'expense' ? '支出' : '收入'}
                      </button>
                    )
                  })}
                </div>
              </div>

              <div>
                <h3 className="text-xs text-gray-400 uppercase tracking-widest mb-3">金額範圍 (選填)</h3>
                <div className="flex gap-2 items-center">
                  <div className="flex-1 relative bg-gray-50 p-2.5 rounded-xl border border-gray-100">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span>
                    <input type="number" placeholder="最小金額" value={tempFilter.minAmount} onChange={e => setTempFilter({...tempFilter, minAmount: e.target.value})} className="w-full bg-transparent pl-5 pr-2 outline-none text-sm font-black text-gray-800" />
                  </div>
                  <span className="text-gray-400 font-bold">~</span>
                  <div className="flex-1 relative bg-gray-50 p-2.5 rounded-xl border border-gray-100">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span>
                    <input type="number" placeholder="最大金額" value={tempFilter.maxAmount} onChange={e => setTempFilter({...tempFilter, maxAmount: e.target.value})} className="w-full bg-transparent pl-5 pr-2 outline-none text-sm font-black text-gray-800" />
                  </div>
                </div>
              </div>

              <div className="border-t border-gray-100 pt-4">
                <h3 className="text-xs text-gray-400 uppercase tracking-widest mb-3 flex items-center justify-between">
                  <span>分類排除與綁定 (選填)</span>
                </h3>
                <div className="bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2">
                  <div className="flex gap-2">
                    <select value={newCondType} onChange={e => setNewCondType(e.target.value)} className="flex-1 bg-white border border-gray-200 rounded-lg text-xs font-black px-2 py-2 outline-none appearance-none">
                      <option value="include">✅ 包含 (只要看這項)</option>
                      <option value="exclude">❌ 排除 (不要算這項)</option>
                    </select>
                    <select value={newCondLevel} onChange={e => setNewCondLevel(e.target.value)} className="w-24 bg-white border border-gray-200 rounded-lg text-xs font-black px-2 py-2 outline-none appearance-none">
                      <option value="parent">主類別</option>
                      <option value="child">子項目</option>
                      <option value="beneficiary">對象</option>
                    </select>
                  </div>
                  <div className="flex gap-2">
                    <select value={newCondVal} onChange={e => setNewCondVal(e.target.value)} className="flex-1 bg-white border border-gray-200 rounded-lg text-sm font-black px-3 py-2 outline-none appearance-none" disabled={!newCondVal}>
                      {(newCondLevel === 'parent' ? dynamicParents : newCondLevel === 'child' ? dynamicChildren : dynamicBens).map(c => <option key={c.name} value={c.name}>{c.name} ({c.count}筆)</option>)}
                      {!newCondVal && <option value="">無符合資料</option>}
                    </select>
                    <button onClick={handleAddCondition} disabled={!newCondVal} className="bg-gray-800 text-white px-4 rounded-lg text-xs active:scale-95 shadow-sm disabled:opacity-30">加入</button>
                  </div>
                </div>
                
                {tempFilter.catConditions.length > 0 && (
                  <div className="flex flex-wrap gap-2 mt-3 p-3 bg-white rounded-xl border border-gray-100 shadow-inner">
                    {tempFilter.catConditions.map(c => (
                      <div key={c.id} className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-[10px] font-black border ${c.mode === 'include' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-red-50 text-red-600 border-red-200 line-through'}`}>
                        <span>{c.val}</span>
                        <button onClick={() => handleRemoveCondition(c.id)} className="ml-1 opacity-60 hover:opacity-100 bg-white/50 rounded-full p-0.5"><SvgIcon name="close" size={10} /></button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            <div className="flex gap-3 mt-8">
              <button onClick={handleReset} className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-2xl active:scale-95 font-black text-sm">清空條件</button>
              <button onClick={handleApply} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl active:scale-95 shadow-lg shadow-blue-500/30 font-black text-lg">套用過濾</button>
            </div>
          </div>
        </div>
      );
    };

    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");
      const [familyConfig, setFamilyConfig] = useState(() => {
        const saved = safeArrayLS(LS.members); return saved.length ? saved : [{ name: "爸爸", color: "bg-blue-600" }, { name: "媽媽", color: "bg-pink-600" }];
      });
      const [customSubtitle, setCustomSubtitle] = useState("{name}，你好！");
      const [greetingsCache, setGreetingsCache] = useState(() => {
        const raw = localStorage.getItem(LS.greetingsCache);
        if (!raw || raw === "null" || raw === "undefined") return {};
        try { return JSON.parse(raw) || {}; } catch { return {}; }
      });

      const [currentUser, setCurrentUser] = useState(null);
      const [selectingUser, setSelectingUser] = useState(null);
      const [pinInput, setPinInput] = useState("");
      const [fallbackToPin, setFallbackToPin] = useState(false);

      const [biometricAvailable, setBiometricAvailable] = useState(false);
      const [isSyncing, setIsSyncing] = useState(false);
      const [statusMsg, setStatusMsg] = useState({ type: "", text: "" });
      const [loadingCard, setLoadingCard] = useState({ show: false, text: "" });

      const isLoading = loadingCard.show || isSyncing;

      const [lastSyncText, setLastSyncText] = useState(() => safeStringLS(LS.lastSync, "----/--/-- --:--"));
      
      const [txCache, setTxCache] = useState([]);
      const [historyCache, setHistoryCache] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [syncQueue, setSyncQueue] = useState([]);

      const [editingTx, setEditingTx] = useState(null);
      const [editingGroup, setEditingGroup] = useState(null);
      const [viewingHistory, setViewingHistory] = useState(null);

      const [expandedGroups, setExpandedGroups] = useState({});
      const [historySearch, setHistorySearch] = useState("");
      const [historyVisibleCount, setHistoryVisibleCount] = useState(20);
      
      const [showHistoryFilter, setShowHistoryFilter] = useState(false);
      const [historyFilter, setHistoryFilter] = useState({
        dateType: 'all', customStart: '', customEnd: '',
        types: ['expense', 'income'], catConditions: [],
        minAmount: '', maxAmount: ''
      });

      const [showAnalysisFilter, setShowAnalysisFilter] = useState(false);
      const [analysisFilter, setAnalysisFilter] = useState({
        dateType: '1m', customStart: '', customEnd: '',
        types: ['expense', 'income'], catConditions: [],
        minAmount: '', maxAmount: ''
      });

      const [analysisType, setAnalysisType] = useState("expense"); 
      const [selectedAnalysisLevel1, setSelectedAnalysisLevel1] = useState(null); 
      const [selectedAnalysisLevel2, setSelectedAnalysisLevel2] = useState(null); 

      const [showBootstrapModal, setShowBootstrapModal] = useState(false);
      const [bootstrapSecret, setBootstrapSecret] = useState("");
      const [showUnbindModal, setShowUnbindModal] = useState(false);
      const [unbindPin, setUnbindPin] = useState("");
      const [showChangePinModal, setShowChangePinModal] = useState(false);
      const [oldPin, setOldPin] = useState("");
      const [newPin, setNewPin] = useState("");
      const [newPin2, setNewPin2] = useState("");
      const [isLogOpen, setIsLogOpen] = useState(false);

      const showStatus = (type, text) => { setStatusMsg({ type, text }); setTimeout(() => setStatusMsg({ type: "", text: "" }), 3000); };

      useEffect(() => {
        idbGet(LS.txCache).then(d => { if(Array.isArray(d) && d.length > 0) { setTxCache(d); setTransactions(d); } });
        idbGet(LS.historyCache).then(d => { if(Array.isArray(d)) setHistoryCache(d); });
        idbGet(LS.pending).then(d => { if(Array.isArray(d) && d.length > 0) setSyncQueue(d); });
      }, []);

      useEffect(() => { idbSet(LS.pending, syncQueue); }, [syncQueue]);
      useEffect(() => { idbSet(LS.txCache, txCache); }, [txCache]);
      useEffect(() => { idbSet(LS.historyCache, historyCache); }, [historyCache]);
      
      useEffect(() => { localStorage.setItem(LS.members, JSON.stringify(familyConfig)); }, [familyConfig]);
      useEffect(() => { localStorage.setItem(LS.lastSync, lastSyncText); }, [lastSyncText]);
      useEffect(() => { localStorage.setItem(LS.greetingsCache, JSON.stringify(greetingsCache || {})); }, [greetingsCache]);

      useEffect(() => {
        if (currentUser && greetingsCache && greetingsCache[currentUser.name]) {
           setCustomSubtitle(greetingsCache[currentUser.name]);
        } else if (currentUser) {
           setCustomSubtitle("{name}，你好！");
        }
      }, [currentUser, greetingsCache]);

      useEffect(() => setHistoryVisibleCount(20), [historySearch, historyFilter, activeTab]);
      useEffect(() => { if (activeTab !== "analysis") { setSelectedAnalysisLevel1(null); setSelectedAnalysisLevel2(null); setAnalysisType("expense"); } }, [activeTab]);
      useEffect(() => { setSelectedAnalysisLevel1(null); setSelectedAnalysisLevel2(null); }, [analysisType, analysisFilter]); 
      useEffect(() => { setSelectedAnalysisLevel2(null); }, [selectedAnalysisLevel1]); 

      useEffect(() => { if (window.PublicKeyCredential) PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(v => setBiometricAvailable(v)); }, []);
      useEffect(() => { (async () => { try { const res = await fetch(gasUrl); const data = await res.json(); if (data.members && data.members.length) setFamilyConfig(data.members); } catch {} })(); }, []);
      useEffect(() => { if (navigator.onLine && !deviceValid()) { setShowBootstrapModal(true); setBootstrapSecret(""); } }, []);
      
      const syncDataToCloud = async (isManual = false) => {
        if (isSyncing || !navigator.onLine) return;
        if (!deviceValid()) { 
           if (isManual) { showStatus("error", "雲端憑證已過期，請重新綁定"); forceReloginForToken(); }
           return; 
        }
        
        const currentQueue = [...syncQueue];
        if (currentQueue.length === 0) {
          if (isManual) {
            setIsSyncing(true);
            try { await fetchCloudTx(); showStatus("success", "同步完成"); } 
            catch(e) { showStatus("error", "同步失敗"); } 
            finally { setIsSyncing(false); }
          }
          return;
        }

        setIsSyncing(true);
        if (isManual) setLoadingCard({ show:true, text:`同步 ${currentQueue.length} 筆中...` });

        try {
          if (isManual) await refreshDeviceToken();
          
          const adds = currentQueue.filter(q => !q._action || q._action === 'ADD').map(q => ({...q, editHistory: JSON.stringify(q.editHistory || [])}));
          const updates = currentQueue.filter(q => q._action === 'UPDATE');
          const deletes = currentQueue.filter(q => q._action === 'DELETE');
          const groupUpdates = currentQueue.filter(q => q._action === 'UPDATE_GROUP');
          
          if (adds.length > 0) {
            const res = await postGAS({ action: "BATCH_ADD", transactions: adds, deviceToken: getDeviceToken() });
            if (res.result !== "success") throw new Error(res.message || "新增同步失敗");
          }

          for (const u of updates) {
            const payload = { ...u, editHistory: JSON.stringify(u.editHistory || []) };
            const res = await postGAS({ ...payload, action:"UPDATE_TX", deviceToken: getDeviceToken() });
            if (res.result !== "success") throw new Error(res.message || "更新同步失敗");
          }

          for (const d of deletes) {
            const res = await postGAS({ action:"DELETE_TX", id: d.id, editor: d.editor, deviceToken: getDeviceToken() });
            if (res.result !== "success") throw new Error(res.message || "刪除同步失敗");
          }

          for (const gu of groupUpdates) {
            const res = await postGAS({ action:"UPDATE_GROUP_PARENT", groupId: gu.groupId, parentDesc: gu.parentDesc, date: gu.date, editor: gu.editor, deviceToken: getDeviceToken() });
            if (res.result !== "success") throw new Error(res.message || "群組更新同步失敗");
          }
          
          await fetchCloudTx(); 
          setSyncQueue(prev => prev.filter(p => !currentQueue.some(q => q.id === p.id && q._action === p._action)));
          if (isManual) showStatus("success", "同步完成");
        } catch (e) {
          if (isManual) {
            const msg = e.message || "同步失敗"; showStatus("error", msg);
            if (msg.includes("過期") || msg.includes("無效") || msg.includes("憑證")) forceReloginForToken();
          }
        } finally {
          setIsSyncing(false);
          if (isManual) setLoadingCard({ show:false, text:"" });
        }
      };

      useEffect(() => {
        if (syncQueue.length > 0 && navigator.onLine && deviceValid() && !isSyncing) {
          syncDataToCloud(false);
        }
      }, [syncQueue, navigator.onLine]);

      const forceReloginForToken = () => { setTimeout(() => { setCurrentUser(null); setSelectingUser(null); setPinInput(""); setBootstrapSecret(""); setShowBootstrapModal(true); }, 2000); };

      const refreshDeviceToken = async () => {
        const data = await postGAS({ action: "DEVICE_REFRESH", deviceToken: getDeviceToken() });
        if (data.result !== "success") throw new Error(data.message || "憑證已過期");
        setDeviceToken(data.deviceToken, data.deviceExp); return data;
      };

      const bootstrapDevice = async () => {
        if (!bootstrapSecret) throw new Error("請輸入雲端密碼");
        const data = await postGAS({ action: "DEVICE_BOOTSTRAP", appSecret: bootstrapSecret });
        if (data.result !== "success") throw new Error(data.message || "綁定失敗");
        setDeviceToken(data.deviceToken, data.deviceExp); return data;
      };

      const getCloudPinHash = async (name, pin) => { return await sha256Base64(`${name}::${pin}::cloud`); };

      const verifyPinOnline = async (name, pin) => {
        const hashedPin = await getCloudPinHash(name, pin);
        const res = await postGAS({ action:"VERIFY_PIN", name, pin: hashedPin, deviceToken: getDeviceToken() });
        if (res.result !== "success") throw new Error(res.message || "PIN 錯誤"); return true;
      };

      const fetchCloudTx = async () => {
        const data = await postGAS({ action:"GET_TX", deviceToken: getDeviceToken() });
        if (data.result !== "success") throw new Error(data.message || "抓取失敗");
        
        const formattedTxs = (data.transactions || []).map((t, i) => ({
          id: t.id || t["ID"] || String(i), amount: parseFloat(t["金額"]) || 0, category: t["類別"] || "其他",
          date: t["日期時間"] || t["日期"] || "", member: t["成員"] || "未知", recorder: t["記錄者"] || "系統",
          desc: t["備註"] || "", type: t["類型"] || "expense", groupId: t["GroupID"] || "", parentDesc: t["ParentDesc"] || "", beneficiary: t["Beneficiary"] || "",
          editHistory: safeParse(t["EditHistory"], [])
        }));
        
        const formattedHistory = data.history || [];
        setHistoryCache(formattedHistory);
        
        setTransactions(formattedTxs); setTxCache(formattedTxs); setLastSyncText(nowStr()); 
        if (data.greetings) setGreetingsCache(data.greetings); 
        return formattedTxs;
      };

      const handleSaveGreeting = async () => {
         if (!navigator.onLine || !deviceValid()) { showStatus("error", "需連線才能儲存問候語"); return; }
         try {
            setLoadingCard({ show:true, text:"正在儲存..." }); await refreshDeviceToken();
            const res = await postGAS({ action: "UPDATE_GREETING", name: currentUser.name, greeting: customSubtitle, deviceToken: getDeviceToken() });
            if (res.result !== "success") throw new Error(res.message);
            setGreetingsCache(prev => ({...prev, [currentUser.name]: customSubtitle}));
            showStatus("success", "問候語已更新");
         } catch (e) { showStatus("error", e.message || "儲存失敗"); } finally { setLoadingCard({ show:false, text:"" }); }
      };

      const saveLocalPinHash = async (name, pin) => { const h = await sha256Base64(`${name}::${pin}::local`); localStorage.setItem(LS.pinHashPrefix + name, h); };
      const unlockWithPinLocal = async (name, pin) => { const stored = localStorage.getItem(LS.pinHashPrefix + name); if (!stored) return false; const h = await sha256Base64(`${name}::${pin}::local`); return h === stored; };

      const handleBioLoginLocal = async (name) => {
        const lockedUntil = getBioLockedUntil(name);
        if (lockedUntil && Date.now() < lockedUntil) {
          showStatus("error", `請稍候 ${Math.ceil((lockedUntil - Date.now())/1000)}s 再試（剩餘 ${Math.max(0, BIO_MAX_FAIL - getBioFailCount(name))} 次）`); return false;
        }
        try {
          const base64Id = localStorage.getItem(getBioKey(name)); if (!base64Id) { showStatus("error","設備未綁定"); return false; }
          const idStr = atob(base64Id); const idArray = new Uint8Array(idStr.length); for (let i=0;i<idStr.length;i++) idArray[i] = idStr.charCodeAt(i);
          const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
          await navigator.credentials.get({ publicKey: { challenge, allowCredentials: [{ type:"public-key", id:idArray }], userVerification: "required" } });
          clearBioFail(name); return true;
        } catch (e) {
          const fail = getBioFailCount(name) + 1; setBioFailCount(name, fail); const left = Math.max(0, BIO_MAX_FAIL - fail);
          if (left <= 0) { setBioLockedUntil(name, Date.now() + 30000); showStatus("error", `驗證失敗，已暫停 30 秒（剩餘 0 次）`); } else { setBioLockedUntil(name, Date.now() + BIO_COOLDOWN_MS); showStatus("error", `驗證失敗，剩餘 ${left} 次（${Math.ceil(BIO_COOLDOWN_MS/1000)}s 後可再試）`); }
          return false;
        }
      };

      const bindDeviceBio = async () => {
        if (!window.PublicKeyCredential) { showStatus("error","不支援生物辨識"); return; }
        try {
          setLoadingCard({ show:true, text:"正在綁定設備..." });
          const challenge = new Uint8Array(32); crypto.getRandomValues(challenge); const userID = new Uint8Array(16); crypto.getRandomValues(userID);
          const cred = await navigator.credentials.create({ publicKey: { challenge, rp: { name:"家庭記帳" }, user: { id:userID, name: currentUser.name, displayName: currentUser.name }, pubKeyCredParams: [{ type:"public-key", alg:-7 }, { type:"public-key", alg:-257 }], authenticatorSelection: { authenticatorAttachment:"platform", userVerification:"required" }, timeout: 60000 } });
          localStorage.setItem(getBioKey(currentUser.name), btoa(String.fromCharCode.apply(null, Array.from(new Uint8Array(cred.rawId)))));
          clearBioFail(currentUser.name); showStatus("success","設備已綁定");
        } catch { showStatus("error","綁定失敗或已取消"); } finally { setLoadingCard({ show:false, text:"" }); }
      };

      const unbindDeviceBio = async () => {
        if (unbindPin.length !== 6) { showStatus("error","請輸入 6 位 PIN"); return; }
        if (!navigator.onLine) { showStatus("error","需連線驗證 PIN 才能解除"); return; }
        if (!deviceValid()) { showStatus("error","雲端憑證已過期，請先綁定雲端"); return; }
        try {
          setLoadingCard({ show:true, text:"正在驗證..." }); await verifyPinOnline(currentUser.name, unbindPin);
          localStorage.removeItem(getBioKey(currentUser.name)); clearBioFail(currentUser.name); setShowUnbindModal(false); setUnbindPin(""); showStatus("success","已解除綁定");
        } catch (e) { showStatus("error", e.message || "PIN 錯誤"); } finally { setLoadingCard({ show:false, text:"" }); }
      };

      const changePin = async () => {
        if (!navigator.onLine) { showStatus("error","需連線才能更換密碼"); return; }
        if (!deviceValid()) { showStatus("error","雲端憑證已過期，請先綁定雲端"); return; }
        if (oldPin.length !== 6 || newPin.length !== 6 || newPin2.length !== 6) { showStatus("error","請輸入 6 位 PIN"); return; }
        if (newPin !== newPin2) { showStatus("error","兩次輸入不一致"); return; }
        try {
          setLoadingCard({ show:true, text:"正在更新密碼..." });
          const hashedOldPin = await getCloudPinHash(currentUser.name, oldPin);
          const hashedNewPin = await getCloudPinHash(currentUser.name, newPin);
          const res = await postGAS({ action:"UPDATE_PIN", name: currentUser.name, oldPin: hashedOldPin, newPin: hashedNewPin, deviceToken: getDeviceToken() });
          if (res.result !== "success") throw new Error(res.message || "更新失敗");
          localStorage.removeItem(LS.pinHashPrefix + currentUser.name); setShowChangePinModal(false);
          showStatus("success","密碼更新成功，請重新登入"); setCurrentUser(null); setSelectingUser(null); setPinInput(""); setActiveTab("dashboard");
        } catch (e) { showStatus("error", e.message || "更新失敗"); } finally { setLoadingCard({ show:false, text:"" }); }
      };

      const handleAdd = (newTxs) => {
        const baseDate = newTxs[0].date ? newTxs[0].date.replace("T"," ").replace(/-/g,"/") : nowStr();
        const baseId = Date.now(); 
        const isMulti = newTxs.length > 1;
        const groupId = isMulti ? `G${baseId}` : ""; 
        const parentDesc = isMulti ? newTxs[0].parentDesc : "";
        
        const completeTxs = newTxs.map((tx, idx) => ({ 
          ...tx, 
          date: baseDate, 
          recorder: currentUser.name, 
          id: String(baseId + idx), 
          groupId, 
          parentDesc,
          editHistory: [] 
        }));

        setSyncQueue(prev => [...prev, ...completeTxs.map(t => ({...t, _action: 'ADD'}))]);
        setActiveTab("dashboard");
        
        if (navigator.onLine && deviceValid()) {
          showStatus("success", "已儲存，背景同步中");
        } else {
          showStatus("info", "無網路，已暫存於設備");
        }
      };

      const handleUpdateTx = (updatedTx) => {
        const oldTx = visibleTransactions.find(t => t.id === updatedTx.id) || {};
        const historyEntry = {
           timestamp: nowStr(),
           txId: updatedTx.id,
           groupId: updatedTx.groupId || "",
           action: 'UPDATE',
           editor: currentUser.name,
           snapshot: JSON.stringify({
              '日期時間': oldTx.date, '類別': oldTx.category, '金額': oldTx.amount, '成員': oldTx.member, 
              '備註': oldTx.desc, '類型': oldTx.type, '記錄者': oldTx.recorder, 'ID': oldTx.id, 
              'GroupID': oldTx.groupId, 'ParentDesc': oldTx.parentDesc, 'Beneficiary': oldTx.beneficiary
           })
        };
        
        setHistoryCache(prev => [historyEntry, ...prev]);
        
        const finalTx = { ...updatedTx, date: updatedTx.date }; 
        
        setTransactions(prev => prev.map(t => t.id === finalTx.id ? finalTx : t));
        setTxCache(prev => prev.map(t => t.id === finalTx.id ? finalTx : t));

        const isPendingAdd = syncQueue.some(q => q.id === finalTx.id && (!q._action || q._action === 'ADD'));
        if (isPendingAdd) {
           setSyncQueue(prev => prev.map(q => q.id === finalTx.id ? { ...finalTx, _action: 'ADD' } : q));
        } else {
           setSyncQueue(prev => {
              const filtered = prev.filter(q => !(q.id === finalTx.id && q._action === 'UPDATE'));
              return [...filtered, { ...finalTx, _action: 'UPDATE', editor: currentUser.name }];
           });
        }

        setEditingTx(null);
        showStatus("success", "已暫存修改，背景同步中");
      };

      const handleUpdateGroupParent = (groupData) => {
        const children = visibleTransactions.filter(t => t.groupId === groupData.groupId);
        const histRecs = children.map(oldTx => ({
          timestamp: nowStr(),
          txId: oldTx.id,
          groupId: oldTx.groupId,
          action: 'UPDATE_GROUP',
          editor: currentUser.name,
          snapshot: JSON.stringify({
              '日期時間': oldTx.date, '類別': oldTx.category, '金額': oldTx.amount, '成員': oldTx.member, 
              '備註': oldTx.desc, '類型': oldTx.type, '記錄者': oldTx.recorder, 'ID': oldTx.id, 
              'GroupID': oldTx.groupId, 'ParentDesc': oldTx.parentDesc, 'Beneficiary': oldTx.beneficiary
           })
        }));
        setHistoryCache(prev => [...histRecs, ...prev]);

        const updateFn = t => t.groupId === groupData.groupId ? { ...t, parentTitle: groupData.parentTitle, parentDesc: groupData.parentDesc, date: groupData.date } : t;
        setTransactions(prev => prev.map(updateFn));
        setTxCache(prev => prev.map(updateFn));

        const isPendingGroup = syncQueue.some(p => p.groupId === groupData.groupId && (!p._action || p._action === 'ADD'));
        if (isPendingGroup) {
          setSyncQueue(prev => prev.map(p => p.groupId === groupData.groupId ? { ...p, parentTitle: groupData.parentTitle, parentDesc: groupData.parentDesc, date: groupData.date } : p));
        } else {
          setSyncQueue(prev => {
            const filtered = prev.filter(q => !(q.groupId === groupData.groupId && q._action === 'UPDATE_GROUP'));
            return [...filtered, { ...groupData, _action: 'UPDATE_GROUP', editor: currentUser.name }];
          });
        }
        setEditingGroup(null);
        showStatus("success", "已暫存母項目修改");
      };

      const handleDeleteTx = (id) => {
        const oldTx = visibleTransactions.find(t => t.id === id);
        if (oldTx) {
          const histRec = {
            timestamp: nowStr(),
            txId: id,
            groupId: oldTx.groupId || "",
            action: 'DELETE',
            editor: currentUser.name,
            snapshot: JSON.stringify({
              '日期時間': oldTx.date, '類別': oldTx.category, '金額': oldTx.amount, '成員': oldTx.member, 
              '備註': oldTx.desc, '類型': oldTx.type, '記錄者': oldTx.recorder, 'ID': oldTx.id, 
              'GroupID': oldTx.groupId, 'ParentDesc': oldTx.parentDesc, 'Beneficiary': oldTx.beneficiary
            })
          };
          setHistoryCache(prev => [histRec, ...prev]);
        }

        setTransactions(prev => prev.filter(t => t.id !== id));
        setTxCache(prev => prev.filter(t => t.id !== id));
        
        const isPendingAdd = syncQueue.some(q => q.id === id && (!q._action || q._action === 'ADD'));
        if (isPendingAdd) {
           setSyncQueue(prev => prev.filter(q => q.id !== id));
        } else {
           setSyncQueue(prev => {
              const filtered = prev.filter(q => q.id !== id);
              return [...filtered, { id: id, _action: 'DELETE', editor: currentUser.name }];
           });
        }
        setEditingTx(null);
        showStatus("success", "已刪除，背景同步中");
      };

      const visibleTransactions = useMemo(() => {
        if (!currentUser) return [];
        const baseList = transactions.length ? transactions : txCache;
        
        const deleteIds = new Set(syncQueue.filter(q => q._action === 'DELETE').map(q => q.id));
        const activeBaseList = baseList.filter(t => !deleteIds.has(t.id));
        
        const updateMap = new Map(syncQueue.filter(q => q._action === 'UPDATE').map(q => [q.id, q]));
        const mergedList = activeBaseList.map(t => updateMap.has(t.id) ? { ...updateMap.get(t.id), isPending: true } : t);

        const pendingAdds = syncQueue
          .filter(q => (!q._action || q._action === 'ADD') && !baseIds.has(q.id))
          .map(t => ({ ...t, isPending: true }));
        
        return [...pendingAdds, ...mergedList];
      }, [currentUser, transactions, txCache, syncQueue]);

      const myTransactions = useMemo(() => {
        if (!currentUser) return [];
        return visibleTransactions.filter(t => t.member === currentUser.name);
      }, [visibleTransactions, currentUser]);

      const stats = useMemo(() => {
        const income = myTransactions.filter(t => t.type === "income").reduce((s,t)=>s+(Number(t.amount)||0),0);
        const expense = myTransactions.filter(t => t.type === "expense").reduce((s,t)=>s+(Number(t.amount)||0),0);
        return { income, expense, balance: income - expense };
      }, [myTransactions]);

      const groupTransactions = (list) => {
        const grouped = []; const groupMap = {};
        for (const rawTx of list) {
          const txHist = historyCache.filter(h => String(h.txId) === String(rawTx.id) && h.action !== 'DELETE')
                                     .sort((a,b) => parseDateForSort(b.timestamp) - parseDateForSort(a.timestamp));
          const tx = { ...rawTx, editHistory: txHist };

          if (tx.groupId) {
            if (!groupMap[tx.groupId]) {
              const parts = String(tx.parentDesc || "").split("|||");
              const pTitle = parts.length > 1 ? parts[0] : (parts[0] || "拆分紀錄");
              const pDesc = parts.length > 1 ? parts[1] : "";
              groupMap[tx.groupId] = {
                isGroup: true, groupId: tx.groupId, parentTitle: pTitle, parentDesc: pDesc, date: tx.date,
                member: tx.member, recorder: tx.recorder, type: tx.type, amount: 0, children: [], isPending: false
              };
              grouped.push(groupMap[tx.groupId]);
            }
            groupMap[tx.groupId].children.push(tx);
            groupMap[tx.groupId].amount += Number(tx.amount || 0);
            if (tx.isPending) groupMap[tx.groupId].isPending = true;
          } else {
            grouped.push({ ...tx, isGroup: false });
          }
        }
        
        const deletedRecords = historyCache.filter(h => h.action === 'DELETE');
        for (const dr of deletedRecords) {
          if (dr.groupId && groupMap[dr.groupId]) {
            if (!groupMap[dr.groupId].children.some(c => String(c.id) === String(dr.txId))) {
               let parsed = normalizeSnapshot(dr.snapshot);
               groupMap[dr.groupId].children.push({
                 ...parsed,
                 id: dr.txId,
                 isDeleted: true,
                 deleteEditor: dr.editor,
                 deleteTime: dr.timestamp,
                 editHistory: historyCache.filter(h => String(h.txId) === String(dr.txId) && h.action !== 'DELETE').sort((a,b) => parseDateForSort(b.timestamp) - parseDateForSort(a.timestamp))
               });
            }
          }
        }

        const groupUpdates = syncQueue.filter(q => q._action === 'UPDATE_GROUP');
        groupUpdates.forEach(gu => {
           const grp = groupMap[gu.groupId];
           if (grp) {
               const parts = String(gu.parentDesc || "").split("|||");
               grp.parentTitle = parts[0] || "拆分紀錄";
               grp.parentDesc = parts[1] || "";
               grp.date = gu.date;
               grp.isPending = true;
           }
        });

        for (const key in groupMap) {
           groupMap[key].children.sort((a, b) => Number(a.id) - Number(b.id));
        }
        
        return grouped;
      };

      const myGroupedAndSorted = useMemo(() => {
        const grouped = groupTransactions(myTransactions);
        return grouped.sort((a, b) => {
           const tA = parseDateForSort(a.date); const tB = parseDateForSort(b.date);
           if (tB !== tA) return tB - tA;
           const idA = a.isGroup ? a.children[0].id : a.id; const idB = b.isGroup ? b.children[0].id : b.id;
           return (Number(idB) || 0) - (Number(idA) || 0);
        });
      }, [myTransactions, syncQueue, historyCache]);

      const checkCatMatch = (tx, filterObj) => {
        const pCat = getParentCat(tx.category);
        const cCat = getChildCat(tx.category);
        const bCat = formatBen(tx.beneficiary, tx.member) || "未知";
        const includes = filterObj.catConditions.filter(c => c.mode === 'include');
        const excludes = filterObj.catConditions.filter(c => c.mode === 'exclude');

        for (let ex of excludes) {
          if (ex.level === 'parent' && pCat === ex.val) return false;
          if (ex.level === 'child' && cCat === ex.val) return false;
          if (ex.level === 'beneficiary' && bCat === ex.val) return false;
        }
        
        if (includes.length > 0) {
          const incParent = includes.filter(c => c.level === 'parent');
          const incChild = includes.filter(c => c.level === 'child');
          const incBen = includes.filter(c => c.level === 'beneficiary');

          if (incParent.length > 0 && !incParent.some(c => c.val === pCat)) return false;
          if (incChild.length > 0 && !incChild.some(c => c.val === cCat)) return false;
          if (incBen.length > 0 && !incBen.some(c => c.val === bCat)) return false;
        }
        return true;
      };

      const filteredHistoryGroups = useMemo(() => {
        if (!currentUser) return [];
        let list = myGroupedAndSorted;

        const cutoff = new Date();
        let useDateFilter = true;
        if (historyFilter.dateType === "7d") cutoff.setDate(cutoff.getDate() - 7);
        else if (historyFilter.dateType === "1m") cutoff.setMonth(cutoff.getMonth() - 1);
        else if (historyFilter.dateType === "3m") cutoff.setMonth(cutoff.getMonth() - 3);
        else if (historyFilter.dateType === "6m") cutoff.setMonth(cutoff.getMonth() - 6);
        else if (historyFilter.dateType === "1y") cutoff.setFullYear(cutoff.getFullYear() - 1);
        else useDateFilter = false;

        let customStartTs = historyFilter.customStart ? new Date(`${historyFilter.customStart}T00:00:00`).getTime() : 0;
        let customEndTs = historyFilter.customEnd ? new Date(`${historyFilter.customEnd}T23:59:59`).getTime() : Infinity;

        let filteredList = [];
        const q = historySearch.trim().toLowerCase();

        for (let item of list) {
          const txTime = parseDateForSort(item.date);
          if (historyFilter.dateType === "custom") {
            if (txTime < customStartTs || txTime > customEndTs) continue;
          } else if (useDateFilter && txTime < cutoff.getTime()) {
            continue;
          }
          if (!historyFilter.types.includes(item.type)) continue;

          const matchesSearch = (tx) => {
            if (!q) return true;
            return String(getParentCat(tx.category)).toLowerCase().includes(q) || 
                   String(getChildCat(tx.category)).toLowerCase().includes(q) || 
                   String(tx.desc || "").toLowerCase().includes(q) || 
                   String(tx.amount || "").includes(q) || 
                   String(tx.date || "").includes(q) || 
                   String(tx.beneficiary || "").toLowerCase().includes(q);
          };

          if (item.isGroup) {
            const validChildren = item.children.filter(c => {
               if (historyFilter.minAmount && Number(c.amount) < Number(historyFilter.minAmount)) return false;
               if (historyFilter.maxAmount && Number(c.amount) > Number(historyFilter.maxAmount)) return false;
               return checkCatMatch(c, historyFilter) && matchesSearch(c);
            });
            const groupMatchesSearch = !q || String(item.parentTitle || "").toLowerCase().includes(q) || String(item.parentDesc || "").toLowerCase().includes(q);
            const finalChildren = groupMatchesSearch ? item.children.filter(c => checkCatMatch(c, historyFilter)) : validChildren;

            if (finalChildren.length > 0) {
              filteredList.push({
                ...item,
                children: finalChildren,
                amount: finalChildren.filter(c => !c.isDeleted).reduce((s, c) => s + (Number(c.amount)||0), 0)
              });
            }
          } else {
            if (historyFilter.minAmount && Number(item.amount) < Number(historyFilter.minAmount)) continue;
            if (historyFilter.maxAmount && Number(item.amount) > Number(historyFilter.maxAmount)) continue;
            if (checkCatMatch(item, historyFilter) && matchesSearch(item)) filteredList.push(item);
          }
        }
        return filteredList;
      }, [myGroupedAndSorted, currentUser, historyFilter, historySearch]);

      const isHistoryFiltered = useMemo(() => {
        return historySearch.trim() !== "" || 
               historyFilter.dateType !== 'all' || 
               historyFilter.types.length < 2 || 
               historyFilter.catConditions.length > 0 || 
               historyFilter.minAmount !== '' || 
               historyFilter.maxAmount !== '';
      }, [historySearch, historyFilter]);

      const historyTotals = useMemo(() => {
        let exp = 0, inc = 0;
        filteredHistoryGroups.forEach(item => {
           if (item.isGroup) {
              item.children.forEach(c => {
                 if (c.isDeleted) return;
                 if (c.type === 'expense') exp += (Number(c.amount)||0);
                 else inc += (Number(c.amount)||0);
              });
           } else {
              if (item.isDeleted) return;
              if (item.type === 'expense') exp += (Number(item.amount)||0);
              else inc += (Number(item.amount)||0);
           }
        });
        return { exp, inc };
      }, [filteredHistoryGroups]);

      const filteredAnalysisTxs = useMemo(() => {
        if (!currentUser) return [];
        const cutoff = new Date();
        let useDateFilter = true;
        if (analysisFilter.dateType === "7d") cutoff.setDate(cutoff.getDate() - 7);
        else if (analysisFilter.dateType === "1m") cutoff.setMonth(cutoff.getMonth() - 1);
        else if (analysisFilter.dateType === "3m") cutoff.setMonth(cutoff.getMonth() - 3);
        else if (analysisFilter.dateType === "6m") cutoff.setMonth(cutoff.getMonth() - 6);
        else if (analysisFilter.dateType === "1y") cutoff.setFullYear(cutoff.getFullYear() - 1);
        else useDateFilter = false;

        let customStartTs = analysisFilter.customStart ? new Date(`${analysisFilter.customStart}T00:00:00`).getTime() : 0;
        let customEndTs = analysisFilter.customEnd ? new Date(`${analysisFilter.customEnd}T23:59:59`).getTime() : Infinity;

        return visibleTransactions.filter(t => {
          if (t.member !== currentUser.name || t.isDeleted) return false;
          if (analysisFilter.minAmount && Number(t.amount) < Number(analysisFilter.minAmount)) return false;
          if (analysisFilter.maxAmount && Number(t.amount) > Number(analysisFilter.maxAmount)) return false;

          const txTime = parseDateForSort(t.date);
          if (analysisFilter.dateType === "custom") {
            if (txTime < customStartTs || txTime > customEndTs) return false;
          } else if (useDateFilter && txTime < cutoff.getTime()) {
            return false;
          }

          if (analysisType === "expense" || analysisType === "income") {
            if (t.type !== analysisType) return false;
          } else if (analysisType === "beneficiary") {
            if (t.type !== "expense") return false;
          }

          if (!checkCatMatch(t, analysisFilter)) return false;
          return true;
        });
      }, [visibleTransactions, analysisFilter, analysisType, currentUser]);

      const analysisData = useMemo(() => {
        let level1Data = {};
        filteredAnalysisTxs.forEach(t => {
          const benGroup = formatBen(t.beneficiary, t.member) || t.member;
          const amt = Number(t.amount) || 0;
          const p = getParentCat(t.category);
          const c = getChildCat(t.category);

          const b = benGroup;
          if (!level1Data[b]) level1Data[b] = { total: 0, parents: {} };
          level1Data[b].total += amt;

          if (!level1Data[b].parents[p]) level1Data[b].parents[p] = { total: 0, children: {} };
          level1Data[b].parents[p].total += amt;

          if (!level1Data[b].parents[p].children[c]) level1Data[b].parents[p].children[c] = 0;
          level1Data[b].parents[p].children[c] += amt;
        });
        return level1Data;
      }, [filteredAnalysisTxs]);

      const totalAnalysisAmount = useMemo(() => Object.values(analysisData).reduce((s,v) => s + v.total, 0), [analysisData]);

      const toggleGroup = (gId) => setExpandedGroups(p => ({ ...p, [gId]: !p[gId] }));

      const jumpToHistoryFromChart = (childCat, benCat = null, parentCat = null) => {
        const newConds = [{ mode: 'include', level: 'child', val: childCat, id: Date.now() }];
        if (parentCat) newConds.push({ mode: 'include', level: 'parent', val: parentCat, id: Date.now() + 1 });
        if (benCat) newConds.push({ mode: 'include', level: 'beneficiary', val: benCat, id: Date.now() + 2 });

        setHistoryFilter({
          dateType: analysisFilter.dateType,
          customStart: analysisFilter.customStart,
          customEnd: analysisFilter.customEnd,
          types: [analysisType === 'beneficiary' ? 'expense' : analysisType],
          catConditions: newConds,
          minAmount: analysisFilter.minAmount, 
          maxAmount: analysisFilter.maxAmount
        });
        setHistorySearch("");
        setActiveTab("history");
      };

      const renderStandaloneCard = (tx, allowEdit = true) => {
        const rawBen = formatBen(tx.beneficiary, tx.member);
        const benTag = rawBen === currentUser.name ? "" : rawBen;
        const showBenTag = benTag !== "";
        const hasHistory = tx.editHistory && tx.editHistory.length > 0;

        return (
          <div key={tx.id} className="bg-white rounded-3xl border border-gray-100 flex items-center gap-2 sm:gap-3 shadow-sm relative overflow-hidden mb-3 pr-2 sm:pr-3">
            {tx.isPending && (
              <div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[9px] font-black px-2 py-1 rounded-bl-xl shadow-sm z-10 flex items-center gap-1">
                <SvgIcon name="refresh" size={10} className="animate-spin opacity-70" /> 未同步
              </div>
            )}
            <div className="flex-1 p-3 sm:p-4 flex items-center gap-2 sm:gap-3 pr-0 mt-1">
              <div className="relative shrink-0">
                <div className={`w-11 h-11 sm:w-12 sm:h-12 rounded-2xl flex items-center justify-center font-black text-[15px] leading-none ${tx.type==="income" ? "bg-green-600 text-white" : "bg-red-600 text-white"}`}>
                  {tx.type==="income" ? "收入" : "支出"}
                </div>
                {tx.member !== currentUser.name && (
                  <div className={`absolute -top-2 -left-2 text-[9px] font-black px-1.5 py-0.5 rounded-lg border-2 border-white shadow-sm ${tx.member === "爸爸" ? "bg-blue-600" : tx.member === "媽媽" ? "bg-pink-600" : "bg-gray-500"} text-white z-10`}>
                    {tx.member}
                  </div>
                )}
              </div>
              <div className="flex-1 min-w-0 pl-1">
                <div className="font-bold text-[14px] sm:text-[15px] truncate text-gray-800 flex items-center gap-1.5 flex-wrap">
                  {getParentCat(tx.category)} - {getChildCat(tx.category)}
                  {showBenTag && <span className="bg-gray-100 text-gray-500 text-[9px] px-1.5 py-0.5 rounded-md border border-gray-200 break-keep">{benTag}</span>}
                  {hasHistory && (
                    <span onClick={(e) => { e.stopPropagation(); setViewingHistory(tx); }} className="bg-blue-50 text-blue-500 text-[9px] px-1.5 py-0.5 rounded-md border border-blue-100 cursor-pointer flex items-center gap-0.5 active:bg-blue-100">
                      📝 已編輯({tx.editHistory.length})
                    </span>
                  )}
                </div>
                <div className="flex flex-col gap-1 mt-1.5 w-full">
                  <span className="text-[10px] text-gray-400 font-medium leading-none">{displayDateClean(tx.date)}</span>
                  {tx.desc && <span className="text-[11px] text-gray-600 font-bold bg-gray-50 px-2 py-1 rounded-lg whitespace-normal break-words w-full">{tx.desc}</span>}
                </div>
              </div>
              <div className="flex flex-col items-end justify-center shrink-0 pl-1">
                <div className={`font-black tabular-nums text-base sm:text-lg leading-none ${tx.type==="income" ? "text-green-600" : "text-red-600"}`}>
                  ${Number(tx.amount||0).toLocaleString()}
                </div>
                {tx.recorder && tx.recorder !== tx.member && (
                  <div className={`mt-1.5 text-[9px] font-black px-1.5 py-0.5 rounded-md border shadow-sm ${tx.recorder === "爸爸" ? "bg-blue-50 text-blue-600 border-blue-200" : tx.recorder === "媽媽" ? "bg-pink-50 text-pink-600 border-pink-200" : "bg-gray-50 text-gray-500 border-gray-200"}`}>
                    ✍️ {tx.recorder}代記
                  </div>
                )}
              </div>
            </div>
            {allowEdit && !tx.isDeleted && (
              <button onClick={(e) => { e.stopPropagation(); setEditingTx(tx); }} className="w-8 h-8 shrink-0 bg-blue-50/80 text-blue-600 rounded-xl flex items-center justify-center active:scale-90 transition-transform shadow-sm mt-1">
                <SvgIcon name="edit" size={14} />
              </button>
            )}
          </div>
        );
      };

      const renderGroupCard = (group, allowEdit = true) => {
        const isExp = !!expandedGroups[group.groupId];
        const allBens = new Set();
        group.children.forEach(c => { if(c.beneficiary) c.beneficiary.split(",").filter(Boolean).forEach(b => allBens.add(b)); });
        const rawParentBen = formatBen(Array.from(allBens).join(","), group.member);
        const parentBenTag = rawParentBen === currentUser.name ? "" : rawParentBen;

        return (
          <div key={group.groupId} className="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden mb-3 transition-all duration-300 relative">
            {group.isPending && (
              <div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-[9px] font-black px-2 py-1 rounded-bl-xl shadow-sm z-20 flex items-center gap-1">
                <SvgIcon name="refresh" size={10} className="animate-spin opacity-70" /> 未同步
              </div>
            )}
            <div className="flex items-center pr-2 sm:pr-3 cursor-pointer active:bg-gray-50 transition-colors relative mt-1" onClick={() => toggleGroup(group.groupId)}>
              <div className="flex-1 p-3 sm:p-4 flex items-center gap-2 sm:gap-3 pr-0">
                <div className="relative shrink-0">
                  <div className={`w-11 h-11 sm:w-12 sm:h-12 rounded-2xl flex items-center justify-center font-black text-[15px] leading-none ${group.type==="income" ? "bg-green-600 text-white" : "bg-red-600 text-white"}`}>
                    {group.type==="income" ? "收入" : "支出"}
                  </div>
                  <div className="absolute -bottom-1 -right-1 bg-gray-800 text-white text-[9px] font-black px-1.5 py-0.5 rounded-md border-2 border-white shadow-sm z-10">多筆</div>
                  {group.member !== currentUser.name && (
                    <div className={`absolute -top-2 -left-2 text-[9px] font-black px-1.5 py-0.5 rounded-lg border-2 border-white shadow-sm ${group.member === "爸爸" ? "bg-blue-600" : group.member === "媽媽" ? "bg-pink-600" : "bg-gray-500"} text-white z-10`}>{group.member}</div>
                  )}
                </div>
                <div className="flex-1 min-w-0 pl-1">
                  <div className="font-bold text-[14px] sm:text-[15px] truncate text-gray-800 flex items-center gap-1.5 flex-wrap">
                    {group.parentTitle}
                    {parentBenTag && <span className="bg-gray-100 text-gray-500 text-[9px] px-1.5 py-0.5 rounded-md border border-gray-200 break-keep">{parentBenTag}</span>}
                    <span className={`text-[10px] text-gray-400 transform transition-transform duration-300 ${isExp ? 'rotate-180' : ''}`}>▼</span>
                  </div>
                  <div className="flex flex-col gap-1 mt-1 w-full">
                    <span className="text-[10px] text-gray-400 font-medium leading-none">{displayDateClean(group.date)}</span>
                    {group.parentDesc && <span className="text-[11px] text-gray-600 font-bold bg-gray-50 px-2 py-1 rounded-lg whitespace-normal break-words w-full">{group.parentDesc}</span>}
                  </div>
                </div>
                <div className="flex flex-col items-end justify-center shrink-0 pl-1">
                  <div className={`font-black tabular-nums text-lg sm:text-xl leading-none ${group.type==="income" ? "text-green-600" : "text-red-600"}`}>
                    ${Number(group.amount||0).toLocaleString()}
                  </div>
                  {group.recorder && group.recorder !== group.member && (
                    <div className={`mt-1.5 text-[9px] font-black px-1.5 py-0.5 rounded-md border shadow-sm ${group.recorder === "爸爸" ? "bg-blue-50 text-blue-600 border-blue-200" : group.recorder === "媽媽" ? "bg-pink-50 text-pink-600 border-pink-200" : "bg-gray-50 text-gray-500 border-gray-200"}`}>✍️ {group.recorder}代記</div>
                  )}
                </div>
              </div>
              {allowEdit && (
                <button onClick={(e) => { e.stopPropagation(); setEditingGroup(group); }} className="w-8 h-8 shrink-0 bg-blue-50/80 text-blue-600 rounded-xl flex items-center justify-center active:scale-90 transition-transform shadow-sm">
                  <SvgIcon name="edit" size={14} />
                </button>
              )}
            </div>

            {isExp && (
              <div className="bg-gray-50/80 p-2 sm:p-3 flex flex-col gap-2 border-t-2 border-gray-100 shadow-inner relative">
                {group.children.map((child, idx) => {
                  const rawChildBen = formatBen(child.beneficiary, group.member);
                  const childBenTag = rawChildBen === currentUser.name ? "" : rawChildBen;
                  const hasHistory = child.editHistory && child.editHistory.length > 0;
                  return (
                    <div key={child.id} className="flex items-center gap-2 pr-1 relative">
                      <div className={`flex-1 flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-2xl shadow-sm border border-gray-200 pr-3 ${child.isDeleted ? 'opacity-60 bg-gray-100' : 'bg-white'}`}>
                        <div className="w-5 h-5 sm:w-6 sm:h-6 rounded-full bg-gray-100 text-gray-400 text-[9px] sm:text-[10px] font-black flex items-center justify-center shrink-0">{idx + 1}</div>
                        <div className="flex-1 min-w-0 pr-1 sm:pr-2 border-r border-gray-100">
                          <div className="font-bold text-xs sm:text-sm text-gray-800 flex items-center gap-1 sm:gap-2 flex-wrap">
                            <span className={child.isDeleted ? 'line-through text-gray-400' : ''}>{getParentCat(child.category)} - {getChildCat(child.category)}</span>
                            {childBenTag && <span className="bg-gray-100 text-gray-500 text-[8px] px-1 py-0.5 rounded-md border border-gray-200 break-keep">{childBenTag}</span>}
                            {hasHistory && !child.isDeleted && (
                              <span onClick={(e) => { e.stopPropagation(); setViewingHistory(child); }} className="bg-blue-50 text-blue-500 text-[8px] px-1.5 py-0.5 rounded-md border border-blue-100 cursor-pointer flex items-center gap-0.5 active:bg-blue-100">
                                📝({child.editHistory.length})
                              </span>
                            )}
                          </div>
                          {child.desc && <div className="text-[10px] sm:text-[11px] text-gray-500 mt-0.5 whitespace-normal break-words">{child.desc}</div>}
                          {child.isDeleted && <div className="text-[9px] text-red-500 mt-0.5 font-bold">由 {child.deleteEditor} 刪除於 {displayDateClean(child.deleteTime)}</div>}
                        </div>
                        <div className={`font-black tabular-nums text-xs sm:text-sm shrink-0 w-14 sm:w-16 text-right ${child.isDeleted ? 'line-through text-gray-400' : child.type==="income" ? "text-green-600" : "text-gray-600"}`}>
                          ${Number(child.amount||0).toLocaleString()}
                        </div>
                      </div>
                      {allowEdit && !child.isDeleted && (
                        <button onClick={(e) => { e.stopPropagation(); setEditingTx(child); }} className="w-7 h-7 shrink-0 bg-blue-50/80 text-blue-600 rounded-lg flex items-center justify-center active:scale-90 transition-transform shadow-sm border border-blue-100">
                          <SvgIcon name="edit" size={12} />
                        </button>
                      )}
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        );
      };

      const [animTrigger, setAnimTrigger] = useState(false);
      useEffect(() => {
        if (activeTab === "analysis") { setAnimTrigger(false); setTimeout(() => setAnimTrigger(true), 50); }
      }, [activeTab, analysisType, analysisFilter.dateType, selectedAnalysisLevel1, selectedAnalysisLevel2]);

      const handleUserClick = async (user) => {
        setSelectingUser(user);
        setPinInput("");
        setFallbackToPin(false);
        if (biometricAvailable && isDeviceBioBound(user.name)) {
          const ok = await handleBioLoginLocal(user.name);
          if (ok) {
            setCurrentUser(user);
            setSelectingUser(null);
            setPinInput("");
            if (navigator.onLine && deviceValid()) { setTimeout(() => syncDataToCloud(true), 50); }
          } else {
            setFallbackToPin(true);
          }
        }
      };

      if (!currentUser) {
        return (
          <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-8 animate-in relative w-full text-center font-black">
            {!selectingUser ? (
              <>
                <div className="mb-12 text-white animate-in">
                  <div className="bg-blue-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-blue-500/30 text-white">
                    <SvgIcon name="wallet" size={36} />
                  </div>
                  <h1 className="text-4xl font-black italic tracking-tighter">家庭記帳</h1>
                  <p className="text-gray-500 text-[10px] font-mono mt-4 opacity-50 uppercase tracking-[0.3em]">v{APP_VERSION}</p>
                  <div className="mt-5 flex items-center justify-center">
                    <span className={`px-4 py-1.5 text-sm font-bold tracking-widest rounded-xl shadow-sm ${navigator.onLine ? "bg-green-600/20 text-green-300 border border-green-500/20" : "bg-red-600/20 text-red-300 border border-red-500/20"}`}>
                      {navigator.onLine ? "線上" : "離線"}
                    </span>
                  </div>
                </div>

                <div className="grid grid-cols-1 gap-6 w-full max-w-xs text-white animate-in">
                  {familyConfig.map(user => (
                    <button key={user.name} onClick={() => handleUserClick(user)} className={`${user.color || (user.name==="媽媽"?"bg-pink-600":"bg-blue-600")} py-6 rounded-[2.5rem] font-black text-2xl shadow-lg border-4 border-white/5 active:scale-95 transition-all text-white`}>
                      {user.name}
                    </button>
                  ))}
                </div>
              </>
            ) : (
              <div className="w-full max-w-sm animate-in text-white text-center font-black">
                <div className="bg-gray-800 rounded-[2.5rem] p-8 shadow-2xl border border-white/10 relative">
                  <div className={`${selectingUser.color || (selectingUser.name==="媽媽"?"bg-pink-600":"bg-blue-600")} w-16 h-16 mx-auto rounded-[1.5rem] flex items-center justify-center text-white font-black text-2xl shadow-lg mb-4`}>
                    {selectingUser.name.charAt(0)}
                  </div>
                  <p className="font-black text-3xl mb-1 tracking-tight text-white">{selectingUser.name}</p>
                  
                  <p className="text-gray-400 text-xs font-bold uppercase tracking-widest opacity-80 mb-8">
                    {isDeviceBioBound(selectingUser.name) && !fallbackToPin ? "請進行生物辨識解鎖" : "輸入 6 位 PIN 解鎖"}
                  </p>

                  {isDeviceBioBound(selectingUser.name) && !fallbackToPin ? (
                    <div className="flex flex-col items-center mb-8 animate-in">
                      <button onClick={async () => {
                          const ok = await handleBioLoginLocal(selectingUser.name);
                          if (ok) {
                            setCurrentUser(selectingUser); setSelectingUser(null); setPinInput("");
                            if (navigator.onLine && deviceValid()) setTimeout(() => syncDataToCloud(true), 50);
                          } else {
                            setFallbackToPin(true);
                          }
                      }} className="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center border-2 border-blue-500/50 mb-6 active:scale-95 transition-transform">
                         <SvgIcon name="bio" size={36} />
                      </button>
                      <button onClick={() => setFallbackToPin(true)} className="text-[11px] text-gray-400 underline underline-offset-4 font-bold active:text-white transition-colors">
                         無法辨識？改用 PIN 碼登入
                      </button>
                    </div>
                  ) : (
                    <>
                      <div className="flex justify-center gap-3 mb-10">
                        {[...Array(6)].map((_, i) => <div key={i} className={`w-3.5 h-3.5 rounded-full border-2 border-blue-500 transition-all duration-200 ${pinInput.length > i ? "bg-blue-500 scale-125 shadow-[0_0_12px_#3b82f6]" : "bg-transparent"}`}></div>)}
                      </div>
                      <div className="grid grid-cols-3 gap-3 mb-8 text-white">
                        {[1,2,3,4,5,6,7,8,9,"C",0,"←"].map(k => (
                          <button key={k} onClick={async () => {
                              if (k === "C") { setPinInput(""); return; }
                              if (k === "←") { setPinInput(pinInput.slice(0,-1)); return; }
                              const n = pinInput + k; if (n.length > 6) return; setPinInput(n);
                              if (n.length === 6) {
                                try {
                                  if (navigator.onLine) {
                                    if (!deviceValid()) { showStatus("error", "雲端尚未綁定，請先輸入雲端密碼"); setShowBootstrapModal(true); setPinInput(""); return; }
                                    setLoadingCard({ show:true, text:"正在驗證..." }); await verifyPinOnline(selectingUser.name, n);
                                    setLoadingCard({ show:false, text:"" }); await saveLocalPinHash(selectingUser.name, n);
                                  } else {
                                    const ok = await unlockWithPinLocal(selectingUser.name, n);
                                    if (!ok) { showStatus("error", "PIN 錯誤（離線需先線上驗證過一次）"); setPinInput(""); return; }
                                  }
                                  setCurrentUser(selectingUser); setSelectingUser(null); setPinInput(""); setFallbackToPin(false);
                                  if (navigator.onLine && deviceValid()) { setTimeout(() => syncDataToCloud(true), 50); }
                                } catch (e) { setLoadingCard({ show:false, text:"" }); showStatus("error", e.message || "PIN 錯誤"); setPinInput(""); }
                              }
                            }} className="bg-white/5 h-16 rounded-2xl font-black text-2xl active:bg-blue-600 transition-all border border-white/5 text-white shadow-sm hover:bg-white/10">
                            {k}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                  
                  <button onClick={() => { setSelectingUser(null); setPinInput(""); setFallbackToPin(false); }} className="text-red-400 text-xs font-black uppercase tracking-widest underline underline-offset-4 active:text-red-300 transition-colors">返回成員列表</button>
                </div>
              </div>
            )}

            {showBootstrapModal && (
              <div className="fixed inset-0 z-[600] bg-gray-900/90 backdrop-blur-md flex items-center justify-center p-8 animate-in">
                <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-gray-900 relative">
                  <h3 className="font-black text-lg mb-2">首次綁定雲端</h3>
                  <p className="text-[11px] text-gray-500 mb-5">請輸入雲端密碼（爸爸手機號碼）。</p>
                  <input value={bootstrapSecret} onChange={(e)=>setBootstrapSecret(e.target.value)} placeholder="輸入爸爸手機號碼" className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-5" />
                  <button onClick={async () => {
                      try {
                        setLoadingCard({ show:true, text:"正在綁定雲端..." }); await bootstrapDevice();
                        setShowBootstrapModal(false); setBootstrapSecret(""); showStatus("success","雲端已綁定");
                      } catch (e) { showStatus("error", e.message || "雲端密碼錯誤"); } finally { setLoadingCard({ show:false, text:"" }); }
                    }} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black active:scale-95 disabled:opacity-40" disabled={isLoading}>
                    確認
                  </button>
                </div>
              </div>
            )}
            {statusMsg.text && (
              <div className="fixed bottom-12 left-0 right-0 flex justify-center z-[1000] pointer-events-none px-4 text-center">
                <div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === "success" ? "bg-green-600 text-white" : statusMsg.type === "error" ? "bg-red-600 text-white" : "bg-blue-600 text-white"}`}>
                  <span className="text-sm font-bold tracking-tight text-center">{statusMsg.text}</span>
                </div>
              </div>
            )}
            {loadingCard?.show && (
              <div className="fixed inset-0 z-[900] bg-gray-900/70 backdrop-blur-sm flex items-center justify-center p-8">
                <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-gray-900 shadow-2xl animate-in flex flex-col items-center justify-center text-center">
                  <div className="w-14 h-14 rounded-2xl bg-blue-50 flex items-center justify-center mb-4"><SvgIcon name="refresh" size={28} className="animate-spin text-blue-600"/></div>
                  <div className="font-black text-lg">處理中</div>
                  <div className="text-xs text-gray-500 mt-2 font-bold">{loadingCard.text || "請稍候..."}</div>
                </div>
              </div>
            )}
          </div>
        );
      }

      const bioBound = currentUser ? isDeviceBioBound(currentUser.name) : false;

      return (
        <div className="min-h-screen bg-gray-50 text-gray-900 pb-28 max-w-md mx-auto relative flex flex-col overflow-x-hidden w-full text-left font-black">
          {viewingHistory && <ViewEditHistoryModal tx={viewingHistory} onClose={() => setViewingHistory(null)} />}
          {editingTx && <EditTransactionModal tx={editingTx} loginUser={currentUser.name} onSave={handleUpdateTx} onDelete={handleDeleteTx} onCancel={() => { setEditingTx(null); setEditingIsPending(false); }} isLoading={isLoading} />}
          {editingGroup && <EditGroupParentModal group={editingGroup} onSave={handleUpdateGroupParent} onCancel={() => setEditingGroup(null)} isLoading={isLoading} />}
          
          {/* 歷史頁面的獨立過濾器 */}
          <AdvancedFilterModal 
            isOpen={showHistoryFilter} 
            onClose={() => setShowHistoryFilter(false)} 
            filterState={historyFilter} 
            setFilterState={setHistoryFilter} 
            transactions={myTransactions} 
          />

          {/* 分析頁面的獨立過濾器 */}
          <AdvancedFilterModal 
            isOpen={showAnalysisFilter} 
            onClose={() => setShowAnalysisFilter(false)} 
            filterState={analysisFilter} 
            setFilterState={setAnalysisFilter} 
            transactions={myTransactions} 
          />
          
          {showUnbindModal && (
            <div className="fixed inset-0 z-[350] bg-gray-900/90 backdrop-blur-md flex items-center justify-center p-8 animate-in text-white" onClick={(e) => { if(e.target === e.currentTarget) {setShowUnbindModal(false); setUnbindPin("");} }}>
              <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-gray-900 relative">
                <button onClick={() => { setShowUnbindModal(false); setUnbindPin(""); }} className="absolute top-6 right-6 text-gray-400 active:scale-90"><SvgIcon name="close" size={24}/></button>
                <h3 className="font-black text-lg mb-2">解除綁定</h3>
                <p className="text-[11px] text-gray-500 mb-5">請輸入 PIN 驗證後才能解除。</p>
                <input value={unbindPin} onChange={(e)=>setUnbindPin(e.target.value.replace(/\D/g,"").slice(0,6))} inputMode="numeric" placeholder="輸入 6 位 PIN" className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-4" />
                <button onClick={unbindDeviceBio} className="w-full py-4 bg-red-600 text-white rounded-2xl font-black active:scale-95 disabled:opacity-40" disabled={isLoading}>確認解除</button>
              </div>
            </div>
          )}

          {showChangePinModal && (
            <div className="fixed inset-0 z-[360] bg-gray-900/90 backdrop-blur-md flex items-center justify-center p-8 animate-in text-white" onClick={(e) => { if(e.target === e.currentTarget) setShowChangePinModal(false); }}>
              <div className="bg-white w-full max-w-xs rounded-[2.5rem] p-8 text-gray-900 relative">
                <button onClick={() => setShowChangePinModal(false)} className="absolute top-6 right-6 text-gray-400 active:scale-90"><SvgIcon name="close" size={24}/></button>
                <h3 className="font-black text-lg mb-2">更換密碼</h3>
                <p className="text-[11px] text-gray-500 mb-5">需輸入舊 PIN 驗證，成功後會登出請重新登入。</p>
                <input value={oldPin} onChange={(e)=>setOldPin(e.target.value.replace(/\D/g,"").slice(0,6))} inputMode="numeric" placeholder="舊 PIN（6 位）" className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-3" />
                <input value={newPin} onChange={(e)=>setNewPin(e.target.value.replace(/\D/g,"").slice(0,6))} inputMode="numeric" placeholder="新 PIN（6 位）" className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-3" />
                <input value={newPin2} onChange={(e)=>setNewPin2(e.target.value.replace(/\D/g,"").slice(0,6))} inputMode="numeric" placeholder="再次輸入新 PIN" className="w-full bg-gray-100 rounded-2xl px-4 py-3 font-black outline-none mb-5" />
                <button onClick={changePin} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black active:scale-95 disabled:opacity-40" disabled={isLoading}>確認更換</button>
              </div>
            </div>
          )}

          <header className="px-4 sm:px-6 pt-12 pb-4 sm:pb-6 bg-white sticky top-0 z-40 flex justify-between items-center border-b border-gray-100 shrink-0 text-gray-800 shadow-sm">
            <div className="flex items-center gap-3 text-left">
              <div className={`${currentUser.color || (currentUser.name==="媽媽"?"bg-pink-600":"bg-blue-600")} w-11 h-11 rounded-2xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-blue-500/30`}>
                {currentUser.name.charAt(0)}
              </div>
              <div className="flex flex-col justify-center">
                <h1 className="text-xl font-black tracking-tighter italic leading-none mb-1">家庭記帳</h1>
                <p className="text-[10px] text-gray-400 font-bold tracking-widest leading-none">{customSubtitle.replace(/{name}/g, currentUser.name)}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <div className="text-right leading-none hidden sm:block mr-1">
                <p className="text-[7px] text-gray-300 uppercase font-black tracking-tighter mb-0.5">Last Sync</p>
                <p className="text-[11px] text-blue-500 font-mono font-black">{lastSyncText}</p>
              </div>
              <button onClick={() => syncDataToCloud(true)} disabled={isLoading} className="relative p-2.5 bg-blue-50 text-blue-600 rounded-xl active:scale-90 transition-all flex flex-col items-center justify-center border border-blue-100 disabled:opacity-50">
                <SvgIcon name="cloud" size={18} className={isSyncing ? "animate-pulse text-blue-400" : ""}/>
                <span className={`text-[8px] font-black mt-0.5 ${isSyncing ? "text-blue-500" : navigator.onLine ? "text-green-500" : "text-gray-400"}`}>
                  {isSyncing ? "同步中" : navigator.onLine ? "線上" : "離線"}
                </span>
                {syncQueue.length > 0 && <span className="absolute -top-1.5 -right-1.5 bg-yellow-400 text-yellow-900 text-[9px] font-black px-1.5 py-0.5 rounded-full border-2 border-white leading-none shadow-sm min-w-[20px] text-center">{syncQueue.length}</span>}
              </button>
            </div>
          </header>

          <main className="p-4 sm:p-6 flex-1 overflow-y-auto scrollbar-hide text-gray-800">
            {activeTab === "dashboard" && (
              <div className="space-y-6 animate-in">
                <div className="bg-gray-900 p-8 rounded-[3rem] shadow-2xl text-white relative overflow-hidden text-center">
                  <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-[60px] rounded-full"></div>
                  <span className="text-[10px] font-black uppercase mb-3 block tracking-widest text-blue-200">本月估算結餘</span>
                  <div className="text-5xl font-black mb-8 tracking-tighter tabular-nums">${stats.balance.toLocaleString()}</div>
                  <div className="flex w-full gap-4 pt-6 border-t border-white/10 text-sm text-gray-300">
                    <div className="flex-1 text-center"><p className="text-[9px] uppercase mb-1 font-black">收入</p><p className="text-xl text-green-400 font-black">+${stats.income.toLocaleString()}</p></div>
                    <div className="flex-1 border-l border-white/10 text-center"><p className="text-[9px] uppercase mb-1 font-black">支出</p><p className="text-xl text-red-400 font-black">-${stats.expense.toLocaleString()}</p></div>
                  </div>
                </div>

                <div className="space-y-4 text-left">
                  <h3 className="font-black text-lg px-1 text-gray-800 flex items-center gap-2">
                    最新動態
                  </h3>
                  <div className="space-y-3">
                    {myGroupedAndSorted.slice(0, 5).map(item => renderItemOrGroup(item, false))}
                  </div>
                </div>
              </div>
            )}

            {activeTab === "history" && (
              <div className="space-y-4 animate-in pb-20 text-left">
                <div className="flex items-center justify-between px-1 mb-4 gap-2">
                  <h3 className="font-black text-xl text-gray-800 shrink-0">歷史清單</h3>
                  
                  {/* 縮小並排的搜尋列與篩選按鈕 */}
                  <div className="flex-1 flex items-center justify-end gap-1.5">
                    <div className="relative w-full max-w-[150px]">
                      <div className="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none"><SvgIcon name="search" size={14} className="text-gray-400" /></div>
                      <input type="text" value={historySearch} onChange={(e) => setHistorySearch(e.target.value)} placeholder="搜尋..." className="w-full pl-8 pr-3 py-2 bg-white border border-gray-200 rounded-xl font-black text-xs outline-none focus:ring-2 focus:ring-blue-500/20 transition-all text-gray-800 placeholder:text-gray-400 shadow-sm" />
                    </div>
                    
                    <button onClick={() => setShowHistoryFilter(true)} className={`p-2 flex items-center justify-center rounded-xl transition-colors shadow-sm ${isHistoryFiltered ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'}`}>
                      <SvgIcon name="filter" size={16} />
                    </button>

                    {/* 預設回全部按鈕 */}
                    {isHistoryFiltered && (
                      <button onClick={() => { setHistorySearch(""); setHistoryFilter({dateType: 'all', customStart: '', customEnd: '', types: ['expense', 'income'], catConditions: [], minAmount: '', maxAmount: ''}); }} className="px-2.5 py-2 bg-red-50 text-red-600 rounded-xl font-black text-[10px] whitespace-nowrap shadow-sm active:scale-95 transition-all">
                        回全部
                      </button>
                    )}
                  </div>
                </div>

                {/* 篩選結果總計 */}
                {isHistoryFiltered && (
                  <div className="flex justify-between items-center bg-gray-800 p-4 rounded-[1.5rem] shadow-sm text-white mb-2 animate-in">
                    <div className="text-[10px] font-black uppercase tracking-widest text-gray-400">當前條件總計</div>
                    <div className="flex gap-4 text-xs font-black">
                      <span className="text-red-400">支 ${historyTotals.exp.toLocaleString()}</span>
                      <span className="text-green-400">收 ${historyTotals.inc.toLocaleString()}</span>
                    </div>
                  </div>
                )}
                
                {/* 顯示目前的篩選條件標籤 */}
                {isHistoryFiltered && (
                  <div className="flex flex-wrap gap-2 px-1 mb-2">
                     {historyFilter.dateType !== 'all' && <span className="px-2 py-1 bg-gray-200 text-gray-600 rounded-lg text-[10px] font-bold">指定時間</span>}
                     {historyFilter.types.length === 1 && <span className={`px-2 py-1 rounded-lg text-[10px] font-bold ${historyFilter.types[0] === 'expense' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>僅{historyFilter.types[0] === 'expense' ? '支出' : '收入'}</span>}
                     {(historyFilter.minAmount || historyFilter.maxAmount) && <span className="px-2 py-1 bg-gray-200 text-gray-600 rounded-lg text-[10px] font-bold">指定金額</span>}
                     {historyFilter.catConditions.map(c => (
                       <span key={c.id} className={`px-2 py-1 rounded-lg text-[10px] font-bold ${c.mode === 'include' ? 'bg-blue-100 text-blue-600' : 'bg-gray-200 text-gray-600 line-through'}`}>{c.val}</span>
                     ))}
                  </div>
                )}

                <div className="space-y-3">
                  {filteredHistoryGroups.slice(0, historyVisibleCount).map(item => renderItemOrGroup(item, true))}
                  {historyVisibleCount < filteredHistoryGroups.length && (
                    <button onClick={() => setHistoryVisibleCount(prev => prev + 20)} className="w-full py-4 bg-white border border-gray-200 text-blue-600 rounded-2xl font-black text-xs active:bg-gray-50 transition-colors shadow-sm mt-4 flex justify-center items-center gap-2">
                      <SvgIcon name="refresh" size={14} className="text-blue-500" /> 載入更多紀錄 ({historyVisibleCount} / {filteredHistoryGroups.length})
                    </button>
                  )}
                  {filteredHistoryGroups.length === 0 && <div className="text-center py-10 flex flex-col items-center gap-2"><span className="text-gray-400 text-sm font-bold">尚無符合條件的紀錄</span></div>}
                </div>
              </div>
            )}

            {activeTab === "analysis" && (
              <div className="space-y-6 animate-in pb-20 text-left">
                <div className="flex justify-between items-center px-1 mb-2">
                  <h3 className="font-black text-xl text-gray-800">圖表分析</h3>
                  <div className="flex gap-1.5">
                    <button onClick={() => setShowAnalysisFilter(true)} className={`px-3 py-1.5 flex items-center gap-1.5 text-xs font-black rounded-xl transition-colors shadow-sm ${analysisFilter.catConditions.length > 0 || analysisFilter.dateType !== '1m' || analysisFilter.minAmount || analysisFilter.maxAmount || analysisFilter.types.length < 2 ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200 text-gray-600'}`}>
                      <SvgIcon name="filter" size={14} /> 篩選條件
                    </button>
                    {(analysisFilter.catConditions.length > 0 || analysisFilter.dateType !== '1m' || analysisFilter.types.length < 2 || analysisFilter.minAmount || analysisFilter.maxAmount) && (
                      <button onClick={() => { setAnalysisFilter({dateType: '1m', customStart: '', customEnd: '', types: ['expense', 'income'], catConditions: [], minAmount: '', maxAmount: ''}); }} className="px-2.5 py-1.5 bg-red-50 text-red-600 rounded-xl font-black text-[10px] whitespace-nowrap shadow-sm active:scale-95 transition-all">
                        回全部
                      </button>
                    )}
                  </div>
                </div>
                
                <div className="flex bg-gray-100 p-1.5 rounded-2xl text-sm text-gray-500">
                  <button onClick={() => {setAnalysisType("expense"); setSelectedAnalysisLevel1(null); setSelectedAnalysisLevel2(null);}} className={`flex-1 py-2 rounded-xl font-black transition-all ${analysisType === "expense" ? "bg-white text-red-500 shadow-sm" : ""}`}>支出分析</button>
                  <button onClick={() => {setAnalysisType("income"); setSelectedAnalysisLevel1(null); setSelectedAnalysisLevel2(null);}} className={`flex-1 py-2 rounded-xl font-black transition-all ${analysisType === "income" ? "bg-white text-green-500 shadow-sm" : ""}`}>收入分析</button>
                  <button onClick={() => {setAnalysisType("beneficiary"); setSelectedAnalysisLevel1(null); setSelectedAnalysisLevel2(null);}} className={`flex-1 py-2 rounded-xl font-black transition-all ${analysisType === "beneficiary" ? "bg-white text-blue-600 shadow-sm" : ""}`}>對象分析</button>
                </div>

                {(() => {
                  let analysisTxs = filteredAnalysisTxs;

                  if (analysisTxs.length === 0) return <div className="text-center text-gray-400 py-10 text-sm font-bold bg-white rounded-[2rem] border border-gray-100 shadow-sm">該區間尚無紀錄，請調整過濾條件</div>;
                  
                  // 三組不同情境的獨立色系
                  const EXPENSE_COLORS = ["#ef4444", "#f97316", "#f59e0b", "#eab308", "#84cc16", "#14b8a6", "#ec4899", "#f43f5e", "#be123c"];
                  const INCOME_COLORS = ["#10b981", "#059669", "#047857", "#14b8a6", "#0d9488", "#0f766e", "#3b82f6", "#2563eb", "#1d4ed8"];
                  const BEN_COLORS = ["#6366f1", "#8b5cf6", "#a855f7", "#d946ef", "#0ea5e9", "#0284c7", "#4338ca", "#6d28d9", "#3b82f6"];
                  
                  const colors = analysisType === "expense" ? EXPENSE_COLORS : analysisType === "income" ? INCOME_COLORS : BEN_COLORS;

                  let level1Totals = {}; let grandTotal = 0;

                  analysisTxs.forEach(t => {
                    if (t.isDeleted) return; 
                    const amt = Number(t.amount) || 0; grandTotal += amt;
                    if (analysisType === "beneficiary") {
                       // 直接使用合併後的名稱作為獨立類別，不再平分拆解
                       const b = formatBen(t.beneficiary, t.member) || t.member;
                       level1Totals[b] = (level1Totals[b] || 0) + amt;
                    } else {
                       const pCat = getParentCat(t.category);
                       level1Totals[pCat] = (level1Totals[pCat] || 0) + amt;
                    }
                  });
                  const sortedLevel1 = Object.entries(level1Totals).sort((a,b) => b[1] - a[1]);
                  let conicStr = ""; let currentPct = 0;
                  sortedLevel1.forEach(([cat, amt], idx) => {
                    const pct = (amt / grandTotal) * 100; const color = colors[idx % colors.length];
                    conicStr += `${color} ${currentPct}% ${currentPct + pct}%, `; currentPct += pct;
                  });
                  conicStr = conicStr.slice(0, -2);

                  let level2Totals = {}; let level1SelectedTotal = 0;
                  if (selectedAnalysisLevel1) {
                    if (analysisType === "beneficiary") {
                      analysisTxs.forEach(t => {
                        if (t.isDeleted) return;
                        const bName = formatBen(t.beneficiary, t.member) || t.member;
                        if (bName === selectedAnalysisLevel1) {
                          const amt = Number(t.amount) || 0;
                          level1SelectedTotal += amt;
                          const pCat = getParentCat(t.category);
                          level2Totals[pCat] = (level2Totals[pCat] || 0) + amt;
                        }
                      });
                    } else {
                      analysisTxs.forEach(t => {
                        if (t.isDeleted) return;
                        if (getParentCat(t.category) === selectedAnalysisLevel1) {
                          const cCat = getChildCat(t.category);
                          const amt = Number(t.amount) || 0;
                          level1SelectedTotal += amt;
                          level2Totals[cCat] = (level2Totals[cCat] || 0) + amt;
                        }
                      });
                    }
                  }
                  const sortedLevel2 = Object.entries(level2Totals).sort((a,b) => b[1] - a[1]);

                  let level3Totals = {}; let level2SelectedTotal = 0;
                  if (analysisType === "beneficiary" && selectedAnalysisLevel1 && selectedAnalysisLevel2) {
                    analysisTxs.forEach(t => {
                      if (t.isDeleted) return;
                      const bName = formatBen(t.beneficiary, t.member) || t.member;
                      if (bName === selectedAnalysisLevel1 && getParentCat(t.category) === selectedAnalysisLevel2) {
                        const amt = Number(t.amount) || 0;
                        level2SelectedTotal += amt;
                        const cCat = getChildCat(t.category);
                        level3Totals[cCat] = (level3Totals[cCat] || 0) + amt;
                      }
                    });
                  }
                  const sortedLevel3 = Object.entries(level3Totals).sort((a,b) => b[1] - a[1]);

                  return (
                    <div className="space-y-4">
                      <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 relative">
                        <div className="relative w-48 h-48 mx-auto mb-8 rounded-full shadow-lg" style={{ background: `conic-gradient(${conicStr})` }}>
                          <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex flex-col items-center justify-center shadow-inner">
                            <span className="text-[10px] text-gray-400 font-black uppercase mb-1">
                               {analysisType === "expense" ? "總支出" : analysisType === "income" ? "總收入" : "總花費"}
                            </span>
                            <span className="text-xl font-black text-gray-800">${grandTotal.toLocaleString()}</span>
                          </div>
                        </div>
                        <div className="space-y-2">
                          {analysisType !== "beneficiary" && <div className="text-[9px] text-center font-black text-gray-400 uppercase tracking-widest mb-3 bg-gray-50 py-1.5 rounded-lg border border-gray-100">點擊下方分類查看細項</div>}
                          {sortedLevel1.map(([cat, amt], idx) => {
                            const isSelected = selectedAnalysisLevel1 === cat;
                            return (
                              <div key={cat} onClick={() => { setSelectedAnalysisLevel1(isSelected ? null : cat); setSelectedAnalysisLevel2(null); }} className={`flex items-center justify-between p-3 rounded-2xl cursor-pointer transition-colors border ${isSelected ? 'bg-blue-50/50 border-blue-200' : 'bg-gray-50/50 hover:bg-gray-100 border-transparent'}`}>
                                <div className="flex items-center gap-3">
                                  <div className="w-3 h-3 rounded-full shadow-sm" style={{ background: colors[idx % colors.length] }}></div>
                                  <span className={`font-bold text-sm ${isSelected ? 'text-blue-700' : 'text-gray-700'}`}>
                                    {cat}
                                  </span>
                                </div>
                                <div className="flex items-center gap-3">
                                  <span className="text-xs text-gray-400 font-bold w-10 text-right">{((amt/grandTotal)*100).toFixed(1)}%</span>
                                  <span className={`font-black w-16 text-right ${isSelected ? 'text-blue-700' : 'text-gray-800'}`}>${Math.round(amt).toLocaleString()}</span>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {selectedAnalysisLevel1 && (
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 animate-in relative overflow-hidden">
                          <div className={`absolute top-0 left-0 w-full h-1.5 ${analysisType === 'expense' ? 'bg-red-500' : analysisType === 'income' ? 'bg-green-500' : 'bg-indigo-500'}`}></div>
                          <h4 className="font-black text-gray-800 mb-5 flex items-center gap-2 text-sm pt-2">
                            「{selectedAnalysisLevel1}」{analysisType === "beneficiary" ? "母項目花費分析" : "子項目明細"}
                          </h4>
                          <div className="space-y-4">
                            {sortedLevel2.map(([cat, amt]) => {
                               const pct = (amt / level1SelectedTotal) * 100;
                               const isL2Selected = selectedAnalysisLevel2 === cat;
                               
                               const isClickable = analysisType === "beneficiary";
                               
                               return (
                                 <div key={cat} className="cursor-pointer group" onClick={() => isClickable ? setSelectedAnalysisLevel2(isL2Selected ? null : cat) : jumpToHistoryFromChart(cat, null, selectedAnalysisLevel1)}>
                                    <div className="flex justify-between text-xs font-bold mb-1.5">
                                       <span className={`${isL2Selected ? 'text-blue-600' : 'text-gray-700 group-hover:text-blue-500 transition-colors'}`}>
                                          {cat} 
                                          {isClickable ? <span className="text-[9px] text-gray-400 ml-1">▼</span> : <span className="text-[9px] text-blue-400 ml-1 opacity-0 group-hover:opacity-100 transition-opacity">點擊看明細</span>}
                                       </span>
                                       <span className={`${isL2Selected ? 'text-blue-600' : 'text-gray-500'} tabular-nums`}>${Math.round(amt).toLocaleString()} <span className="text-[9px] text-gray-400 ml-1">({pct.toFixed(1)}%)</span></span>
                                    </div>
                                    <div className="h-3 w-full bg-gray-100 rounded-full overflow-hidden shadow-inner">
                                       <div className={`h-full rounded-full transition-all duration-1000 ease-out ${isL2Selected ? 'bg-blue-600' : analysisType === 'expense' ? 'bg-red-400' : analysisType === 'income' ? 'bg-green-400' : 'bg-indigo-400'}`} style={{ width: animTrigger ? `${pct}%` : '0%' }}></div>
                                    </div>
                                 </div>
                               )
                            })}
                          </div>
                        </div>
                      )}

                      {analysisType === "beneficiary" && selectedAnalysisLevel1 && selectedAnalysisLevel2 && (
                        <div className="bg-gray-800 p-6 rounded-[2.5rem] shadow-lg animate-in relative overflow-hidden">
                          <div className="absolute top-0 left-0 w-full h-1.5 bg-fuchsia-500"></div>
                          <h4 className="font-black text-white mb-5 flex items-center gap-2 text-sm pt-2">
                            「{selectedAnalysisLevel2}」子項目明細
                          </h4>
                          <div className="space-y-4">
                            {sortedLevel3.map(([cCat, amt]) => {
                               const pct = (amt / level2SelectedTotal) * 100;
                               return (
                                 <div key={cCat} className="cursor-pointer group" onClick={() => jumpToHistoryFromChart(cCat, selectedAnalysisLevel1, selectedAnalysisLevel2)}>
                                    <div className="flex justify-between text-xs font-bold mb-1.5 text-white">
                                       <span className="group-hover:text-fuchsia-300 transition-colors">
                                         {cCat} <span className="text-[9px] text-fuchsia-400 ml-1 opacity-0 group-hover:opacity-100 transition-opacity">點擊看明細</span>
                                       </span>
                                       <span className="tabular-nums opacity-80 group-hover:opacity-100 transition-opacity">${Math.round(amt).toLocaleString()} <span className="text-[9px] ml-1">({pct.toFixed(1)}%)</span></span>
                                    </div>
                                    <div className="h-3 w-full bg-gray-700 rounded-full overflow-hidden shadow-inner">
                                       <div className="h-full bg-fuchsia-500 rounded-full transition-all duration-1000 ease-out" style={{ width: animTrigger ? `${pct}%` : '0%' }}></div>
                                    </div>
                                 </div>
                               )
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            )}

            {activeTab === "add" && <AddTransactionForm loginUser={currentUser.name} onSubmit={handleAdd} />}

            {activeTab === "settings" && (
              <div className="space-y-4 animate-in text-left pb-20 text-gray-800">
                <div className="bg-white p-6 rounded-[2rem] border shadow-sm border-gray-100">
                  <h3 className="font-black text-xs mb-4 uppercase flex items-center gap-2 text-gray-800 tracking-widest px-1">
                    <SvgIcon name="edit" size={16} className="text-blue-500" /> 介面自訂
                  </h3>
                  <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100 focus-within:border-blue-200 transition-colors">
                    <label className="text-[9px] font-black text-gray-400 uppercase block mb-2 leading-none tracking-widest">首頁副標題問候語 (支援 {"{name}"} 變數)</label>
                    <div className="flex gap-2">
                      <input type="text" className="flex-1 bg-transparent font-bold border-none outline-none text-gray-800 placeholder:text-gray-300 text-sm"
                        placeholder="例如：{name}，你好！" value={customSubtitle} onChange={(e) => setCustomSubtitle(e.target.value)} />
                      <button onClick={handleSaveGreeting} disabled={isLoading} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-sm active:scale-95 disabled:opacity-50">儲存</button>
                    </div>
                  </div>
                </div>

                <div className="bg-white p-6 rounded-[2rem] border shadow-sm border-gray-100">
                  <h3 className="font-black text-xs mb-5 uppercase flex items-center gap-2 text-gray-800 tracking-widest px-1">
                    <SvgIcon name="info" size={16} className="text-blue-500" /> 安全與帳戶管理
                  </h3>
                  <div className="space-y-3">
                    <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                      <div>
                        <p className="text-gray-400 text-[10px] font-black uppercase mb-1 leading-none">使用身份</p>
                        <p className="font-black text-gray-800 text-base leading-none mt-1">{currentUser.name}</p>
                      </div>
                      <button onClick={() => { setOldPin(""); setNewPin(""); setNewPin2(""); setShowChangePinModal(true); }} className="bg-gray-800 text-white px-4 py-2 rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all">更換密碼</button>
                    </div>
                    <div className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                      <div>
                        <p className="text-gray-400 text-[10px] font-black uppercase mb-1 leading-none">生物辨識 / 裝置解鎖</p>
                        <p className="font-black text-gray-800 text-sm leading-none mt-1">{bioBound ? "設備已綁定" : "設備未綁定"}</p>
                      </div>
                      <button onClick={() => bioBound ? (setUnbindPin(""), setShowUnbindModal(true)) : bindDeviceBio()} className={`px-4 py-2 rounded-xl font-black text-xs active:scale-95 transition-all ${bioBound ? "bg-red-50 text-red-600 border border-red-100" : "bg-green-600 text-white shadow-lg"}`}>{bioBound ? "解除綁定" : "綁定設備"}</button>
                    </div>
                  </div>
                  <button onClick={() => { setCurrentUser(null); setSelectingUser(null); setPinInput(""); setActiveTab("dashboard"); }} className="w-full mt-6 py-4 bg-red-50 text-red-600 rounded-2xl font-black active:scale-95 transition-all flex items-center justify-center gap-2 border border-red-100">
                    <SvgIcon name="logout" size={20} /> 登出 / 切換使用者
                  </button>
                </div>

                <div className="bg-white p-6 rounded-[2rem] border shadow-sm border-gray-100">
                  <div className="flex justify-between items-center cursor-pointer" onClick={() => setIsLogOpen(!isLogOpen)}>
                    <h3 className="font-black text-xs uppercase flex items-center gap-2 text-gray-800 tracking-widest px-1">
                      <SvgIcon name="chart" size={16} className="text-blue-500" /> 系統資訊 & 更新歷程
                    </h3>
                    <span className={`text-gray-400 text-[10px] transition-transform duration-300 ${isLogOpen ? 'rotate-180' : ''}`}>▼</span>
                  </div>
                  
                  {isLogOpen && (
                    <div className="mt-5 space-y-5 font-bold text-gray-600 animate-in border-t border-gray-100 pt-4">
                      <div className="border-l-2 border-blue-500 pl-3">
                        <p className="text-gray-800 text-xs mb-1 flex items-center gap-2">APP 前端 <span className="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded text-[9px] font-mono">{APP_VERSION}</span></p>
                        <ul className="list-disc pl-4 text-[10px] space-y-1 text-gray-500">
                          <li>[V21] 完美解決同步後白屏問題 (資料格式安全轉換與拷貝保護)</li>
                          <li>[V20] 修正 Race Condition，無縫背景同步消除空窗期，待同步項目永駐所有頁面</li>
                          <li>[V19] 首頁與歷史篩選完全脫鉤，新增子項目刪除墓碑標記，並支援完整編輯歷史溯源</li>
                          <li>[V18] 樂觀更新(秒新增)、背景自動同步與未同步視覺標示(黃色標籤)</li>
                        </ul>
                      </div>
                      <div className="border-l-2 border-green-500 pl-3">
                        <p className="text-gray-800 text-xs mb-1 flex items-center gap-2">GAS 後端 <span className="bg-green-100 text-green-600 px-1.5 py-0.5 rounded text-[9px] font-mono">{GAS_TARGET_VERSION}</span></p>
                        <ul className="list-disc pl-4 text-[10px] space-y-1 text-gray-500">
                          <li>[V7] 資料表擴充，新增獨立的歷史編輯表 (EditHistory) 支援完整快照備份</li>
                          <li>[V6] 導入 CacheService 與 TextFinder，實現毫秒級讀取與光速搜尋</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
          </main>

          <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/90 backdrop-blur-md rounded-[2.5rem] p-2 flex justify-between items-center z-40 shadow-2xl border border-white/20 safe-bottom">
            <button onClick={() => setActiveTab("dashboard")} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === "dashboard" ? "text-blue-600 bg-blue-50 shadow-inner" : "text-gray-400"}`}><SvgIcon name="home" /></button>
            <button onClick={() => setActiveTab("history")} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === "history" ? "text-blue-600 bg-blue-50 shadow-inner" : "text-gray-400"}`}><SvgIcon name="history" /></button>
            <div className="px-1">
              <button onClick={() => setActiveTab(prev => prev === "add" ? "dashboard" : "add")} className={`w-14 h-14 flex items-center justify-center rounded-[1.5rem] shadow-xl active:scale-90 transition-all ${activeTab === "add" ? "bg-blue-700 text-white rotate-45 shadow-blue-200" : "bg-gray-900 text-white"}`}><SvgIcon name="plus" size={28} /></button>
            </div>
            <button onClick={() => setActiveTab("analysis")} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === "analysis" ? "text-blue-600 bg-blue-50 shadow-inner" : "text-gray-400"}`}><SvgIcon name="pieChart" /></button>
            <button onClick={() => setActiveTab("settings")} className={`flex-1 flex justify-center py-4 rounded-3xl transition-all ${activeTab === "settings" ? "text-blue-600 bg-blue-50 shadow-inner" : "text-gray-400"}`}><SvgIcon name="settings" /></button>
          </nav>

          {statusMsg.text && (
            <div className="fixed bottom-28 left-0 right-0 flex justify-center z-[1000] pointer-events-none px-4 text-center">
              <div className={`px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-in pointer-events-auto ${statusMsg.type === "success" ? "bg-green-600 text-white" : statusMsg.type === "error" ? "bg-red-600 text-white" : "bg-blue-600 text-white"}`}>
                <span className="text-sm font-bold tracking-tight text-center">{statusMsg.text}</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
